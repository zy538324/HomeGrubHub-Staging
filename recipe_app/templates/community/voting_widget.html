<!-- Positive Recipe Voting Widget -->
<div class="vote-container mt-3">
    <div class="card">
        <div class="card-body">
            <h6 class="card-title">
                <i class="fas fa-heart text-danger"></i> Community Feedback
                <small class="text-muted">(<span class="total-votes">0</span> responses)</small>
            </h6>
            
            {% if current_user.is_authenticated %}
                <div class="row text-center">
                    <div class="col-md-4">
                        <button class="btn btn-outline-success vote-btn w-100" 
                                data-recipe-id="{{ recipe.id }}" 
                                data-vote-type="love_it"
                                title="I love this recipe!">
                            <i class="fas fa-thumbs-up"></i><br>
                            <small>Love it!</small><br>
                            <span class="love-it-count badge bg-success">0</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary vote-btn w-100" 
                                data-recipe-id="{{ recipe.id }}" 
                                data-vote-type="want_to_try"
                                title="I want to try this recipe">
                            <i class="fas fa-bookmark"></i><br>
                            <small>Want to try</small><br>
                            <span class="want-to-try-count badge bg-primary">0</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-warning vote-btn w-100" 
                                data-recipe-id="{{ recipe.id }}" 
                                data-vote-type="not_favourite"
                                title="Not my favorite, but that's okay!">
                            <i class="fas fa-meh"></i><br>
                            <small>Not my favorite</small><br>
                            <span class="not-favourite-count badge bg-warning">0</span>
                        </button>
                    </div>
                </div>
                
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Share your honest feedback! We believe in positive community interactions.
                    </small>
                </div>
            {% else %}
                <div class="text-center">
                    <div class="row">
                        <div class="col-4 text-center">
                            <i class="fas fa-thumbs-up text-success fa-2x"></i><br>
                            <small>Love it!</small><br>
                            <span class="love-it-count badge bg-success">0</span>
                        </div>
                        <div class="col-4 text-center">
                            <i class="fas fa-bookmark text-primary fa-2x"></i><br>
                            <small>Want to try</small><br>
                            <span class="want-to-try-count badge bg-primary">0</span>
                        </div>
                        <div class="col-4 text-center">
                            <i class="fas fa-meh text-warning fa-2x"></i><br>
                            <small>Not my favorite</small><br>
                            <span class="not-favourite-count badge bg-warning">0</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('main.login') }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Log in to vote
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.vote-btn {
    border-radius: 10px;
    padding: 15px 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    border-width: 2px;
    min-height: 120px; /* Ensure all buttons are same height */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.vote-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.vote-btn.active {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.vote-btn i {
    font-size: 1.2em;
    margin-bottom: 5px;
}

.vote-container .card {
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.vote-container .card-body {
    padding: 1.25rem;
}

@media (max-width: 768px) {
    .vote-btn {
        padding: 10px 5px;
        font-size: 0.85em;
        min-height: 100px;
    }
    
    .vote-btn i {
        font-size: 1em;
    }
}
</style>

<script>
// Note: This embedded script takes priority over the external recipe-voting.js file
document.addEventListener('DOMContentLoaded', function() {
    // Mark container as handled by embedded script
    const container = document.querySelector('.vote-container');
    if (container) {
        container.dataset.handledByExternal = 'true';
    }
    
    // Check if the external RecipeVoting class is available but give preference to this embedded script
    console.log('Embedded voting script initializing for voting widget');
    
    const recipeId = document.querySelector('[data-recipe-id]')?.dataset.recipeId;
    
    if (recipeId) {
        // Load current vote counts and user's vote
        loadVoteCounts(recipeId);
        
        // Add event listeners to vote buttons
        document.querySelectorAll('.vote-btn').forEach(button => {
            button.addEventListener('click', function() {
                const voteType = this.dataset.voteType;
                submitVote(recipeId, voteType, this);
            });
        });
    }
});

function loadVoteCounts(recipeId) {
    fetch(`/community/recipe/${recipeId}/votes`)
        .then(response => response.json())
        .then(data => {
            if (data.vote_counts) {
                updateVoteDisplay(data.vote_counts, data.user_vote);
            }
        })
        .catch(error => console.error('Error loading votes:', error));
}

function submitVote(recipeId, voteType, button) {
    // Disable button temporarily
    button.disabled = true;
    const originalContent = button.innerHTML;
    
    fetch('/community/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            recipe_id: recipeId,
            vote_type: voteType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateVoteDisplay(data.vote_counts, data.user_vote);
            showVoteSuccess(voteType);
        } else {
            throw new Error(data.error || 'Failed to submit vote');
        }
    })
    .catch(error => {
        console.error('Error submitting vote:', error);
        alert('Failed to submit vote. Please try again.');
    })
    .finally(() => {
        button.disabled = false;
    });
}

function updateVoteDisplay(voteCounts, userVote) {
    // Update counts with null checks
    const loveItCount = document.querySelector('.love-it-count');
    const wantToTryCount = document.querySelector('.want-to-try-count');
    const notFavouriteCount = document.querySelector('.not-favourite-count');
    const totalVotes = document.querySelector('.total-votes');
    
    if (loveItCount) loveItCount.textContent = voteCounts.love_it || 0;
    if (wantToTryCount) wantToTryCount.textContent = voteCounts.want_to_try || 0;
    if (notFavouriteCount) notFavouriteCount.textContent = voteCounts.not_favourite || 0;
    if (totalVotes) totalVotes.textContent = voteCounts.total || 0;
    
    // Update button states
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.classList.remove('btn-success', 'btn-primary', 'btn-warning');
        button.classList.add('btn-outline-success', 'btn-outline-primary', 'btn-outline-warning');
        
        // Highlight user's current vote
        if (userVote && button.dataset.voteType === userVote) {
            button.classList.remove('btn-outline-success', 'btn-outline-primary', 'btn-outline-warning');
            if (userVote === 'love_it') button.classList.add('btn-success');
            else if (userVote === 'want_to_try') button.classList.add('btn-primary');
            else if (userVote === 'not_favourite') button.classList.add('btn-warning');
        }
    });
}

function showVoteSuccess(voteType) {
    const messages = {
        'love_it': 'Thanks for loving this recipe! ‚ù§Ô∏è',
        'want_to_try': 'Added to your want-to-try list! üìå',
        'not_favourite': 'Thanks for your honest feedback! üëç'
    };
    
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        ${messages[voteType]}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
