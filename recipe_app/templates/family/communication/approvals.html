{% extends "base.html" %}

{% block title %}Family Approval Requests{% endblock %}

{% block page_styles %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .approvals-container {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .approvals-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .approvals-header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .status-filters {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .filter-btn {
        padding: 8px 20px;
        border: 2px solid #e9ecef;
        background: white;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #666;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active, .filter-btn:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-color: var(--primary-color);
        color: var(--neutral-100);
        text-decoration: none;
    }
    
    .approvals-list {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 25px;
    }
    
    .approval-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        margin-bottom: 20px;
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
    }
    
    .approval-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .approval-card.status-pending {
        border-left: 5px solid var(--warning-color);
    }
    
    .approval-card.status-approved {
        border-left: 5px solid var(--success-color);
    }
    
    .approval-card.status-rejected {
        border-left: 5px solid #dc3545;
    }
    
    .approval-header {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    .child-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .child-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--neutral-100);
        font-weight: bold;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .child-details h5 {
        margin: 0 0 5px 0;
        color: #333;
        font-weight: 600;
    }
    
    .child-meta {
        font-size: 0.85rem;
        color: #666;
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .request-status {
        text-align: right;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 8px;
    }
    
    .status-badge.pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-badge.approved {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-badge.rejected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .request-time {
        font-size: 0.8rem;
        color: #666;
    }
    
    .approval-body {
        padding: 20px;
    }
    
    .request-details {
        margin-bottom: 20px;
    }
    
    .request-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .request-type-icon {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--neutral-100);
        font-size: 0.9rem;
    }
    
    .request-type-icon.meal_plan {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
    }
    
    .request-type-icon.shopping_item {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    }
    
    .request-type-icon.challenge_join {
        background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
    }
    
    .request-type-icon.screen_time {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
    }
    
    .request-description {
        color: #555;
        line-height: 1.6;
        margin-bottom: 15px;
    }
    
    .request-data {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .request-data h6 {
        color: #333;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .data-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .data-item:last-child {
        border-bottom: none;
    }
    
    .data-label {
        color: #666;
        font-weight: 500;
    }
    
    .data-value {
        color: #333;
        font-weight: 500;
    }
    
    .approval-actions {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
    }
    
    .response-section {
        flex: 1;
        min-width: 300px;
    }
    
    .response-textarea {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        resize: vertical;
        min-height: 80px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }
    
    .response-textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }
    
    .approve-btn {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        color: var(--neutral-100);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .approve-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .reject-btn {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: var(--neutral-100);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .reject-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .parent-response {
        background: #e8f5e8;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .parent-response.rejected {
        background: #f8e8e8;
        border-color: #f5c6cb;
    }
    
    .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .response-author {
        font-weight: 600;
        color: #333;
    }
    
    .response-time {
        font-size: 0.8rem;
        color: #666;
    }
    
    .response-text {
        color: #555;
        line-height: 1.6;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: var(--neutral-100);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        color: #999;
        margin-bottom: 15px;
    }
    
    .empty-state p {
        color: #bbb;
        font-size: 1rem;
    }
    
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }
    
    .pagination .page-link {
        color: var(--primary-color);
        border-color: #dee2e6;
        border-radius: 8px;
        margin: 0 2px;
    }
    
    .pagination .page-link:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: var(--neutral-100);
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="approvals-container">
    <div class="approvals-wrapper">
        <!-- Header -->
        <div class="approvals-header">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <h1 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Approval Requests
                    </h1>
                    <p class="text-muted mb-0 mt-2">Review and manage family member requests</p>
                </div>
                <a href="{{ url_for('family_communication.communication_hub') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Hub
                </a>
            </div>
            
            <!-- Summary Stats -->
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'approved')|list|length }}</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</div>
                    <div class="stat-label">Rejected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ requests|length }}</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
            
            <!-- Status Filters -->
            <div class="status-filters">
                <a href="{{ url_for('family_communication.approval_requests', status='pending') }}" 
                   class="filter-btn {% if status_filter == 'pending' %}active{% endif %}">
                    <i class="fas fa-clock"></i> Pending
                </a>
                <a href="{{ url_for('family_communication.approval_requests', status='approved') }}" 
                   class="filter-btn {% if status_filter == 'approved' %}active{% endif %}">
                    <i class="fas fa-check-circle"></i> Approved
                </a>
                <a href="{{ url_for('family_communication.approval_requests', status='rejected') }}" 
                   class="filter-btn {% if status_filter == 'rejected' %}active{% endif %}">
                    <i class="fas fa-times-circle"></i> Rejected
                </a>
                <a href="{{ url_for('family_communication.approval_requests', status='all') }}" 
                   class="filter-btn {% if status_filter == 'all' %}active{% endif %}">
                    <i class="fas fa-list"></i> All
                </a>
            </div>
        </div>
        
        <!-- Approvals List -->
        <div class="approvals-list">
            {% if requests %}
                {% for request in requests %}
                <div class="approval-card status-{{ request.status }}" data-request-id="{{ request.id }}">
                    <div class="approval-header">
                        <div class="child-info">
                            <div class="child-avatar">
                                {{ request.child.display_name[0]|upper }}
                            </div>
                            <div class="child-details">
                                <h5>{{ request.child.display_name }}</h5>
                                <div class="child-meta">
                                    <span><i class="fas fa-user-tag"></i> {{ request.child.role|title }}</span>
                                    <span><i class="fas fa-birthday-cake"></i> Age {{ request.child.age or 'Unknown' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="request-status">
                            <div class="status-badge {{ request.status }}">{{ request.status|title }}</div>
                            <div class="request-time">
                                {{ request.created_at.strftime('%B %d, %Y') }}<br>
                                <small>{{ request.created_at.strftime('%I:%M %p') }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="approval-body">
                        <div class="request-details">
                            <div class="request-title">
                                <div class="request-type-icon {{ request.request_type }}">
                                    {% if request.request_type == 'meal_plan' %}
                                    <i class="fas fa-utensils"></i>
                                    {% elif request.request_type == 'shopping_item' %}
                                    <i class="fas fa-shopping-cart"></i>
                                    {% elif request.request_type == 'challenge_join' %}
                                    <i class="fas fa-trophy"></i>
                                    {% elif request.request_type == 'screen_time' %}
                                    <i class="fas fa-mobile-alt"></i>
                                    {% else %}
                                    <i class="fas fa-question"></i>
                                    {% endif %}
                                </div>
                                {{ request.request_title }}
                            </div>
                            
                            {% if request.request_description %}
                            <div class="request-description">
                                {{ request.request_description|nl2br }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if request.request_data %}
                        <div class="request-data">
                            <h6><i class="fas fa-info-circle"></i> Request Details</h6>
                            {% for key, value in request.request_data.items() %}
                            <div class="data-item">
                                <span class="data-label">{{ key|replace('_', ' ')|title }}:</span>
                                <span class="data-value">{{ value }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if request.expires_at %}
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i>
                                {% if request.is_expired() %}
                                <span class="text-danger">Expired on {{ request.expires_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                {% else %}
                                Expires on {{ request.expires_at.strftime('%B %d, %Y at %I:%M %p') }}
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                        
                        {% if request.status == 'pending' and not request.is_expired() %}
                        <!-- Approval Actions for Pending Requests -->
                        <div class="approval-actions">
                            <div class="response-section">
                                <label class="form-label">Response (Optional)</label>
                                <textarea class="response-textarea" id="response-{{ request.id }}" 
                                         placeholder="Add a note for {{ request.child.display_name }}..."></textarea>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="approve-btn" onclick="approveRequest({{ request.id }})">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="reject-btn" onclick="rejectRequest({{ request.id }})">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                        {% elif request.status in ['approved', 'rejected'] %}
                        <!-- Parent Response for Completed Requests -->
                        <div class="parent-response {% if request.status == 'rejected' %}rejected{% endif %}">
                            <div class="response-header">
                                <span class="response-author">
                                    <i class="fas fa-user-shield"></i>
                                    {% if request.parent %}
                                        {{ request.parent.display_name }}
                                    {% else %}
                                        System
                                    {% endif %}
                                </span>
                                <span class="response-time">{{ request.approved_at.strftime('%B %d, %Y at %I:%M %p') if request.approved_at }}</span>
                            </div>
                            {% if request.parent_response %}
                            <div class="response-text">{{ request.parent_response|nl2br }}</div>
                            {% else %}
                            <div class="response-text text-muted">No additional response provided.</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <div class="pagination-wrapper">
                    {{ render_pagination(pagination, 'family_communication.approval_requests', 
                                        status=status_filter) }}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>No Approval Requests</h3>
                    <p>{% if status_filter and status_filter != 'all' %}No {{ status_filter }} requests found.{% else %}No approval requests from family members yet.{% endif %}</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function approveRequest(requestId) {
    const responseText = document.getElementById(`response-${requestId}`).value;
    const button = event.target;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    $.ajax({
        url: `/family/communication/approve_request/${requestId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            response: responseText
        }),
        success: function(data) {
            if (data.success) {
                showNotification('Request approved successfully!', 'success');
                
                // Update the UI
                const card = $(button).closest('.approval-card');
                card.removeClass('status-pending').addClass('status-approved');
                card.find('.status-badge').removeClass('pending').addClass('approved').text('Approved');
                
                // Replace actions with response
                const actionsDiv = card.find('.approval-actions');
                const responseHtml = `
                    <div class="parent-response">
                        <div class="response-header">
                            <span class="response-author">
                                <i class="fas fa-user-shield"></i>
                                {{ current_member.display_name }}
                            </span>
                            <span class="response-time">Just now</span>
                        </div>
                        <div class="response-text">${responseText || 'No additional response provided.'}</div>
                    </div>
                `;
                actionsDiv.replaceWith(responseHtml);
                
                // Update stats
                updateStats();
            } else {
                showNotification('Failed to approve request: ' + (data.error || 'Unknown error'), 'error');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Network error';
            showNotification('Failed to approve request: ' + error, 'error');
        },
        complete: function() {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Approve';
        }
    });
}

function rejectRequest(requestId) {
    const responseText = document.getElementById(`response-${requestId}`).value;
    const button = event.target;
    
    if (!responseText.trim()) {
        if (!confirm('Are you sure you want to reject this request without providing a reason?')) {
            return;
        }
    }
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
    
    $.ajax({
        url: `/family/communication/reject_request/${requestId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            response: responseText
        }),
        success: function(data) {
            if (data.success) {
                showNotification('Request rejected.', 'info');
                
                // Update the UI
                const card = $(button).closest('.approval-card');
                card.removeClass('status-pending').addClass('status-rejected');
                card.find('.status-badge').removeClass('pending').addClass('rejected').text('Rejected');
                
                // Replace actions with response
                const actionsDiv = card.find('.approval-actions');
                const responseHtml = `
                    <div class="parent-response rejected">
                        <div class="response-header">
                            <span class="response-author">
                                <i class="fas fa-user-shield"></i>
                                {{ current_member.display_name }}
                            </span>
                            <span class="response-time">Just now</span>
                        </div>
                        <div class="response-text">${responseText || 'No additional response provided.'}</div>
                    </div>
                `;
                actionsDiv.replaceWith(responseHtml);
                
                // Update stats
                updateStats();
            } else {
                showNotification('Failed to reject request: ' + (data.error || 'Unknown error'), 'error');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Network error';
            showNotification('Failed to reject request: ' + error, 'error');
        },
        complete: function() {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-times"></i> Reject';
        }
    });
}

function updateStats() {
    // Update the statistics cards
    const pendingCount = $('.approval-card.status-pending').length;
    const approvedCount = $('.approval-card.status-approved').length;
    const rejectedCount = $('.approval-card.status-rejected').length;
    
    $('.stat-card').eq(0).find('.stat-number').text(pendingCount);
    $('.stat-card').eq(1).find('.stat-number').text(approvedCount);
    $('.stat-card').eq(2).find('.stat-number').text(rejectedCount);
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto-dismiss after 4 seconds
    setTimeout(function() {
        notification.alert('close');
    }, 4000);
}

$(document).ready(function() {
    // Auto-expand textareas
    $('.response-textarea').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        // Press 'Escape' to go back to hub
        if (e.key === 'Escape') {
            window.location.href = '{{ url_for("family_communication.communication_hub") }}';
        }
    });
    
    // Add visual feedback for approval cards
    $('.approval-card').hover(
        function() {
            if ($(this).hasClass('status-pending')) {
                $(this).addClass('shadow-lg');
            }
        },
        function() {
            $(this).removeClass('shadow-lg');
        }
    );
    
    // Highlight urgent/expiring requests
    $('.approval-card').each(function() {
        const expiresText = $(this).find('.text-muted').text();
        if (expiresText.includes('Expires') && !expiresText.includes('Expired')) {
            // Check if expires within 24 hours (simple check)
            const expiryDate = new Date($(this).find('.text-muted').text().match(/\b\w+ \d{1,2}, \d{4}/)[0]);
            const now = new Date();
            const hoursUntilExpiry = (expiryDate - now) / (1000 * 60 * 60);
            
            if (hoursUntilExpiry <= 24 && hoursUntilExpiry > 0) {
                $(this).addClass('border-warning');
                $(this).find('.request-title').append(' <span class="badge bg-warning text-dark ms-2">Expires Soon</span>');
            }
        }
    });
});
</script>
{% endblock %}
