{% extends "base.html" %}
{% block title %}Family Meal Planning - HomeGrubHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Family Navigation Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="navbar navbar-expand-lg navbar-light bg-gradient-primary text-white rounded">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1 text-white">
                        <i class="fas fa-calendar-alt me-2"></i>{{ family_account.family_name }} Meal Planning
                    </span>
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link text-white" href="{{ url_for('family.family_dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                        <a class="nav-link text-white active" href="{{ url_for('family.family_meal_planning') }}">
                            <i class="fas fa-calendar-alt me-1"></i>Meal Planning
                        </a>
                        <a class="nav-link text-white" href="{{ url_for('family.family_shopping') }}">
                            <i class="fas fa-shopping-cart me-1"></i>Shopping
                        </a>
                        <a class="nav-link text-white" href="{{ url_for('family.family_challenges') }}">
                            <i class="fas fa-trophy me-1"></i>Challenges
                        </a>
                        <a class="nav-link text-white" href="{{ url_for('family.manage_members') }}">
                            <i class="fas fa-users me-1"></i>Members
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Week Navigation and Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-outline-primary me-2" onclick="changeWeek(-1)">
                                    <i class="fas fa-chevron-left"></i> Previous Week
                                </button>
                                <h5 class="mb-0 mx-3">
                                    Week of {{ start_date.strftime('%B %d, %Y') }}
                                </h5>
                                <button class="btn btn-outline-primary ms-2" onclick="changeWeek(1)">
                                    Next Week <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-success me-2" onclick="openAIMealPlanModal()">
                                <i class="fas fa-robot me-1"></i>AI Generate Week
                            </button>
                            <button class="btn btn-primary me-2" onclick="openBulkAssignModal()">
                                <i class="fas fa-user-plus me-1"></i>Assign Cook
                            </button>
                            <button class="btn btn-info" onclick="exportWeekPlan()">
                                <i class="fas fa-download me-1"></i>Export Plan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Family Meal Planning Calendar -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-utensils me-2"></i>Family Meal Calendar
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 meal-calendar">
                            <thead class="bg-light">
                                <tr>
                                    <th width="12%">Meal Type</th>
                                    {% for day in range(7) %}
                                        {% set current_date = start_date + timedelta(days=day) %}
                                        <th width="12.5%" class="text-center">
                                            <div class="fw-bold">{{ current_date.strftime('%A') }}</div>
                                            <div class="small text-muted">{{ current_date.strftime('%m/%d') }}</div>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for meal_type in ['breakfast', 'lunch', 'dinner', 'snack'] %}
                                <tr>
                                    <td class="meal-type-header">
                                        <div class="text-center py-3">
                                            {% if meal_type == 'breakfast' %}
                                                <i class="fas fa-coffee fa-2x text-warning mb-2"></i>
                                            {% elif meal_type == 'lunch' %}
                                                <i class="fas fa-hamburger fa-2x text-success mb-2"></i>
                                            {% elif meal_type == 'dinner' %}
                                                <i class="fas fa-utensils fa-2x text-primary mb-2"></i>
                                            {% else %}
                                                <i class="fas fa-cookie fa-2x text-info mb-2"></i>
                                            {% endif %}
                                            <div class="fw-bold">{{ meal_type.title() }}</div>
                                        </div>
                                    </td>
                                    {% for day in range(7) %}
                                        {% set current_date = start_date + timedelta(days=day) %}
                                        {% set date_key = current_date.strftime('%Y-%m-%d') %}
                                        {% set meal_plan = get_meal_plan(meal_plans, current_date, meal_type) %}
                                        <td class="meal-slot p-2" data-date="{{ date_key }}" data-meal="{{ meal_type }}">
                                            {% if meal_plan %}
                                                <div class="meal-card" onclick="editMealPlan({{ meal_plan.id }})">
                                                    <div class="meal-name">{{ meal_plan.recipe_name or meal_plan.recipe.name }}</div>
                                                    {% if meal_plan.cook %}
                                                        <div class="cook-assignment">
                                                            <i class="fas fa-user-chef me-1"></i>{{ meal_plan.cook.display_name }}
                                                        </div>
                                                    {% endif %}
                                                    <div class="meal-details">
                                                        {% if meal_plan.servings_planned %}
                                                            <span class="badge bg-primary">{{ meal_plan.servings_planned }} servings</span>
                                                        {% endif %}
                                                        {% if meal_plan.prep_time %}
                                                            <span class="badge bg-secondary">{{ meal_plan.prep_time }}min</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="empty-meal-slot" onclick="addMealPlan('{{ date_key }}', '{{ meal_type }}')">
                                                    <i class="fas fa-plus-circle fa-2x text-muted"></i>
                                                    <div class="small text-muted">Add Meal</div>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Summary -->
    <div class="row mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Weekly Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="h3 text-primary">{{ total_planned_meals or 0 }}</div>
                            <div class="small text-muted">Meals Planned</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-success">{{ unique_cooks or 0 }}</div>
                            <div class="small text-muted">Family Cooks</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-warning">{{ estimated_prep_time or 0 }}</div>
                            <div class="small text-muted">Total Prep (min)</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h3 text-info">{{ estimated_cost or 0 }}</div>
                            <div class="small text-muted">Est. Cost ($)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Cooking Assignments
                    </h5>
                </div>
                <div class="card-body">
                    {% if cooking_assignments %}
                        {% for assignment in cooking_assignments %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ assignment.cook_name }}</span>
                            <span class="badge bg-primary">{{ assignment.meal_count }} meals</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-user-chef fa-2x mb-2"></i>
                            <p class="small">No cooking assignments yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Meal Modal -->
<div class="modal fade" id="mealPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-utensils me-2"></i>Plan Family Meal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="meal-plan-form">
                    <input type="hidden" id="meal-plan-id">
                    <input type="hidden" id="meal-date">
                    <input type="hidden" id="meal-type">
                    
                    <!-- Meal Selection Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="recipe-tab" data-bs-toggle="tab" data-bs-target="#recipe-content" type="button">
                                <i class="fas fa-book me-1"></i>Family Recipes
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-content" type="button">
                                <i class="fas fa-edit me-1"></i>Custom Meal
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Family Recipes -->
                        <div class="tab-pane fade show active" id="recipe-content">
                            <div class="row">
                                {% for recipe in saved_recipes %}
                                <div class="col-md-4 mb-3">
                                    <div class="card recipe-card h-100" onclick="selectRecipe({{ recipe.id }}, '{{ recipe.name }}')">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ recipe.name }}</h6>
                                            <p class="card-text small text-muted">
                                                {{ recipe.servings }} servings
                                                {% if recipe.prep_time %}• {{ recipe.prep_time }}min{% endif %}
                                            </p>
                                            <div class="recipe-rating">
                                                {% for i in range(5) %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Custom Meal -->
                        <div class="tab-pane fade" id="custom-content">
                            <div class="mb-3">
                                <label class="form-label">Meal Name</label>
                                <input type="text" class="form-control" id="custom-meal-name" placeholder="e.g., Spaghetti with Marinara">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description (Optional)</label>
                                <textarea class="form-control" id="custom-meal-description" rows="3" placeholder="Brief description or notes about the meal..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Meal Details -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <label class="form-label">Assigned Cook</label>
                            <select class="form-select" id="assigned-cook">
                                <option value="">No Assignment</option>
                                {% for member in family_members %}
                                <option value="{{ member.id }}">{{ member.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Servings Planned</label>
                            <input type="number" class="form-control" id="servings-planned" min="1" max="12" value="{{ family_members|length }}">
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Prep Time (minutes)</label>
                            <input type="number" class="form-control" id="prep-time" min="0" max="300">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Difficulty Level</label>
                            <select class="form-select" id="difficulty-level">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>

                    <!-- Member Preferences -->
                    <div class="mt-4">
                        <label class="form-label">Family Member Preferences</label>
                        <div class="row">
                            {% for member in family_members %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="{{ member.id }}" id="member-{{ member.id }}" checked>
                                    <label class="form-check-label" for="member-{{ member.id }}">
                                        {{ member.display_name }}
                                        <small class="text-muted">({{ member.age_group }})</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Cooking Notes -->
                    <div class="mt-3">
                        <label class="form-label">Cooking Notes (Optional)</label>
                        <textarea class="form-control" id="cooking-notes" rows="2" placeholder="Special instructions, dietary modifications, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="delete-meal-btn" onclick="deleteMealPlan()" style="display: none;">
                    <i class="fas fa-trash me-1"></i>Delete Meal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveMealPlan()">
                    <i class="fas fa-save me-1"></i>Save Meal Plan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
}

.meal-calendar {
    min-height: 600px;
}

.meal-calendar td {
    height: 150px;
    vertical-align: top;
    position: relative;
}

.meal-type-header {
    background: rgba(0,123,255,0.1);
    vertical-align: middle !important;
}

.meal-slot {
    cursor: pointer;
    transition: background-color 0.2s;
}

.meal-slot:hover {
    background-color: rgba(0,123,255,0.05);
}

.meal-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 12px;
    height: 100%;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid var(--primary-color);
}

.meal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.meal-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
    color: #333;
}

.cook-assignment {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
}

.meal-details .badge {
    font-size: 10px;
    margin-right: 4px;
}

.empty-meal-slot {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 120px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
}

.empty-meal-slot:hover {
    background-color: rgba(0,123,255,0.1);
}

.recipe-card {
    cursor: pointer;
    transition: all 0.2s;
}

.recipe-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.recipe-card.selected {
    border: 2px solid var(--primary-color);
    background-color: rgba(0,123,255,0.1);
}

.nav-tabs .nav-link {
    border-radius: 8px 8px 0 0;
}
</style>

<!-- JavaScript -->
<script>
let currentWeekOffset = {{ week_offset or 0 }};
let selectedRecipeId = null;
let mealPlans = {{ meal_plans_json|safe or '{}' }};

function changeWeek(direction) {
    currentWeekOffset += direction;
    window.location.href = `{{ url_for('family.family_meal_planning') }}?week=${currentWeekOffset}`;
}

function addMealPlan(date, mealType) {
    // Reset form
    document.getElementById('meal-plan-form').reset();
    document.getElementById('meal-plan-id').value = '';
    document.getElementById('meal-date').value = date;
    document.getElementById('meal-type').value = mealType;
    document.getElementById('delete-meal-btn').style.display = 'none';
    
    // Set modal title
    document.querySelector('#mealPlanModal .modal-title').innerHTML = 
        `<i class="fas fa-utensils me-2"></i>Plan ${mealType.charAt(0).toUpperCase() + mealType.slice(1)} - ${new Date(date).toLocaleDateString()}`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mealPlanModal'));
    modal.show();
}

function editMealPlan(mealPlanId) {
    // Find meal plan data
    const mealPlan = findMealPlan(mealPlanId);
    if (!mealPlan) return;
    
    // Populate form with existing data
    document.getElementById('meal-plan-id').value = mealPlan.id;
    document.getElementById('meal-date').value = mealPlan.date;
    document.getElementById('meal-type').value = mealPlan.meal_type;
    
    if (mealPlan.recipe_id) {
        selectRecipe(mealPlan.recipe_id, mealPlan.recipe_name);
    } else {
        // Switch to custom tab
        document.getElementById('custom-tab').click();
        document.getElementById('custom-meal-name').value = mealPlan.recipe_name;
    }
    
    document.getElementById('assigned-cook').value = mealPlan.assigned_cook || '';
    document.getElementById('servings-planned').value = mealPlan.servings_planned || {{ family_members|length }};
    document.getElementById('prep-time').value = mealPlan.prep_time || '';
    document.getElementById('difficulty-level').value = mealPlan.difficulty_level || 'medium';
    document.getElementById('cooking-notes').value = mealPlan.cooking_notes || '';
    
    // Show delete button
    document.getElementById('delete-meal-btn').style.display = 'inline-block';
    
    // Set modal title
    document.querySelector('#mealPlanModal .modal-title').innerHTML = 
        `<i class="fas fa-edit me-2"></i>Edit ${mealPlan.meal_type.charAt(0).toUpperCase() + mealPlan.meal_type.slice(1)} - ${new Date(mealPlan.date).toLocaleDateString()}`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mealPlanModal'));
    modal.show();
}

function selectRecipe(recipeId, recipeName) {
    selectedRecipeId = recipeId;
    
    // Update UI to show selection
    document.querySelectorAll('.recipe-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    event.currentTarget.classList.add('selected');
}

async function saveMealPlan() {
    const formData = {
        id: document.getElementById('meal-plan-id').value,
        date: document.getElementById('meal-date').value,
        meal_type: document.getElementById('meal-type').value,
        recipe_id: selectedRecipeId,
        recipe_name: selectedRecipeId ? null : document.getElementById('custom-meal-name').value,
        assigned_cook: document.getElementById('assigned-cook').value,
        servings_planned: parseInt(document.getElementById('servings-planned').value),
        prep_time: parseInt(document.getElementById('prep-time').value) || null,
        difficulty_level: document.getElementById('difficulty-level').value,
        cooking_notes: document.getElementById('cooking-notes').value,
        member_preferences: getMemberPreferences()
    };
    
    if (!formData.recipe_id && !formData.recipe_name) {
        alert('Please select a recipe or enter a custom meal name');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("family.save_meal_plan") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.content
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('mealPlanModal')).hide();
            location.reload();
        } else {
            alert(result.message || 'Error saving meal plan');
        }
        
    } catch (error) {
        console.error('Error saving meal plan:', error);
        alert('Network error. Please try again.');
    }
}

function getMemberPreferences() {
    const preferences = {};
    document.querySelectorAll('input[id^="member-"]:checked').forEach(checkbox => {
        const memberId = checkbox.value;
        preferences[memberId] = true;
    });
    return preferences;
}

function findMealPlan(id) {
    // This would be populated from server data
    return mealPlans[id] || null;
}

async function deleteMealPlan() {
    if (!confirm('Are you sure you want to delete this meal plan?')) return;
    
    const mealPlanId = document.getElementById('meal-plan-id').value;
    
    try {
        const response = await fetch('{{ url_for("family.delete_meal_plan") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.content
            },
            body: JSON.stringify({ id: mealPlanId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('mealPlanModal')).hide();
            location.reload();
        } else {
            alert(result.message || 'Error deleting meal plan');
        }
        
    } catch (error) {
        console.error('Error deleting meal plan:', error);
        alert('Network error. Please try again.');
    }
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
});
</script>
{% endblock %}
