{% extends "base.html" %}
{% block title %}Family Messages - {{ family_account.family_name }} - HomeGrubHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Family Navigation Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="navbar navbar-expand-lg navbar-light bg-gradient-primary text-white rounded">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1 text-white">
                        <i class="fas fa-comments me-2"></i>{{ family_account.family_name }} Messages
                    </span>
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link text-white" href="{{ url_for('family.family_dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                        <a class="nav-link text-white" href="{{ url_for('family_collab.cooking_assignments') }}">
                            <i class="fas fa-user-friends me-1"></i>Cooking Assignments
                        </a>
                        <a class="nav-link text-white" href="{{ url_for('family_collab.family_recipe_collection') }}">
                            <i class="fas fa-book-open me-1"></i>Recipe Collection
                        </a>
                        <a class="nav-link text-white active" href="{{ url_for('family_collab.family_messages') }}">
                            <i class="fas fa-comments me-1"></i>Messages
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Message Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <div class="display-4 mb-2">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h3 class="mb-1">{{ message_stats.total_messages }}</h3>
                    <p class="card-text">Total Messages</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <div class="display-4 mb-2">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <h3 class="mb-1">{{ message_stats.messages_this_week }}</h3>
                    <p class="card-text">This Week</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <div class="display-4 mb-2">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <h3 class="mb-1">{{ message_stats.active_conversations }}</h3>
                    <p class="card-text">Active Conversations</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center">
                    <div class="display-4 mb-2">
                        <i class="fas fa-bell"></i>
                    </div>
                    <h3 class="mb-1" style="font-size: 1.5rem;">
                        {{ message_stats.most_active_member[:12] if message_stats.most_active_member else 'None' }}
                    </h3>
                    <p class="card-text">Most Active</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Message Center -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 me-3">
                            <i class="fas fa-comments me-2 text-primary"></i>Family Message Center
                        </h5>
                        <div class="btn-group" role="group" aria-label="Message filters">
                            <input type="radio" class="btn-check" name="messageFilter" id="all-messages" value="all" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="all-messages">All</label>
                            
                            <input type="radio" class="btn-check" name="messageFilter" id="cooking-messages" value="cooking">
                            <label class="btn btn-outline-secondary btn-sm" for="cooking-messages">Cooking</label>
                            
                            <input type="radio" class="btn-check" name="messageFilter" id="planning-messages" value="planning">
                            <label class="btn btn-outline-secondary btn-sm" for="planning-messages">Planning</label>
                            
                            <input type="radio" class="btn-check" name="messageFilter" id="general-messages" value="general">
                            <label class="btn btn-outline-secondary btn-sm" for="general-messages">General</label>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                        <i class="fas fa-plus me-1"></i>New Message
                    </button>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if family_messages %}
                        <div class="message-thread">
                            {% for message in family_messages %}
                                <div class="message-item mb-3 p-3 rounded 
                                    {% if message.sender_member.user_id == current_user.id %}
                                        bg-primary bg-opacity-10 ms-5
                                    {% else %}
                                        bg-light me-5
                                    {% endif %}
                                    {% if message.message_type == 'cooking' %}border-start border-warning border-4
                                    {% elif message.message_type == 'planning' %}border-start border-info border-4
                                    {% elif message.message_type == 'announcement' %}border-start border-success border-4
                                    {% endif %}" 
                                    data-message-type="{{ message.message_type }}">
                                    
                                    <!-- Message Header -->
                                    <div class="message-header d-flex justify-content-between align-items-start mb-2">
                                        <div class="sender-info d-flex align-items-center">
                                            <div class="sender-avatar me-2">
                                                {% if message.sender_member.age_group == 'child' %}
                                                    <i class="fas fa-child text-primary"></i>
                                                {% elif message.sender_member.age_group == 'teen' %}
                                                    <i class="fas fa-user-graduate text-info"></i>
                                                {% else %}
                                                    <i class="fas fa-user text-success"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong class="sender-name">{{ message.sender_member.display_name }}</strong>
                                                <small class="text-muted ms-2">{{ message.sender_member.role.title() }}</small>
                                            </div>
                                        </div>
                                        <div class="message-meta text-end">
                                            <div class="message-time small text-muted">
                                                {{ message.created_at.strftime('%m/%d at %H:%M') }}
                                            </div>
                                            {% if message.message_type %}
                                                <div class="message-type">
                                                    {% if message.message_type == 'cooking' %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-utensils me-1"></i>Cooking
                                                        </span>
                                                    {% elif message.message_type == 'planning' %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-calendar me-1"></i>Planning
                                                        </span>
                                                    {% elif message.message_type == 'announcement' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-bullhorn me-1"></i>Announcement
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-comment me-1"></i>General
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Message Subject -->
                                    {% if message.subject %}
                                        <div class="message-subject mb-2">
                                            <h6 class="mb-0 text-dark">{{ message.subject }}</h6>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Message Content -->
                                    <div class="message-content">
                                        <p class="mb-0">{{ message.content }}</p>
                                    </div>
                                    
                                    <!-- Related Recipe or Assignment -->
                                    {% if message.related_recipe_id %}
                                        <div class="related-content mt-2 p-2 bg-white rounded border">
                                            <small class="text-muted">
                                                <i class="fas fa-utensils me-1"></i>Related Recipe:
                                                <a href="/recipe/{{ message.related_recipe_id }}" class="text-decoration-none">
                                                    View Recipe
                                                </a>
                                            </small>
                                        </div>
                                    {% elif message.related_assignment_id %}
                                        <div class="related-content mt-2 p-2 bg-white rounded border">
                                            <small class="text-muted">
                                                <i class="fas fa-tasks me-1"></i>Related Assignment:
                                                <a href="#" onclick="viewAssignment({{ message.related_assignment_id }})" class="text-decoration-none">
                                                    View Assignment
                                                </a>
                                            </small>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Message Actions -->
                                    <div class="message-actions mt-2 d-flex justify-content-between align-items-center">
                                        <div class="action-buttons">
                                            {% if message.parent_message_id %}
                                                <button class="btn btn-link btn-sm p-0 text-muted" onclick="showParentMessage({{ message.parent_message_id }})">
                                                    <i class="fas fa-reply me-1"></i>Show Original
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="reply-button">
                                            <button class="btn btn-outline-primary btn-sm" onclick="replyToMessage({{ message.id }}, '{{ message.sender_member.display_name }}')">
                                                <i class="fas fa-reply me-1"></i>Reply
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Replies Preview -->
                                    {% set replies = message.get_replies() %}
                                    {% if replies %}
                                        <div class="replies-preview mt-3">
                                            <div class="replies-header">
                                                <small class="text-muted">
                                                    <i class="fas fa-comments me-1"></i>{{ replies|length }} Replies
                                                </small>
                                            </div>
                                            <div class="replies-list mt-2">
                                                {% for reply in replies %}
                                                    <div class="reply-item p-2 bg-white rounded mb-2">
                                                        <div class="reply-header d-flex justify-content-between">
                                                            <small class="fw-bold">{{ reply.sender_member.display_name }}</small>
                                                            <small class="text-muted">{{ reply.created_at.strftime('%m/%d %H:%M') }}</small>
                                                        </div>
                                                        <div class="reply-content">
                                                            <small>{{ reply.content }}</small>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <h5>No Messages Yet</h5>
                            <p>Start a conversation with your family about cooking, meal planning, or anything else!</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                                <i class="fas fa-plus me-1"></i>Send First Message
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Message Sidebar -->
        <div class="col-lg-4 mb-4">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning btn-sm" onclick="createCookingMessage()">
                            <i class="fas fa-utensils me-1"></i>Cooking Question
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="createPlanningMessage()">
                            <i class="fas fa-calendar me-1"></i>Meal Planning
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="createAnnouncementMessage()">
                            <i class="fas fa-bullhorn me-1"></i>Family Announcement
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="createGeneralMessage()">
                            <i class="fas fa-comment me-1"></i>General Chat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Family Members -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-users me-2 text-success"></i>Family Members Online
                    </h6>
                </div>
                <div class="card-body">
                    {% for member in family_members %}
                        <div class="member-status d-flex align-items-center mb-2">
                            <div class="member-avatar me-2">
                                {% if member.age_group == 'child' %}
                                    <i class="fas fa-child text-primary"></i>
                                {% elif member.age_group == 'teen' %}
                                    <i class="fas fa-user-graduate text-info"></i>
                                {% else %}
                                    <i class="fas fa-user text-success"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="member-name">{{ member.display_name }}</div>
                                <small class="text-muted">{{ member.role.title() }}</small>
                            </div>
                            <div class="status-indicator">
                                {% if member.last_active and (today - member.last_active.date()).days < 1 %}
                                    <span class="badge bg-success">Online</span>
                                {% else %}
                                    <span class="badge bg-secondary">Offline</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Message Guidelines -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2 text-info"></i>Message Guidelines
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            Keep messages family-friendly
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            Use cooking type for recipe questions
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            Planning type for meal coordination
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            Reply to messages to keep conversations organized
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-1"></i>
                            Be respectful and supportive
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('family_collab.send_family_message') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newMessageModalLabel">
                        <i class="fas fa-plus me-2"></i>Send Family Message
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="parent_message_id" name="parent_message_id" value="">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" name="subject" placeholder="What's this message about?">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="message_type" class="form-label">Message Type</label>
                                <select class="form-select" id="message_type" name="message_type">
                                    <option value="general">General</option>
                                    <option value="cooking">Cooking</option>
                                    <option value="planning">Meal Planning</option>
                                    <option value="announcement">Announcement</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">Message</label>
                        <textarea class="form-control" id="content" name="content" rows="4" 
                                  placeholder="Type your message here..." required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="related_recipe_id" class="form-label">Related Recipe (Optional)</label>
                                <select class="form-select" id="related_recipe_id" name="related_recipe_id">
                                    <option value="">No related recipe</option>
                                    {% if recent_recipes %}
                                        {% for recipe in recent_recipes %}
                                            <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="related_assignment_id" class="form-label">Related Assignment (Optional)</label>
                                <select class="form-select" id="related_assignment_id" name="related_assignment_id">
                                    <option value="">No related assignment</option>
                                    {% if recent_assignments %}
                                        {% for assignment in recent_assignments %}
                                            <option value="{{ assignment.id }}">
                                                {{ assignment.cooking_date.strftime('%m/%d') }} - {{ assignment.assigned_member.display_name }}
                                            </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reply Context (Hidden by default) -->
                    <div id="reply-context" class="mb-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-reply me-1"></i>Replying to <span id="reply-to-name"></span>
                                </h6>
                                <p class="card-text small text-muted mb-0" id="reply-to-content"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Message filtering
document.querySelectorAll('input[name="messageFilter"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const filterType = this.value;
        const messageItems = document.querySelectorAll('.message-item');
        
        messageItems.forEach(item => {
            if (filterType === 'all') {
                item.style.display = 'block';
            } else {
                const messageType = item.getAttribute('data-message-type');
                item.style.display = messageType === filterType ? 'block' : 'none';
            }
        });
    });
});

// Reply functionality
function replyToMessage(messageId, senderName) {
    document.getElementById('parent_message_id').value = messageId;
    document.getElementById('reply-to-name').textContent = senderName;
    document.getElementById('reply-context').style.display = 'block';
    
    const modal = new bootstrap.Modal(document.getElementById('newMessageModal'));
    modal.show();
}

// Clear reply context when modal is closed
document.getElementById('newMessageModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('parent_message_id').value = '';
    document.getElementById('reply-context').style.display = 'none';
    document.getElementById('newMessageModal').querySelector('form').reset();
});

// Quick message creation functions
function createCookingMessage() {
    document.getElementById('message_type').value = 'cooking';
    document.getElementById('subject').placeholder = 'e.g., Question about tonight\'s recipe';
    new bootstrap.Modal(document.getElementById('newMessageModal')).show();
}

function createPlanningMessage() {
    document.getElementById('message_type').value = 'planning';
    document.getElementById('subject').placeholder = 'e.g., This week\'s meal plan';
    new bootstrap.Modal(document.getElementById('newMessageModal')).show();
}

function createAnnouncementMessage() {
    document.getElementById('message_type').value = 'announcement';
    document.getElementById('subject').placeholder = 'e.g., Family dinner plans changed';
    new bootstrap.Modal(document.getElementById('newMessageModal')).show();
}

function createGeneralMessage() {
    document.getElementById('message_type').value = 'general';
    document.getElementById('subject').placeholder = 'e.g., Just wanted to chat';
    new bootstrap.Modal(document.getElementById('newMessageModal')).show();
}

// Auto-scroll to bottom of message thread
const messageContainer = document.querySelector('.card-body');
if (messageContainer && document.querySelectorAll('.message-item').length > 0) {
    messageContainer.scrollTop = messageContainer.scrollHeight;
}
</script>

<style>
.message-item {
    transition: all 0.2s ease-in-out;
}

.message-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.sender-avatar i {
    font-size: 1.1em;
}

.replies-list .reply-item {
    transition: background-color 0.2s;
}

.replies-list .reply-item:hover {
    background-color: #f8f9fa !important;
}

.member-status {
    transition: background-color 0.2s;
    padding: 8px;
    border-radius: 8px;
}

.member-status:hover {
    background-color: #f8f9fa;
}

.message-thread {
    padding: 0;
}

.border-start {
    border-left-width: 4px !important;
}
</style>

{% endblock %}
