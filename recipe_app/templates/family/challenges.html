{% extends "base.html" %}

{% block title %}Family Challenges - HomeGrubHub{% endblock %}

{% block extra_head %}
<style>
    .challenges-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .challenges-header {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
        position: relative;
    }
    
    .challenges-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .stat-item {
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-item h3 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .stat-item p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    .challenges-nav {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .nav-btn {
        padding: 10px 20px;
        border: 2px solid #ff6b6b;
        background: white;
        color: #ff6b6b;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .nav-btn.active,
    .nav-btn:hover {
        background: #ff6b6b;
        color: white;
        transform: translateY(-2px);
    }
    
    .challenges-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
    }
    
    .challenges-main {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .challenge-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        padding: 25px;
        transition: all 0.3s ease;
    }
    
    .challenge-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .challenge-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .challenge-title {
        flex: 1;
    }
    
    .challenge-title h3 {
        margin: 0 0 5px 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .challenge-dates {
        font-size: 0.9rem;
        color: #666;
    }
    
    .challenge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-completed {
        background: #cce5ff;
        color: #004085;
    }
    
    .status-expired {
        background: #f8d7da;
        color: #721c24;
    }
    
    .challenge-description {
        margin: 15px 0;
        color: #555;
        line-height: 1.6;
    }
    
    .challenge-progress {
        margin: 20px 0;
    }
    
    .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .progress-bar {
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b 0%, #ffa726 100%);
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .challenge-participants {
        margin: 15px 0;
    }
    
    .participants-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }
    
    .participant-badge {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .participant-active {
        border-color: #28a745;
        color: #28a745;
    }
    
    .challenge-rewards {
        background: #fff3cd;
        border-radius: 10px;
        padding: 10px;
        margin-top: 15px;
    }
    
    .challenge-rewards h5 {
        margin: 0 0 5px 0;
        color: #856404;
        font-size: 0.9rem;
    }
    
    .challenge-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-primary {
        background: #ff6b6b;
        color: white;
    }
    
    .btn-primary:hover {
        background: #ff5252;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .sidebar-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .sidebar-section h3 {
        margin: 0 0 15px 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .achievement-item {
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .achievement-item:last-child {
        border-bottom: none;
    }
    
    .achievement-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }
    
    .achievement-info h5 {
        margin: 0;
        color: #333;
        font-size: 0.9rem;
    }
    
    .achievement-info p {
        margin: 2px 0 0 0;
        color: #666;
        font-size: 0.8rem;
    }
    
    .create-challenge-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #ff6b6b;
        outline: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #ddd;
    }
    
    .leaderboard {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .leaderboard-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .leaderboard-item.top {
        background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        color: white;
    }
    
    .section-hidden {
        display: none;
    }
    
    @media (max-width: 768px) {
        .challenges-content {
            grid-template-columns: 1fr;
        }
        
        .challenges-nav {
            flex-direction: column;
            align-items: center;
        }
        
        .challenge-header {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        
        .challenges-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .challenge-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="challenges-container">
    <!-- Header -->
    <div class="challenges-header">
        <h1><i class="fas fa-trophy"></i> Family Challenges & Achievements</h1>
        <p>Work together to build healthy habits and have fun!</p>
        
        <div class="challenges-stats">
            <div class="stat-item">
                <h3>{{ active_challenges | length }}</h3>
                <p>Active Challenges</p>
            </div>
            <div class="stat-item">
                <h3>{{ completed_challenges | length }}</h3>
                <p>Completed</p>
            </div>
            <div class="stat-item">
                <h3>{{ family_achievements | length }}</h3>
                <p>Total Achievements</p>
            </div>
            <div class="stat-item">
                <h3>{{ family_members | length }}</h3>
                <p>Participants</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <div class="challenges-nav">
        <button class="nav-btn active" onclick="showSection('active')">
            <i class="fas fa-fire"></i> Active Challenges
        </button>
        <button class="nav-btn" onclick="showSection('completed')">
            <i class="fas fa-check-circle"></i> Completed
        </button>
        <button class="nav-btn" onclick="showSection('create')">
            <i class="fas fa-plus"></i> Create Challenge
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="challenges-content">
        <!-- Active Challenges Section -->
        <div class="challenges-main">
            <div id="active-section">
                {% if active_challenges %}
                    {% for challenge in active_challenges %}
                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div class="challenge-title">
                                <h3>
                                    <i class="fas fa-{{ get_challenge_icon(challenge.challenge_type) }}"></i>
                                    {{ challenge.title }}
                                </h3>
                                <div class="challenge-dates">
                                    {{ challenge.start_date.strftime('%b %d') }} - {{ challenge.end_date.strftime('%b %d, %Y') }}
                                </div>
                            </div>
                            <span class="challenge-status status-active">Active</span>
                        </div>
                        
                        <div class="challenge-description">
                            {{ challenge.description }}
                        </div>
                        
                        <div class="challenge-progress">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span>{{ challenge.current_progress or 0 }}/{{ challenge.target_value }} {{ challenge.unit or 'points' }}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ ((challenge.current_progress or 0) / challenge.target_value * 100) | round }}%"></div>
                            </div>
                        </div>
                        
                        <div class="challenge-participants">
                            <strong>Participants:</strong>
                            <div class="participants-list">
                                {% for member in family_members %}
                                <div class="participant-badge participant-active">
                                    <i class="fas fa-user"></i>
                                    {{ member.display_name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if challenge.rewards %}
                        <div class="challenge-rewards">
                            <h5><i class="fas fa-gift"></i> Rewards:</h5>
                            <p>{{ challenge.rewards }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="challenge-actions">
                            <button class="btn btn-primary" onclick="logProgress({{ challenge.id }})">
                                <i class="fas fa-plus"></i> Log Progress
                            </button>
                            <button class="btn btn-secondary" onclick="viewDetails({{ challenge.id }})">
                                <i class="fas fa-info-circle"></i> View Details
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <h3>No active challenges!</h3>
                        <p>Create a new challenge to start building healthy habits together.</p>
                        <button class="btn btn-primary" onclick="showSection('create')">
                            <i class="fas fa-plus"></i> Create First Challenge
                        </button>
                    </div>
                {% endif %}
            </div>
            
            <!-- Completed Challenges Section -->
            <div id="completed-section" class="section-hidden">
                {% if completed_challenges %}
                    {% for challenge in completed_challenges %}
                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div class="challenge-title">
                                <h3>
                                    <i class="fas fa-{{ get_challenge_icon(challenge.challenge_type) }}"></i>
                                    {{ challenge.title }}
                                </h3>
                                <div class="challenge-dates">
                                    Completed on {{ challenge.completion_date.strftime('%b %d, %Y') if challenge.completion_date }}
                                </div>
                            </div>
                            <span class="challenge-status status-completed">Completed</span>
                        </div>
                        
                        <div class="challenge-description">
                            {{ challenge.description }}
                        </div>
                        
                        <div class="challenge-progress">
                            <div class="progress-header">
                                <span>Final Progress</span>
                                <span>{{ challenge.current_progress or 0 }}/{{ challenge.target_value }} {{ challenge.unit or 'points' }}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        
                        {% if challenge.rewards %}
                        <div class="challenge-rewards">
                            <h5><i class="fas fa-gift"></i> Rewards Earned:</h5>
                            <p>{{ challenge.rewards }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-medal"></i>
                        <h3>No completed challenges yet!</h3>
                        <p>Complete your first challenge to see it here.</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Create Challenge Section -->
            <div id="create-section" class="section-hidden">
                <div class="challenge-card">
                    <h3><i class="fas fa-plus"></i> Create New Family Challenge</h3>
                    
                    <form class="create-challenge-form" onsubmit="createChallenge(event)">
                        <div>
                            <label>Challenge Title *</label>
                            <input type="text" class="form-control" name="title" required placeholder="e.g., Cook Together 10 Times">
                        </div>
                        
                        <div>
                            <label>Challenge Type</label>
                            <select class="form-control" name="challenge_type" onchange="updateChallengeForm(this.value)">
                                <option value="cooking">Cooking Challenge</option>
                                <option value="meal_planning">Meal Planning</option>
                                <option value="healthy_eating">Healthy Eating</option>
                                <option value="exercise">Family Exercise</option>
                                <option value="custom">Custom Challenge</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Describe your challenge goals..."></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Target Value *</label>
                                <input type="number" class="form-control" name="target_value" required min="1" value="10">
                            </div>
                            <div>
                                <label>Unit</label>
                                <input type="text" class="form-control" name="unit" placeholder="e.g., meals, days, points">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Start Date</label>
                                <input type="date" class="form-control" name="start_date" value="{{ date.today().strftime('%Y-%m-%d') }}">
                            </div>
                            <div>
                                <label>End Date</label>
                                <input type="date" class="form-control" name="end_date" value="{{ (date.today() + timedelta(days=30)).strftime('%Y-%m-%d') }}">
                            </div>
                        </div>
                        
                        <div>
                            <label>Rewards (Optional)</label>
                            <input type="text" class="form-control" name="rewards" placeholder="e.g., Family movie night, Special dinner out">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-rocket"></i> Launch Challenge
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Recent Achievements -->
            <div class="sidebar-section">
                <h3><i class="fas fa-award"></i> Recent Achievements</h3>
                {% if family_achievements %}
                    {% for achievement in family_achievements[:5] %}
                    <div class="achievement-item">
                        <div class="achievement-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="achievement-info">
                            <h5>{{ achievement.achievement_name }}</h5>
                            <p>{{ achievement.member.display_name if achievement.member }} • {{ achievement.earned_date.strftime('%b %d') }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No achievements yet</p>
                {% endif %}
            </div>
            
            <!-- Family Leaderboard -->
            <div class="sidebar-section">
                <h3><i class="fas fa-crown"></i> Family Leaderboard</h3>
                <div class="leaderboard">
                    {% for member in family_members %}
                    <div class="leaderboard-item {{ 'top' if loop.first }}">
                        <span>
                            {% if loop.first %}<i class="fas fa-crown"></i>{% endif %}
                            {{ member.display_name }}
                        </span>
                        <span><strong>{{ (member.id * 47) % 100 + 50 }}</strong> pts</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Challenge Ideas -->
            <div class="sidebar-section">
                <h3><i class="fas fa-lightbulb"></i> Challenge Ideas</h3>
                <div class="challenge-ideas">
                    <p><strong>🍳 Cook Together:</strong> Make 15 family meals together</p>
                    <p><strong>🥗 Healthy Week:</strong> Eat 5 servings of vegetables daily</p>
                    <p><strong>📱 Screen-Free Dinners:</strong> 20 phone-free family meals</p>
                    <p><strong>🎯 Meal Prep:</strong> Plan and prep meals for 4 weeks</p>
                    <p><strong>🌟 Try New Foods:</strong> Each member tries 10 new foods</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Section navigation
function showSection(section) {
    // Hide all sections
    document.getElementById('active-section').classList.add('section-hidden');
    document.getElementById('completed-section').classList.add('section-hidden');
    document.getElementById('create-section').classList.add('section-hidden');
    
    // Show selected section
    document.getElementById(section + '-section').classList.remove('section-hidden');
    
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// Challenge type form updates
function updateChallengeForm(type) {
    const suggestions = {
        'cooking': {
            title: 'Cook Together Challenge',
            description: 'Prepare family meals together and learn new cooking skills.',
            unit: 'meals',
            target_value: 10
        },
        'meal_planning': {
            title: 'Meal Planning Masters',
            description: 'Plan healthy family meals for the whole week.',
            unit: 'weeks',
            target_value: 4
        },
        'healthy_eating': {
            title: 'Healthy Eating Heroes',
            description: 'Eat more fruits and vegetables as a family.',
            unit: 'servings',
            target_value: 50
        },
        'exercise': {
            title: 'Family Fitness Fun',
            description: 'Stay active together with fun family exercises.',
            unit: 'activities',
            target_value: 20
        }
    };
    
    const suggestion = suggestions[type];
    if (suggestion) {
        document.querySelector('input[name="title"]').value = suggestion.title;
        document.querySelector('textarea[name="description"]').value = suggestion.description;
        document.querySelector('input[name="unit"]').value = suggestion.unit;
        document.querySelector('input[name="target_value"]').value = suggestion.target_value;
    }
}

// Create challenge
function createChallenge(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert numeric fields
    data.target_value = parseInt(data.target_value);
    
    fetch('/family/create-challenge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Challenge created successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating challenge');
    });
}

// Log progress
function logProgress(challengeId) {
    const progress = prompt('Enter progress amount:');
    if (progress && !isNaN(progress)) {
        fetch('/family/log-challenge-progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                challenge_id: challengeId,
                progress: parseInt(progress)
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Progress logged successfully!');
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error logging progress');
        });
    }
}

// View challenge details
function viewDetails(challengeId) {
    // In a full implementation, this would open a detailed modal
    alert('Challenge details coming soon!');
}

// Challenge icon mapping
function getChallengeIcon(type) {
    const icons = {
        'cooking': 'utensils',
        'meal_planning': 'calendar-alt',
        'healthy_eating': 'apple-alt',
        'exercise': 'running',
        'custom': 'star'
    };
    return icons[type] || 'trophy';
}
</script>
{% endblock %}
