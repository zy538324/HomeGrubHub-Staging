{% extends "base.html" %}

{% block title %}Nutrition Tracker - HomeGrubHub{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-chart-line"></i> Nutrition Tracker</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showAddEntryModal()">
                        <i class="fas fa-plus"></i> Add Entry
                    </button>
                    <a href="{{ url_for('scanner_upload.barcode_scanner_page') }}" class="btn btn-success">
                        <i class="fas fa-barcode"></i> Scan Barcode
                    </a>
                    <a href="/weekly-shopping/" class="btn btn-info">
                        <i class="fas fa-calendar-week"></i> Weekly Shopping
                    </a>
                    <button class="btn btn-outline-secondary" onclick="showGoalsModal()">
                        <i class="fas fa-cog"></i> Goals
                    </button>
                </div>
            </div>
        </div>
    </div>
     <!-- Weight and Fitness Tracking -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-weight"></i> Weight Tracker</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showWeightLogModal()">
                        <i class="fas fa-plus"></i> Log Weight
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="weightChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-dumbbell"></i> Recent Workouts</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showWorkoutLogModal()">
                        <i class="fas fa-plus"></i> Log Workout
                    </button>
                </div>
                <div class="card-body" id="recent-workouts">
                    <!-- Recent workouts will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Today's Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="calories-consumed">{{ daily_summary.total_calories|round(0)|int if daily_summary else 0 }}</h4>
                            <p class="mb-0">Calories</p>
                            <small>Goal: {{ goals.daily_calories|round(0)|int }}</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-fire fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set calories_percent = ((daily_summary.total_calories / goals.daily_calories) * 100) if daily_summary and goals.daily_calories > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [calories_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="protein-consumed">{{ daily_summary.total_protein|round(1) if daily_summary else 0 }}g</h4>
                            <p class="mb-0">Protein</p>
                            <small>Goal: {{ goals.daily_protein|round(0)|int }}g</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dumbbell fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set protein_percent = ((daily_summary.total_protein / goals.daily_protein) * 100) if daily_summary and goals.daily_protein > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [protein_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="carbs-consumed">{{ daily_summary.total_carbs|round(1) if daily_summary else 0 }}g</h4>
                            <p class="mb-0">Carbs</p>
                            <small>Goal: {{ goals.daily_carbs|round(0)|int }}g</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bread-slice fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set carbs_percent = ((daily_summary.total_carbs / goals.daily_carbs) * 100) if daily_summary and goals.daily_carbs > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [carbs_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="fat-consumed">{{ daily_summary.total_fat|round(1) if daily_summary else 0 }}g</h4>
                            <p class="mb-0">Fat</p>
                            <small>Goal: {{ goals.daily_fat|round(0)|int }}g</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cheese fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set fat_percent = ((daily_summary.total_fat / goals.daily_fat) * 100) if daily_summary and goals.daily_fat > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [fat_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="fiber-consumed">{{ daily_summary.total_fiber|round(1) if daily_summary else 0 }}g</h4>
                            <p class="mb-0">Fiber</p>
                            <small>Goal: {{ goals.daily_fiber|round(0)|int }}g</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-seedling fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set fiber_percent = ((daily_summary.total_fiber / goals.daily_fiber) * 100) if daily_summary and goals.daily_fiber > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [fiber_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="sugar-consumed">{{ daily_summary.total_sugar|round(1) if daily_summary else 0 }}g</h4>
                            <p class="mb-0">Sugar</p>
                            <small>Goal: {{ goals.daily_sugar|round(0)|int }}g</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-candy-cane fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set sugar_percent = ((daily_summary.total_sugar / goals.daily_sugar) * 100) if daily_summary and goals.daily_sugar > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [sugar_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="sodium-consumed">{{ daily_summary.total_sodium|round(0)|int if daily_summary else 0 }}mg</h4>
                            <p class="mb-0">Sodium</p>
                            <small>Goal: {{ goals.daily_sodium|round(0)|int }}mg</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tint fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set sodium_percent = ((daily_summary.total_sodium / goals.daily_sodium) * 100) if daily_summary and goals.daily_sodium > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [sodium_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="water-consumed">{{ water_total|int }}</h4>
                            <p class="mb-0">Water (ml)</p>
                            <small>Goal: 2000ml</small>
                        </div>
                        <div class="align-self-center">
                            <button class="btn btn-sm btn-outline-light" onclick="showWaterLogPrompt()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set water_percent = ((water_total / 2000) * 100) if water_total else 0 %}
                        <div class="progress-bar bg-white" id="water-progress" style="width: {{ [water_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="cholesterol-consumed">{{ daily_summary.total_cholesterol|round(0)|int if daily_summary else 0 }}mg</h4>
                            <p class="mb-0">Cholesterol</p>
                            <small>Goal: {{ goals.daily_cholesterol|round(0)|int }}mg</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heart fa-2x"></i>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        {% set chol_percent = ((daily_summary.total_cholesterol / goals.daily_cholesterol) * 100) if daily_summary and goals.daily_cholesterol > 0 else 0 %}
                        <div class="progress-bar bg-white" style="width: {{ [chol_percent, 100]|min }}%"></div>
                    </div>
                </div>
            </div>
        </div
    </div>

    <!-- Date Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-primary" onclick="changeDate(-1)">
                            <i class="fas fa-chevron-left"></i> Previous Day
                        </button>
                        <h5 id="current-date" class="mb-0">{{ today.strftime('%A, %B %d, %Y') }}</h5>
                        <button class="btn btn-outline-primary" onclick="changeDate(1)">
                            Next Day <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Sections -->
    <div class="row">
        <div class="col-md-6">
            <!-- Breakfast -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-sun"></i> Breakfast</h6>
                    <div>
                        <span id="breakfast-calories" class="badge badge-primary">
                            {{ daily_summary.breakfast_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-primary ml-2" onclick="showAddEntryModal('breakfast')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="breakfast-entries">
                    <!-- Breakfast entries will be loaded here -->
                </div>
            </div>

            <!-- Lunch -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-sun"></i> Lunch</h6>
                    <div>
                        <span id="lunch-calories" class="badge badge-success">
                            {{ daily_summary.lunch_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-success ml-2" onclick="showAddEntryModal('lunch')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="lunch-entries">
                    <!-- Lunch entries will be loaded here -->
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Dinner -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-moon"></i> Dinner</h6>
                    <div>
                        <span id="dinner-calories" class="badge badge-warning">
                            {{ daily_summary.dinner_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-warning ml-2" onclick="showAddEntryModal('dinner')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="dinner-entries">
                    <!-- Dinner entries will be loaded here -->
                </div>
            </div>

            <!-- Snacks -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-apple-alt"></i> Snacks</h6>
                    <div>
                        <span id="snack-calories" class="badge badge-info">
                            {{ daily_summary.snack_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-info ml-2" onclick="showAddEntryModal('snack')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="snack-entries">
                    <!-- Snack entries will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Chart -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Weekly Overview</h6>
                </div>
                <div class="card-body">
                    <canvas id="weeklyChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Entry Modal -->
<div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryTitle" aria-describedby="addEntryDesc">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEntryTitle">Add Nutrition Entry</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="addEntryDesc" class="sr-only">Fill out this form to add a nutrition entry.</p>
                <form id="addEntryForm">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" class="form-control" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="brand">Brand (optional)</label>
                        <input type="text" class="form-control" id="brand">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="portion-size">Portion Size (g)</label>
                                <input type="number" class="form-control" id="portion-size" value="100" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="servings">Servings</label>
                                <input type="number" class="form-control" id="servings" value="1" min="0.1" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="meal-type">Meal Type</label>
                        <select class="form-control" id="meal-type" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    
                    <!-- Nutrition Information -->
                    <h6>Nutrition Information (per 100g)</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calories">Calories</label>
                                <input type="number" class="form-control" id="calories" min="0" step="0.1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="protein">Protein (g)</label>
                                <input type="number" class="form-control" id="protein" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="carbs">Carbs (g)</label>
                                <input type="number" class="form-control" id="carbs" min="0" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fat">Fat (g)</label>
                                <input type="number" class="form-control" id="fat" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fiber">Fiber (g)</label>
                                <input type="number" class="form-control" id="fiber" min="0" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sugar">Sugar (g)</label>
                                <input type="number" class="form-control" id="sugar" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sodium">Sodium (mg)</label>
                        <input type="number" class="form-control" id="sodium" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="cholesterol">Cholesterol (mg)</label>
                        <input type="number" class="form-control" id="cholesterol" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNutritionEntry()">Add Entry</button>
            </div>
        </div>
    </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1" aria-labelledby="goalsTitle" aria-describedby="goalsDesc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="goalsTitle">Nutrition Goals</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="goalsDesc" class="sr-only">Adjust your daily nutrition targets.</p>
                <form id="goalsForm">
                    <h6>Daily Nutrition Goals</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-calories">Daily Calories</label>
                                <input type="number" class="form-control" id="daily-calories" value="{{ goals.daily_calories }}" min="1000" max="10000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-protein">Daily Protein (g)</label>
                                <input type="number" class="form-control" id="daily-protein" value="{{ goals.daily_protein }}" min="20" max="500">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-carbs">Daily Carbs (g)</label>
                                <input type="number" class="form-control" id="daily-carbs" value="{{ goals.daily_carbs }}" min="50" max="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-fat">Daily Fat (g)</label>
                                <input type="number" class="form-control" id="daily-fat" value="{{ goals.daily_fat }}" min="20" max="300">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-fiber">Daily Fiber (g)</label>
                                <input type="number" class="form-control" id="daily-fiber" value="{{ goals.daily_fiber }}" min="10" max="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-sugar">Daily Sugar (g)</label>
                                <input type="number" class="form-control" id="daily-sugar" value="{{ goals.daily_sugar }}" min="10" max="200">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-sodium">Max Sodium (mg)</label>
                                <input type="number" class="form-control" id="daily-sodium" value="{{ goals.daily_sodium }}" min="500" max="5000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-cholesterol">Max Cholesterol (mg)</label>
                                <input type="number" class="form-control" id="daily-cholesterol" value="{{ goals.daily_cholesterol }}" min="0" max="1000">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateGoals()">Save Goals</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentDate = new Date('{{ today }}');
let weeklyChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTodaysEntries();
    loadWeeklyChart();
});

// Change date and reload data
function changeDate(days) {
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
    loadEntriesForDate(currentDate);
}

// Update date display
function updateDateDisplay() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = currentDate.toLocaleDateString('en-US', options);
}

// Load today's entries
function loadTodaysEntries() {
    loadEntriesForDate(currentDate);
}

// Load entries for specific date
function loadEntriesForDate(date) {
    const dateStr = date.toISOString().split('T')[0];
    
    fetch(`/nutrition-entries/${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEntries(data.entries);
                updateSummaryForDate(dateStr);
            } else {
                console.error('Error loading entries:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading entries:', error);
        });
}

// Display entries in meal sections
function displayEntries(entries) {
    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
    
    mealTypes.forEach(mealType => {
        const container = document.getElementById(`${mealType}-entries`);
        const mealEntries = entries[mealType] || [];
        
        if (mealEntries.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No entries for this meal</p>';
        } else {
            container.innerHTML = mealEntries.map(entry => createEntryHTML(entry)).join('');
        }
    });
}

// Create HTML for entry
function createEntryHTML(entry) {
    return `
        <div class="nutrition-entry mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${entry.product_name}</strong>
                            ${entry.brand ? `<br><small class="text-muted">${entry.brand}</small>` : ''}
                            <br><small class="text-muted">${entry.portion_size}g Ã— ${entry.servings} serving${entry.servings > 1 ? 's' : ''} = ${entry.total_weight}g total</small>
                            ${entry.notes ? `<br><small class="text-info"><i class="fas fa-sticky-note"></i> ${entry.notes}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleNutritionDetails(${entry.id})" title="Show/hide nutrition details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${entry.id})" title="Delete entry">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main nutrition summary (always visible) -->
                    <div class="nutrition-summary">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h5 mb-0 text-primary">${Math.round(entry.calories || 0)}</div>
                                    <small class="text-muted">Calories</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-success">${(entry.protein || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Protein</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-warning">${(entry.carbs || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Carbs</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-info">${(entry.fat || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Fat</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed nutrition (collapsible) -->
                    <div class="nutrition-details mt-2" id="details-${entry.id}" style="display: none;">
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1"><strong>Additional Nutrients:</strong></small>
                                ${entry.fiber ? `<small class="d-block">Fiber: <span class="float-end">${(entry.fiber).toFixed(1)}g</span></small>` : ''}
                                ${entry.sugar ? `<small class="d-block">Sugar: <span class="float-end">${(entry.sugar).toFixed(1)}g</span></small>` : ''}
                                ${entry.saturated_fat ? `<small class="d-block">Saturated Fat: <span class="float-end">${(entry.saturated_fat).toFixed(1)}g</span></small>` : ''}
                                ${entry.sodium ? `<small class="d-block">Sodium: <span class="float-end">${Math.round(entry.sodium)}mg</span></small>` : ''}
                                ${entry.cholesterol ? `<small class="d-block">Cholesterol: <span class="float-end">${Math.round(entry.cholesterol)}mg</span></small>` : ''}
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1"><strong>Entry Details:</strong></small>
                                <small class="d-block">Logged: <span class="float-end">${new Date(entry.entry_time).toLocaleTimeString()}</span></small>
                                <small class="d-block">Meal: <span class="float-end badge bg-secondary">${entry.meal_type}</span></small>
                                ${entry.barcode ? `<small class="d-block">Barcode: <span class="float-end">${entry.barcode}</span></small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Update summary for date
function updateSummaryForDate(dateStr) {
    fetch(`/nutrition-summary/${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSummaryDisplay(data.summary);
            }
        })
        .catch(error => {
            console.error('Error loading summary:', error);
        });
}

// Update summary display
function updateSummaryDisplay(summary) {
    document.getElementById('calories-consumed').textContent = Math.round(summary.total_calories || 0);
    document.getElementById('protein-consumed').textContent = (summary.total_protein || 0).toFixed(1) + 'g';
    document.getElementById('carbs-consumed').textContent = (summary.total_carbs || 0).toFixed(1) + 'g';
    document.getElementById('fat-consumed').textContent = (summary.total_fat || 0).toFixed(1) + 'g';
    
    // Update meal calories
    document.getElementById('breakfast-calories').textContent = Math.round(summary.breakfast_calories || 0) + ' cal';
    document.getElementById('lunch-calories').textContent = Math.round(summary.lunch_calories || 0) + ' cal';
    document.getElementById('dinner-calories').textContent = Math.round(summary.dinner_calories || 0) + ' cal';
    document.getElementById('snack-calories').textContent = Math.round(summary.snack_calories || 0) + ' cal';
}

// Toggle nutrition details visibility
function toggleNutritionDetails(entryId) {
    const detailsElement = document.getElementById(`details-${entryId}`);
    if (detailsElement) {
        if (detailsElement.style.display === 'none') {
            detailsElement.style.display = 'block';
        } else {
            detailsElement.style.display = 'none';
        }
    }
}

// Show add entry modal
function showAddEntryModal(mealType = 'snack') {
    document.getElementById('meal-type').value = mealType;
    $('#addEntryModal').modal('show');
}

// Add nutrition entry
function addNutritionEntry() {
    const formData = {
        product_name: document.getElementById('product-name').value,
        brand: document.getElementById('brand').value,
        portion_size: parseFloat(document.getElementById('portion-size').value),
        servings: parseFloat(document.getElementById('servings').value),
        meal_type: document.getElementById('meal-type').value,
        notes: document.getElementById('notes').value,
        nutrition: {
            calories: parseFloat(document.getElementById('calories').value) || 0,
            protein: parseFloat(document.getElementById('protein').value) || 0,
            carbs: parseFloat(document.getElementById('carbs').value) || 0,
            fat: parseFloat(document.getElementById('fat').value) || 0,
            fiber: parseFloat(document.getElementById('fiber').value) || 0,
            sugar: parseFloat(document.getElementById('sugar').value) || 0,
            sodium: parseFloat(document.getElementById('sodium').value) || 0,
            cholesterol: parseFloat(document.getElementById('cholesterol').value) || 0
        }
    };
    
    // Calculate actual nutrition based on portion size and servings
    const portionMultiplier = (formData.portion_size / 100) * formData.servings;
    Object.keys(formData.nutrition).forEach(key => {
        formData.nutrition[key] *= portionMultiplier;
    });
    
    fetch('/log-nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#addEntryModal').modal('hide');
            document.getElementById('addEntryForm').reset();
            loadEntriesForDate(currentDate);
            showNotification('Entry added successfully!', 'success');
        } else {
            showNotification('Error adding entry: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error adding entry:', error);
        showNotification('Error adding entry', 'error');
    });
}

// Delete entry
function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this entry?')) {
        fetch(`/delete-nutrition-entry/${entryId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadEntriesForDate(currentDate);
                showNotification('Entry deleted successfully!', 'success');
            } else {
                showNotification('Error deleting entry: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting entry:', error);
            showNotification('Error deleting entry', 'error');
        });
    }
}

// Show goals modal
function showGoalsModal() {
    $('#goalsModal').modal('show');
}

// Update goals
function updateGoals() {
    const formData = {
        daily_calories: parseFloat(document.getElementById('daily-calories').value),
        daily_protein: parseFloat(document.getElementById('daily-protein').value),
        daily_carbs: parseFloat(document.getElementById('daily-carbs').value),
        daily_fat: parseFloat(document.getElementById('daily-fat').value),
        daily_fiber: parseFloat(document.getElementById('daily-fiber').value),
        daily_sugar: parseFloat(document.getElementById('daily-sugar').value),
        daily_sodium: parseFloat(document.getElementById('daily-sodium').value),
        daily_cholesterol: parseFloat(document.getElementById('daily-cholesterol').value)
    };
    
    fetch('/nutrition-goals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#goalsModal').modal('hide');
            location.reload(); // Reload to update progress bars
            showNotification('Goals updated successfully!', 'success');
        } else {
            showNotification('Error updating goals: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating goals:', error);
        showNotification('Error updating goals', 'error');
    });
}

// Load weekly chart
function loadWeeklyChart() {
    fetch('/weekly-summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createWeeklyChart(data.summaries, data.averages);
            }
        })
        .catch(error => {
            console.error('Error loading weekly chart:', error);
        });
}

// Create weekly chart
function createWeeklyChart(summaries, averages) {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    if (weeklyChart) {
        weeklyChart.destroy();
    }
    
    const labels = summaries.map(s => new Date(s.summary_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
    const caloriesData = summaries.map(s => s.total_calories);
    const proteinData = summaries.map(s => s.total_protein);
    const carbsData = summaries.map(s => s.total_carbs);
    const fatData = summaries.map(s => s.total_fat);
    
    weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Calories',
                data: caloriesData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: 'Protein (g)',
                data: proteinData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }, {
                label: 'Carbs (g)',
                data: carbsData,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                yAxisID: 'y1'
            }, {
                label: 'Fat (g)',
                data: fatData,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Calories'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Macros (g)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// CSRF token helper
function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]').getAttribute('content');
}

// Notification helper
function showNotification(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">&times;</button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

<style>
.nutrition-entry {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.nutrition-entry:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.nutrition-stat {
    padding: 8px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.8);
    margin: 2px;
}

.nutrition-details {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    padding: 10px;
}

.float-end {
    float: right;
}

.meal-section .card-header {
    cursor: pointer;
}

.meal-section .card-header:hover {
    background: #e9ecef !important;
}
</style>
{% endblock %}
