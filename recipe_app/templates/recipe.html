{% extends "base.html" %}

{% block title %}{{ recipe.title }} - HomeGrubHub{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ recipe.title }}</h1>
    {% if recipe.description %}
    <p class="text-muted">{{ recipe.description }}</p>
    {% endif %}

    <div class="mb-3">
        {% set avg = avg_rating %}
        <div>
            {% for i in range(5) %}
                <i class="fa{% if i < avg|round(0, 'floor') %}s{% else %}r{% endif %} fa-star text-warning"></i>
            {% endfor %}
            <strong>{{ '%.1f' % avg }}</strong>
            <small class="text-muted">({{ rating_count }} ratings)</small>
        </div>
        {% if current_user.is_authenticated %}
        <div class="mt-2">
            <span>Rate this recipe:</span>
            <span id="rate-widget">
            {% for i in range(1,6) %}
                <i class="far fa-star text-warning rate-star" data-value="{{ i }}"></i>
            {% endfor %}
            </span>
        </div>
        {% endif %}
    </div>

    <h3>Ingredients</h3>
    <ul class="recipe-ingredients">
        {% for item in recipe.ingredients.splitlines() %}
        <li>{{ item }}</li>
        {% endfor %}
    </ul>
    <h3>Method</h3>
    <ol class="recipe-method">
        {% for step in recipe.method.splitlines() %}
        <li>{{ step }}</li>
        {% endfor %}
    </ol>

    <div id="comments" class="mt-5">
        <h3>Comments</h3>
        <div id="comment-list">
            {% from "_comment.html" import render_comment %}
            {% for comment in comments %}
                {{ render_comment(comment) }}
            {% endfor %}
        </div>
        {% if current_user.is_authenticated %}
        <div class="mt-3">
            <textarea id="new-comment" class="form-control" rows="3" placeholder="Add a comment"></textarea>
            <button class="btn btn-primary mt-2" id="submit-comment">Post Comment</button>
        </div>
        {% else %}
        <p><a href="{{ url_for('main.login') }}">Log in</a> to comment.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.rate-star').forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.dataset.value;
            fetch('{{ url_for('main.rate_recipe', recipe_id=recipe.id) }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating: rating})
            }).then(r => r.json()).then(data => {
                if (data.success) { window.location.reload(); }
            });
        });
    });

    const submitBtn = document.getElementById('submit-comment');
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            const content = document.getElementById('new-comment').value.trim();
            if (!content) return;
            fetch('{{ url_for('community.add_comment', recipe_id=recipe.id) }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: content})
            }).then(r => r.json()).then(data => {
                if (data.success) { window.location.reload(); }
            });
        });
    }

    document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const parentId = this.dataset.parent;
            const textarea = this.previousElementSibling;
            const content = textarea.value.trim();
            if (!content) return;
            fetch('{{ url_for('community.add_comment', recipe_id=recipe.id) }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: content, parent_id: parentId})
            }).then(r => r.json()).then(data => {
                if (data.success) { window.location.reload(); }
            });
        });
    });
});
</script>
{% endblock %}
