{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Cooking Challenges Management</h2>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createChallengeModal">
                <i class="fas fa-plus"></i> Create Challenge
            </button>
            <a href="{{ url_for('admin_moderation.moderation_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Active Challenges -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>All Challenges</h5>
                </div>
                <div class="card-body">
                    {% if challenges %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Period</th>
                                        <th>Participants</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for challenge in challenges %}
                                    <tr>
                                        <td>
                                            <strong>{{ challenge.title }}</strong>
                                            {% if challenge.description %}
                                                <br><small class="text-muted">{{ challenge.description[:50] }}{% if challenge.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ challenge.challenge_type.title() }}</span>
                                        </td>
                                        <td>
                                            {{ challenge.start_date.strftime('%Y-%m-%d') }} to<br>
                                            {{ challenge.end_date.strftime('%Y-%m-%d') }}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ challenge.participations|length }}</span>
                                        </td>
                                        <td>
                                            {% set now = moment() %}
                                            {% if challenge.start_date > now %}
                                                <span class="badge bg-secondary">Upcoming</span>
                                            {% elif challenge.end_date < now %}
                                                <span class="badge bg-dark">Ended</span>
                                            {% else %}
                                                <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="viewChallenge({{ challenge.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        onclick="editChallenge({{ challenge.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteChallenge({{ challenge.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No challenges created yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Challenge Modal -->
<div class="modal fade" id="createChallengeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Challenge</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="challengeForm">
                    <div class="mb-3">
                        <label for="challengeTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="challengeTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="challengeDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="challengeDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="challengeType" class="form-label">Type</label>
                                <select class="form-select" id="challengeType">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="seasonal">Seasonal</option>
                                    <option value="special">Special Event</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="challengeDifficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="challengeDifficulty">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                    <option value="any">Any Level</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="challengeStartDate" class="form-label">Start Date *</label>
                                <input type="datetime-local" class="form-control" id="challengeStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="challengeEndDate" class="form-label">End Date *</label>
                                <input type="datetime-local" class="form-control" id="challengeEndDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="challengeRules" class="form-label">Rules & Guidelines</label>
                        <textarea class="form-control" id="challengeRules" rows="4" 
                                  placeholder="Enter challenge rules, requirements, and guidelines..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="challengePrize" class="form-label">Prize/Recognition</label>
                        <input type="text" class="form-control" id="challengePrize" 
                               placeholder="e.g., Featured on homepage, Badge, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createChallenge()">
                    <i class="fas fa-plus"></i> Create Challenge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Challenge Details Modal -->
<div class="modal fade" id="challengeDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Challenge Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="challengeDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
function createChallenge() {
    const form = document.getElementById('challengeForm');
    const formData = new FormData(form);
    
    const challengeData = {
        title: document.getElementById('challengeTitle').value,
        description: document.getElementById('challengeDescription').value,
        type: document.getElementById('challengeType').value,
        start_date: document.getElementById('challengeStartDate').value,
        end_date: document.getElementById('challengeEndDate').value,
        difficulty: document.getElementById('challengeDifficulty').value,
        rules: document.getElementById('challengeRules').value,
        prize: document.getElementById('challengePrize').value
    };
    
    if (!challengeData.title || !challengeData.start_date || !challengeData.end_date) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch('/admin/challenges/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(challengeData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the challenge');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('createChallengeModal')).hide();
}

function viewChallenge(challengeId) {
    // Load challenge details
    fetch(`/api/challenges/${challengeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const challenge = data.challenge;
                const content = `
                    <h5>${challenge.title}</h5>
                    <p>${challenge.description || 'No description'}</p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Type:</strong> ${challenge.challenge_type}<br>
                            <strong>Start:</strong> ${challenge.start_date}<br>
                            <strong>End:</strong> ${challenge.end_date}
                        </div>
                        <div class="col-md-6">
                            <strong>Participants:</strong> ${challenge.participant_count || 0}<br>
                            <strong>Status:</strong> ${challenge.status}
                        </div>
                    </div>
                    ${challenge.rules ? `<div class="mt-3"><strong>Rules:</strong><br>${challenge.rules}</div>` : ''}
                    ${challenge.prize ? `<div class="mt-2"><strong>Prize:</strong> ${challenge.prize}</div>` : ''}
                `;
                document.getElementById('challengeDetailsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('challengeDetailsModal')).show();
            }
        });
}

function editChallenge(challengeId) {
    // Placeholder for edit functionality
    alert('Edit functionality will be implemented');
}

function deleteChallenge(challengeId) {
    if (confirm('Are you sure you want to delete this challenge? This action cannot be undone.')) {
        // Placeholder for delete functionality
        alert('Delete functionality will be implemented');
    }
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const nextWeek = new Date(now);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    document.getElementById('challengeStartDate').value = tomorrow.toISOString().slice(0, 16);
    document.getElementById('challengeEndDate').value = nextWeek.toISOString().slice(0, 16);
});
</script>
{% endblock %}
