{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-9">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h2 class="mb-4 text-center text-primary">Admin Analytics Dashboard</h2>
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-2">
                <h5 class="mb-1">Total Users</h5>
                <div class="display-6">{{ user_count }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-2">
                <h5 class="mb-1">Total Recipes</h5>
                <div class="display-6">{{ recipe_count }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-2">
                <h5 class="mb-1">Logins</h5>
                <div class="display-6">{{ login_count }}</div>
              </div>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="bg-light rounded p-3 mb-2">
                <h5 class="mb-1">Registrations</h5>
                <div class="display-6">{{ register_count }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3 mb-2">
                <h5 class="mb-1">Recipes Added</h5>
                <div class="display-6">{{ add_recipe_count }}</div>
              </div>
            </div>
          </div>
          <h4 class="mt-4">Recent Events</h4>
          <table class="table table-striped table-bordered mt-2">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User ID</th>
                <th>Event Type</th>
                <th>Event Data</th>
              </tr>
            </thead>
            <tbody>
              {% for event in recent_events %}
              <tr>
                <td>{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ event.user_id }}</td>
                <td>{{ event.event_type }}</td>
                <td>{{ event.event_data or '' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <h4 class="mt-5">Fault Logs</h4>
          <form method="get" class="row g-3 mb-3">
            <div class="col-md-4">
              <input type="text" class="form-control" name="fault_user" placeholder="Filter by Username" value="{{ fault_user }}">
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control" name="fault_plan" placeholder="Filter by Plan" value="{{ fault_plan }}">
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control" name="fault_id" placeholder="Filter by Fault ID" value="{{ fault_id }}">
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
          </form>
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Plan</th>
                <th>Fault ID</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for fault in recent_faults %}
              <tr>
                <td>{{ fault.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{% if fault.user %}{{ fault.user.username }} (ID: {{ fault.user_id }}){% else %}N/A{% endif %}</td>
                <td>{{ fault.plan or 'N/A' }}</td>
                <td>{{ fault.fault_id }}</td>
                <td><pre style="white-space: pre-wrap; word-break: break-all;">{{ fault.details }}</pre></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
