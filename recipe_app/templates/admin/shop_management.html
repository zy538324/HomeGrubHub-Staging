{% extends "base.html" %}

{% block title %}Shop Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-store"></i> Shop Management
                </h2>
                <button class="btn btn-primary" onclick="showAddShopModal()">
                    <i class="fas fa-plus"></i> Add Shop
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="totalShops">{{ shops_by_chain.values()|map('length')|sum }}</h4>
                            <p class="mb-0">Total Shops</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-store fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="verifiedShops">{{ shops_by_chain.values()|selectattr('verified')|list|length }}</h4>
                            <p class="mb-0">Verified</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ shops_by_chain.keys()|length }}</h4>
                            <p class="mb-0">Chains</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="pendingShops">0</h4>
                            <p class="mb-0">Pending Approval</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shops by Chain -->
    <div class="row">
        <div class="col-12">
            {% for chain, shops in shops_by_chain.items() %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-building"></i> {{ chain }}
                        <span class="badge bg-secondary ms-2">{{ shops|length }} stores</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="addShopToChain('{{ chain }}')">
                        <i class="fas fa-plus"></i> Add Store
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Shop Name</th>
                                    <th>Address</th>
                                    <th>Postcode</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Added</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shop in shops %}
                                <tr id="shop-{{ shop.id }}">
                                    <td>
                                        <strong>{{ shop.shop_name }}</strong>
                                    </td>
                                    <td>{{ shop.address_line }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ shop.postcode }}</span>
                                    </td>
                                    <td>
                                        {% if shop.store_type %}
                                            <span class="badge bg-info">{{ shop.store_type }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if shop.verified %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Verified
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock"></i> Pending
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ shop.created_at }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editShop({{ shop.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteShop({{ shop.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Shop Modal -->
<div class="modal fade" id="addShopModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Shop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addShopForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="shop_name" class="form-label">Shop Name *</label>
                                <input type="text" class="form-control" id="shop_name" name="shop_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="chain_name" class="form-label">Chain Name</label>
                                <input type="text" class="form-control" id="chain_name" name="chain_name" 
                                       placeholder="e.g., Tesco, Sainsbury's">
                            </div>
                            <div class="mb-3">
                                <label for="store_type" class="form-label">Store Type</label>
                                <select class="form-control" id="store_type" name="store_type">
                                    <option value="">Select type...</option>
                                    <option value="Express">Express</option>
                                    <option value="Extra">Extra</option>
                                    <option value="Metro">Metro</option>
                                    <option value="Local">Local</option>
                                    <option value="Superstore">Superstore</option>
                                    <option value="Convenience">Convenience</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="address_line" class="form-label">Address *</label>
                                <textarea class="form-control" id="address_line" name="address_line" rows="2" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="postcode" class="form-label">Postcode *</label>
                                <input type="text" class="form-control" id="postcode" name="postcode" 
                                       placeholder="e.g., M1 1AA" required>
                                <div id="postcodeValidation" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddShop()">
                    <i class="fas fa-plus"></i> Add Shop
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Shop Modal -->
<div class="modal fade" id="editShopModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Shop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editShopForm">
                    <input type="hidden" id="edit_shop_id" name="shop_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_shop_name" class="form-label">Shop Name *</label>
                                <input type="text" class="form-control" id="edit_shop_name" name="shop_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_chain_name" class="form-label">Chain Name</label>
                                <input type="text" class="form-control" id="edit_chain_name" name="chain_name">
                            </div>
                            <div class="mb-3">
                                <label for="edit_store_type" class="form-label">Store Type</label>
                                <select class="form-control" id="edit_store_type" name="store_type">
                                    <option value="">Select type...</option>
                                    <option value="Express">Express</option>
                                    <option value="Extra">Extra</option>
                                    <option value="Metro">Metro</option>
                                    <option value="Local">Local</option>
                                    <option value="Superstore">Superstore</option>
                                    <option value="Convenience">Convenience</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_address_line" class="form-label">Address *</label>
                                <textarea class="form-control" id="edit_address_line" name="address_line" rows="2" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_postcode" class="form-label">Postcode *</label>
                                <input type="text" class="form-control" id="edit_postcode" name="postcode" required>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_verified" name="verified">
                                    <label class="form-check-label" for="edit_verified">
                                        Verified
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditShop()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show add shop modal
function showAddShopModal() {
    document.getElementById('addShopForm').reset();
    new bootstrap.Modal(document.getElementById('addShopModal')).show();
}

// Add shop to specific chain
function addShopToChain(chainName) {
    document.getElementById('addShopForm').reset();
    document.getElementById('chain_name').value = chainName;
    new bootstrap.Modal(document.getElementById('addShopModal')).show();
}

// Validate postcode when it changes
document.getElementById('postcode').addEventListener('blur', function() {
    validatePostcode(this.value, 'postcodeValidation');
});

function validatePostcode(postcode, validationElementId) {
    const validation = document.getElementById(validationElementId);
    
    if (!postcode) {
        validation.innerHTML = '';
        return;
    }
    
    fetch(`/api/postcode/lookup/${postcode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                validation.innerHTML = `
                    <div class="text-success">
                        <i class="fas fa-check-circle"></i> 
                        Valid postcode: ${data.postcode_data.postcode}
                    </div>
                `;
            } else {
                validation.innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-times-circle"></i> 
                        Invalid postcode
                    </div>
                `;
            }
        })
        .catch(error => {
            validation.innerHTML = `
                <div class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Could not verify postcode
                </div>
            `;
        });
}

// Submit add shop form
function submitAddShop() {
    const formData = new FormData(document.getElementById('addShopForm'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/admin/shops/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh page to show new shop
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
    });
}

// Edit shop
function editShop(shopId) {
    // For now, we'll just show the modal with empty fields
    // In a full implementation, you'd fetch the current shop data
    document.getElementById('edit_shop_id').value = shopId;
    new bootstrap.Modal(document.getElementById('editShopModal')).show();
}

// Submit edit shop form
function submitEditShop() {
    const shopId = document.getElementById('edit_shop_id').value;
    const formData = new FormData(document.getElementById('editShopForm'));
    const data = Object.fromEntries(formData.entries());
    
    fetch(`/admin/shops/${shopId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh page to show changes
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
    });
}

// Delete shop
function deleteShop(shopId) {
    if (confirm('Are you sure you want to delete this shop? This action cannot be undone.')) {
        fetch(`/admin/shops/${shopId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`shop-${shopId}`).remove();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Network error: ' + error.message);
        });
    }
}
</script>
{% endblock %}
