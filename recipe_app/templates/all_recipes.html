{% extends "base.html" %}

{% block content %}
<div class="container">
  <!-- Page Header -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="text-center">
        <h1 class="display-4 mb-3">
          <i class="fas fa-utensils me-3 text-primary"></i>All Recipes
        </h1>
        <p class="lead text-muted">Discover delicious recipes from around the world</p>
        <hr class="w-25 mx-auto">
      </div>
    </div>
  </div>

  <!-- Filter and Sort Options -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('main.all_recipes') }}" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-th-large me-1"></i>All Recipes
        </a>
        <a href="{{ url_for('main.ingredient_search') }}" class="btn btn-outline-success btn-sm">
          <i class="fas fa-search me-1"></i>Find by Ingredients
        </a>
        <a href="{{ url_for('main.tags') }}" class="btn btn-outline-info btn-sm">
          <i class="fas fa-tags me-1"></i>Browse Categories
        </a>
      </div>
    </div>
    <div class="col-md-4 text-md-end">
      <small class="text-muted">
        Showing {{ recipes.items|length }} of {{ recipes.total }} recipes
      </small>
    </div>
  </div>

  <!-- Recipe Cards Grid -->
  {% if recipes.items %}
  <div class="row g-4 mb-5">
    {% for recipe in recipes.items %}
    <div class="col-lg-4 col-md-6">
      <div class="card recipe-card h-100 shadow-sm border-0">
        <!-- Recipe Image -->
        <div class="card-img-wrapper" style="height: 200px; overflow: hidden;">
          {% if recipe.image_file %}
          {% if recipe.image_file.startswith('imported_') %}
          <div class="image-placeholder"></div>
          <img src="{{ url_for('static', filename='uploads/imported_' + recipe.image_file[9:]) }}"
               class="card-img-top w-100 h-100 d-none" style="object-fit: cover;"
               loading="lazy" alt="{{ recipe.title }}"
               onload="this.classList.remove('d-none'); this.previousElementSibling.remove();">
          {% else %}
          <div class="image-placeholder"></div>
          <img src="{{ url_for('static', filename='uploads/' + recipe.image_file) }}"
               class="card-img-top w-100 h-100 d-none" style="object-fit: cover;"
               loading="lazy" alt="{{ recipe.title }}"
               onload="this.classList.remove('d-none'); this.previousElementSibling.remove();">
          {% endif %}
          {% else %}
          <div class="card-img-top w-100 h-100 bg-light d-flex align-items-center justify-content-center">
            <i class="fas fa-utensils fa-3x text-muted"></i>
          </div>
          {% endif %}

          <!-- Badges Overlay -->
          <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-1">
            {% if recipe.cook_time %}
            <span class="badge bg-dark bg-opacity-75">
              <i class="fas fa-clock me-1"></i>{{ recipe.cook_time }}m
            </span>
            {% endif %}
            {% if recipe.difficulty %}
            <span class="badge bg-info bg-opacity-75">
              <i class="fas fa-signal me-1"></i>{{ recipe.difficulty }}
            </span>
            {% endif %}
            {% set avg_rating = recipe.get_average_rating() %}
            {% if avg_rating %}
            <span class="badge bg-warning text-dark">
              <i class="fas fa-star me-1"></i>{{ avg_rating|round(1) }}
            </span>
            {% endif %}
          </div>

          <!-- Country Badge -->
          <div class="position-absolute top-0 end-0 p-2">
            {% if recipe.country %}
            <span class="badge bg-primary">
              <i class="fas fa-flag me-1"></i>{{ recipe.country }}
            </span>
            {% endif %}
          </div>
        </div>

        <!-- Recipe Content -->
        <div class="card-body d-flex flex-column">
          <h5 class="card-title mb-2">
            <a href="{{ url_for('main.recipe', recipe_id=recipe.id) }}" 
               class="text-decoration-none text-dark">
              {{ recipe.title }}
            </a>
          </h5>
          
          {% if recipe.description %}
          <p class="card-text text-muted small mb-3">
            {{ recipe.description[:100] }}{% if recipe.description|length > 100 %}...{% endif %}
          </p>
          {% endif %}

          <!-- Recipe Stats -->
          <div class="row text-center mb-3 small">
            {% if recipe.prep_time %}
            <div class="col-4">
              <i class="fas fa-clock text-primary"></i>
              <div class="fw-bold">{{ recipe.prep_time }}m</div>
              <small class="text-muted">Prep</small>
            </div>
            {% endif %}
            
            {% if recipe.servings %}
            <div class="col-4">
              <i class="fas fa-users text-success"></i>
              <div class="fw-bold">{{ recipe.servings }}</div>
              <small class="text-muted">Serves</small>
            </div>
            {% endif %}
            
            {% if recipe.difficulty %}
            <div class="col-4">
              <i class="fas fa-chart-line text-warning"></i>
              <div class="fw-bold">{{ recipe.difficulty }}</div>
              <small class="text-muted">Level</small>
            </div>
            {% endif %}
          </div>

          <!-- Tags -->
          {% if recipe.tags %}
          <div class="mb-3">
            {% for tag in recipe.tags[:3] %}
            <a href="{{ url_for('main.tag', tag_name=tag.name) }}" 
               class="badge bg-light text-dark text-decoration-none me-1">
              #{{ tag.name }}
            </a>
            {% endfor %}
            {% if recipe.tags|length > 3 %}
            <span class="badge bg-light text-muted">+{{ recipe.tags|length - 3 }} more</span>
            {% endif %}
          </div>
          {% endif %}

          <!-- Action Buttons -->
          <div class="mt-auto">
            <div class="d-flex gap-2">
              <a href="{{ url_for('main.recipe', recipe_id=recipe.id) }}" 
                 class="btn btn-primary btn-sm flex-grow-1">
                <i class="fas fa-eye me-1"></i>View Recipe
              </a>
              <a href="{{ url_for('main.recipe_conversions', recipe_id=recipe.id) }}" 
                 class="btn btn-outline-success btn-sm" title="Conversions & Tools">
                <i class="fas fa-calculator"></i>
              </a>
              {% if current_user.is_authenticated %}
              <button class="btn btn-outline-danger btn-sm favourite-btn" 
                      data-recipe-id="{{ recipe.id }}">
                <i class="fas fa-heart"></i>
              </button>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Recipe Footer -->
        <div class="card-footer bg-light border-0 small text-muted">
          <div class="d-flex justify-content-between align-items-center">
            <span>
              <div class="d-flex align-items-center mt-2">
                <img src="{{ recipe.user.get_profile_image_url() }}" 
                     alt="{{ recipe.user.get_display_name_or_username() }}" 
                     class="rounded-circle me-2" 
                     style="width: 24px; height: 24px; object-fit: cover;">
                <small class="text-muted">{{ recipe.user.get_display_name_or_username() }}</small>
              </div>
            </span>
            <span>
              <i class="fas fa-calendar me-1"></i>
              {% if recipe.created_at %}
                  {{ recipe.created_at.strftime('%b %d') }}
              {% else %}
                  Unknown date
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if recipes.pages > 1 %}
  <nav aria-label="Recipe pagination" class="mb-5">
    <ul class="pagination justify-content-center">
      {% if recipes.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('main.all_recipes', page=recipes.prev_num) }}">
          <i class="fas fa-chevron-left"></i> Previous
        </a>
      </li>
      {% endif %}
      
      {% for page_num in recipes.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if page_num %}
          {% if page_num != recipes.page %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.all_recipes', page=page_num) }}">{{ page_num }}</a>
          </li>
          {% else %}
          <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
          </li>
          {% endif %}
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %}
      {% endfor %}
      
      {% if recipes.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('main.all_recipes', page=recipes.next_num) }}">
          Next <i class="fas fa-chevron-right"></i>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <!-- No Recipes Found -->
  <div class="text-center py-5">
    <i class="fas fa-search fa-4x text-muted mb-3"></i>
    <h3 class="text-muted">No recipes found</h3>
    <p class="text-muted">Be the first to add a recipe!</p>
    <a href="{{ url_for('main.add_recipe') }}" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i>Add Recipe
    </a>
  </div>
  {% endif %}
</div>

<style>
.recipe-card {
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.recipe-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.card-img-wrapper {
  position: relative;
}

.favourite-btn {
  width: 40px;
  height: 32px;
}

.badge {
  font-size: 0.7rem;
}

.recipe-card .card-title a:hover {
  color: var(--primary-color) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Favourite button functionality
    document.querySelectorAll('.favourite-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const recipeId = this.dataset.recipeId;
            
            fetch(`/toggle_favourite/${recipeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                const icon = this.querySelector('i');
                if (data.is_favourite) {
                    icon.className = 'fas fa-heart';
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-danger');
                } else {
                    icon.className = 'far fa-heart';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-outline-danger');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});
</script>
{% endblock %}
