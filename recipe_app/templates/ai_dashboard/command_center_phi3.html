{% extends "base.html" %}

{% block title %}Phi-3 Enhanced AI Command Center - HomeGrubHub Pro{% endblock %}

{% block additional_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    .ai-command-center {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
    }
    
    .quantum-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .phi3-card {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-left: 4px solid #ffd700;
    }
    
    .quantum-card:hover, .phi3-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .ai-metric {
        text-align: center;
        padding: 1rem;
    }
    
    .ai-metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #00ff88;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }
    
    .phi3-metric-value {
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    .ai-metric-label {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 0.5rem;
    }
    
    .quantum-button {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .phi3-button {
        background: linear-gradient(45deg, #ffd700, #ff8c00);
    }
    
    .quantum-button:hover, .phi3-button:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .phi3-status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        animation: phi3-pulse 2s infinite;
        background: #ffd700;
    }
    
    @keyframes phi3-pulse {
        0%, 100% { opacity: 0.7; box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        50% { opacity: 1; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
    }
    
    .phi3-terminal {
        background: #1a1a0a;
        color: #ffd700;
        font-family: 'Courier New', monospace;
        padding: 1rem;
        border-radius: 10px;
        height: 300px;
        overflow-y: auto;
        font-size: 0.9rem;
        border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .phi3-insights {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.05) 100%);
        border: 1px solid rgba(255, 215, 0, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #ffd700;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-command-center">
    <div class="container-fluid">
        <!-- Phi-3 Enhanced Header -->
        <div class="row py-4">
            <div class="col-12">
                <div class="quantum-card phi3-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-3">
                                <i class="fas fa-microchip me-3" style="color: #ffd700;"></i>
                                Phi-3 Enhanced AI Command Center
                                <span class="badge" style="background: linear-gradient(45deg, #ffd700, #ff8c00);">Phi-3</span>
                            </h1>
                            <p class="lead mb-0">
                                Microsoft Phi-3 Mini • Traditional ML Fusion • Ultra-Advanced Predictive Analytics
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="phi3-status-indicator"></div>
                            <span>{% if ai_insights.phi3_available %}Phi-3 Online{% else %}Phi-3 Offline{% endif %}</span>
                            <br>
                            {% if ai_insights.analysis_engines %}
                            <small class="opacity-75">Active Engines: {{ ai_insights.analysis_engines.total_engines }}/3</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced AI Metrics with Phi-3 Integration -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value">{{ ai_insights.items_analyzed or ai_insights.total_items or 0 }}</div>
                    <div class="ai-metric-label">Items Analyzed</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value text-{{ 'danger' if ai_insights.total_alerts > 5 else 'warning' if ai_insights.total_alerts > 0 else 'success' }}">{{ ai_insights.total_alerts or 0 }}</div>
                    <div class="ai-metric-label">Combined Alerts</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value phi3-metric-value">{{ ai_insights.prediction_accuracy or 85.0 }}%</div>
                    <div class="ai-metric-label">Hybrid Accuracy</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value">{{ ai_insights.low_stock_warnings or 0 }}</div>
                    <div class="ai-metric-label">Stock Warnings</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value">{{ ai_insights.recipe_conflicts or 0 }}</div>
                    <div class="ai-metric-label">Recipe Conflicts</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="quantum-card ai-metric">
                    <div class="ai-metric-value phi3-metric-value">
                        <i class="fas fa-{{ 'brain' if ai_insights.phi3_available else 'exclamation-triangle' }}"></i>
                    </div>
                    <div class="ai-metric-label">Phi-3 Status</div>
                </div>
            </div>
        </div>

        <!-- Phi-3 Insights Section -->
        {% if ai_insights.phi3_insights %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="phi3-card">
                    <h4><i class="fas fa-lightbulb me-2" style="color: #ffd700;"></i>Phi-3 AI Insights</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>LLM Predictions</h6>
                            {% if ai_insights.phi3_insights.insights %}
                                {% for insight in ai_insights.phi3_insights.insights %}
                                <div class="alert alert-info bg-transparent border-warning text-white mb-2">
                                    <i class="fas fa-brain me-2 text-warning"></i>{{ insight }}
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6>Smart Recommendations</h6>
                            {% if ai_insights.phi3_recommendations %}
                                {% for rec in ai_insights.phi3_recommendations %}
                                <div class="alert alert-success bg-transparent border-success text-white mb-2">
                                    <i class="fas fa-check-circle me-2"></i>{{ rec }}
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% if ai_insights.phi3_insights.confidence %}
                    <div class="mt-3">
                        <small>Phi-3 Confidence: <strong>{{ (ai_insights.phi3_insights.confidence * 100)|round(1) }}%</strong></small>
                        <div class="progress" style="height: 8px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar" style="background: #ffd700; width: {{ (ai_insights.phi3_insights.confidence * 100)|round(1) }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Main Dashboard Row -->
        <div class="row">
            <!-- Phi-3 Terminal -->
            <div class="col-md-4">
                <div class="phi3-card">
                    <h5><i class="fas fa-microchip me-2" style="color: #ffd700;"></i>Phi-3 LLM Console</h5>
                    <div class="phi3-terminal" id="phi3-terminal">
                        <div class="terminal-line">
                            <span style="color: #ff8c00;">[PHI3]</span> Microsoft Phi-3 Mini initialized
                        </div>
                        <div class="terminal-line">
                            {% if ai_insights.phi3_available %}
                            <span style="color: #32cd32;">[OK]</span> LLM model loaded (3.8B parameters)
                            {% else %}
                            <span style="color: #ff6b6b;">[ERROR]</span> Phi-3 model not available
                            {% endif %}
                        </div>
                        {% if ai_insights.analysis_engines %}
                        <div class="terminal-line">
                            <span style="color: #4ecdc4;">[HYBRID]</span> ML Engine: {{ 'Online' if ai_insights.analysis_engines.ml_engine else 'Offline' }}
                        </div>
                        <div class="terminal-line">
                            <span style="color: #4ecdc4;">[HYBRID]</span> Quantum: {{ 'Active' if ai_insights.analysis_engines.quantum_optimizer else 'Inactive' }}
                        </div>
                        <div class="terminal-line">
                            <span style="color: #ffd700;">[PHI3]</span> LLM: {{ 'Ready' if ai_insights.analysis_engines.phi3_llm else 'Loading' }}
                        </div>
                        {% endif %}
                        {% if ai_insights.phi3_insights and ai_insights.phi3_insights.timestamp %}
                        <div class="terminal-line">
                            <span style="color: #ffd700;">[ANALYSIS]</span> Last Phi-3 analysis: {{ ai_insights.phi3_insights.timestamp.strftime('%H:%M:%S') }}
                        </div>
                        {% endif %}
                        <div class="terminal-line">
                            <span style="color: #ffd700;">phi3@homegrubhub:~$</span> <span class="cursor">_</span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="phi3-button btn-sm me-2" onclick="startPhi3Training()">
                            <i class="fas fa-graduation-cap me-1"></i>Train Phi-3
                        </button>
                        <button class="phi3-button btn-sm" onclick="runPhi3Analysis()">
                            <i class="fas fa-brain me-1"></i>Analyze
                        </button>
                    </div>
                </div>

                <!-- Model Comparison -->
                <div class="phi3-card mt-3">
                    <h6><i class="fas fa-balance-scale me-2"></i>AI Engine Comparison</h6>
                    <div class="row">
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1.2rem; color: #4ecdc4;">ML</div>
                            <small>Traditional</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1.2rem; color: #ff6b6b;">QM</div>
                            <small>Quantum</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1.2rem; color: #ffd700;">Φ3</div>
                            <small>Phi-3 LLM</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Predictions -->
            <div class="col-md-4">
                <div class="quantum-card">
                    <h5><i class="fas fa-chart-line me-2"></i>Hybrid AI Predictions</h5>
                    <canvas id="hybrid-chart" width="400" height="300"></canvas>
                    <div class="mt-3">
                        <button class="quantum-button btn-sm me-2" onclick="updateHybridPredictions()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh All
                        </button>
                        <button class="phi3-button btn-sm" onclick="getSmartShopping()">
                            <i class="fas fa-shopping-cart me-1"></i>Smart Shopping
                        </button>
                    </div>
                </div>

                <!-- Combined Recommendations -->
                <div class="quantum-card mt-3">
                    <h6><i class="fas fa-robot me-2"></i>Unified AI Recommendations</h6>
                    <div id="unified-recommendations">
                        {% if ai_insights.warnings %}
                            {% for warning in ai_insights.warnings[:3] %}
                            <div class="alert alert-warning bg-transparent border-warning text-white mb-2">
                                <i class="fas fa-{{ 'brain' if warning.source == 'Phi3_LLM' else 'cog' }} me-2"></i>
                                <small>{{ warning.item }} - {{ warning.source }}</small>
                            </div>
                            {% endfor %}
                        {% endif %}
                        {% if ai_insights.phi3_recommendations %}
                            {% for rec in ai_insights.phi3_recommendations[:2] %}
                            <div class="alert alert-info bg-transparent border-info text-white mb-2">
                                <i class="fas fa-lightbulb me-2 text-warning"></i>
                                <small>{{ rec }}</small>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Enhanced Analysis -->
            <div class="col-md-4">
                <div class="quantum-card">
                    <h5><i class="fas fa-microscope me-2"></i>Deep Analysis Results</h5>
                    
                    {% if ai_insights.ai_predictions %}
                    <div class="table-responsive" style="max-height: 200px;">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Days Left</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pred in ai_insights.ai_predictions[:8] %}
                                <tr>
                                    <td>{{ pred.item_name[:15] }}{% if pred.item_name|length > 15 %}...{% endif %}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if pred.predicted_days_remaining <= 1 else 'warning' if pred.predicted_days_remaining <= 3 else 'success' }}">
                                            {{ pred.predicted_days_remaining|round(1) }}
                                        </span>
                                    </td>
                                    <td><small>{{ pred.prediction_source }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center p-4">
                        <i class="fas fa-info-circle fa-3x opacity-50 mb-3"></i>
                        <p>No AI predictions available yet. Add items to your pantry to start getting AI insights.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- System Health -->
                <div class="quantum-card mt-3">
                    <h6><i class="fas fa-heartbeat me-2"></i>System Health</h6>
                    <div class="row">
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1rem;">{{ ai_insights.prediction_accuracy or 85 }}%</div>
                            <small>Accuracy</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1rem;">{{ ai_insights.total_items or 0 }}</div>
                            <small>Items</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="ai-metric-value" style="font-size: 1rem; color: {{ '#32cd32' if ai_insights.total_alerts == 0 else '#feca57' if ai_insights.total_alerts < 5 else '#ff6b6b' }};">
                                {{ ai_insights.total_alerts or 0 }}
                            </div>
                            <small>Alerts</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Handling -->
        {% if error %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> {{ error }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-body text-center p-4">
                <div class="loading-spinner mb-3"></div>
                <h5>Processing with Phi-3 AI</h5>
                <p class="mb-0" id="loading-message">Analyzing with hybrid intelligence...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
// Initialize hybrid prediction chart
function initializeHybridChart() {
    const ctx = document.getElementById('hybrid-chart').getContext('2d');
    
    // Generate sample data for different AI sources
    const labels = [];
    const mlData = [];
    const quantumData = [];
    const phi3Data = [];
    
    for (let i = 0; i < 14; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        labels.push(date.toLocaleDateString());
        mlData.push(Math.random() * 8 + 2);
        quantumData.push(Math.random() * 8 + 2);
        phi3Data.push(Math.random() * 8 + 2);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'ML Predictions',
                    data: mlData,
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Quantum AI',
                    data: quantumData,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Phi-3 LLM',
                    data: phi3Data,
                    borderColor: '#ffd700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// Phi-3 specific functions
function startPhi3Training() {
    showLoading('Starting Phi-3 model training...');
    addPhi3TerminalLine('[PHI3] Initiating personalized training...');
    
    fetch('/pro/enhanced/api/phi3-training')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addPhi3TerminalLine('[SUCCESS] Training completed');
                addPhi3TerminalLine('[INFO] Training samples: ' + data.training_samples);
            } else {
                addPhi3TerminalLine('[ERROR] Training failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            addPhi3TerminalLine('[ERROR] Network error: ' + error.message);
        });
}

function runPhi3Analysis() {
    showLoading('Running Phi-3 analysis...');
    addPhi3TerminalLine('[PHI3] Analyzing pantry with LLM...');
    
    fetch('/pro/enhanced/api/phi3-analysis')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addPhi3TerminalLine('[ANALYSIS] ' + data.insights.length + ' insights generated');
                addPhi3TerminalLine('[CONFIDENCE] ' + (data.confidence * 100).toFixed(1) + '%');
                updatePhi3Recommendations(data.recommendations);
            } else {
                addPhi3TerminalLine('[ERROR] Analysis failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            addPhi3TerminalLine('[ERROR] Analysis error: ' + error.message);
        });
}

function getSmartShopping() {
    showLoading('Getting Phi-3 shopping suggestions...');
    
    fetch('/pro/enhanced/api/smart-shopping-phi3')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addPhi3TerminalLine('[SHOPPING] Generated ' + data.suggestions.length + ' suggestions');
                displayShoppingSuggestions(data.suggestions);
            } else {
                addPhi3TerminalLine('[ERROR] Shopping analysis failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            addPhi3TerminalLine('[ERROR] Shopping error: ' + error.message);
        });
}

function updateHybridPredictions() {
    showLoading('Updating all AI predictions...');
    addPhi3TerminalLine('[HYBRID] Refreshing all AI engines...');
    
    // Simulate hybrid analysis
    setTimeout(() => {
        hideLoading();
        addPhi3TerminalLine('[ML] Traditional models updated');
        addPhi3TerminalLine('[QUANTUM] Optimization complete');
        addPhi3TerminalLine('[PHI3] LLM analysis refreshed');
        addPhi3TerminalLine('[SUCCESS] All engines synchronized');
    }, 3000);
}

// Terminal functions for Phi-3
function addPhi3TerminalLine(text) {
    const terminal = document.getElementById('phi3-terminal');
    const line = document.createElement('div');
    line.className = 'terminal-line';
    line.innerHTML = '<span style="color: #ff8c00;">[' + new Date().toLocaleTimeString() + ']</span> ' + text;
    terminal.insertBefore(line, terminal.lastElementChild);
    terminal.scrollTop = terminal.scrollHeight;
    
    // Keep only last 15 lines
    const lines = terminal.querySelectorAll('.terminal-line');
    if (lines.length > 16) {
        lines[0].remove();
    }
}

function updatePhi3Recommendations(recommendations) {
    const container = document.getElementById('unified-recommendations');
    recommendations.forEach(rec => {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success bg-transparent border-success text-white mb-2';
        alert.innerHTML = '<i class="fas fa-brain me-2 text-warning"></i><small>' + rec + '</small>';
        container.appendChild(alert);
    });
}

function displayShoppingSuggestions(suggestions) {
    // Create a temporary modal or notification for shopping suggestions
    const suggestionText = suggestions.join('\n• ');
    addPhi3TerminalLine('[SUGGESTIONS] • ' + suggestions.slice(0, 3).join(' • '));
}

// Utility functions
function showLoading(message = 'Processing...') {
    const modal = document.getElementById('loadingModal');
    document.getElementById('loading-message').textContent = message;
    new bootstrap.Modal(modal).show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeHybridChart();
    
    // Add some initial terminal activity
    setTimeout(() => addPhi3TerminalLine('[PHI3] Ready for advanced analysis'), 1000);
    {% if ai_insights.phi3_available %}
    setTimeout(() => addPhi3TerminalLine('[STATUS] All AI engines operational'), 2000);
    {% else %}
    setTimeout(() => addPhi3TerminalLine('[WARNING] Install Phi-3 dependencies for full features'), 2000);
    {% endif %}
});
</script>
{% endblock %}
