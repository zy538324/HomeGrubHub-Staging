{% extends "base.html" %}

{% block page_styles %}
<style>
.pantry-dashboard {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border-radius: 15px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.pantry-item-card {
  border-radius: 12px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.pantry-item-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.stock-indicator {
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
}

.stock-indicator.out-of-stock { background: #dc3545; }
.stock-indicator.low-stock { background: #ffc107; }
.stock-indicator.adequate { background: #17a2b8; }
.stock-indicator.well-stocked { background: #28a745; }

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.quantity-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s ease;
}

.category-tab {
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  margin: 0.25rem;
}

.category-tab.active {
  background: var(--bs-primary);
  color: white;
}

.category-tab:hover {
  background: var(--bs-light);
}

.alert-badge {
  position: relative;
}

.alert-badge::after {
  content: attr(data-count);
  position: absolute;
  top: -8px;
  right: -8px;
  background: #dc3545;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.expiry-warning {
  background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: bold;
}

.quick-actions {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 1000;
}

.floating-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: none;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  margin-bottom: 1rem;
  transition: all 0.3s ease;
}

.floating-btn:hover {
  transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  
  <!-- Dashboard Overview -->
  <div class="pantry-dashboard">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="display-4 mb-0">
          <i class="fas fa-warehouse me-3"></i>My Pantry
        </h1>
        <p class="lead mb-0">Smart inventory management for your kitchen</p>
      </div>
      <div class="col-md-4 text-end">
        <div class="row">
          <div class="col-6">
            <div class="stat-card">
              <h3 class="mb-1">{{ total_items }}</h3>
              <small>Total Items</small>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-card">
              <h3 class="mb-1">Â£{{ "%.2f"|format(total_value) }}</h3>
              <small>Total Value</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alert Summary -->
  {% if low_stock_items or expiring_soon_items or out_of_stock_items %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-warning d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
        <div class="flex-grow-1">
          <strong>Pantry Alerts:</strong>
          {% if out_of_stock_items %}
            <span class="badge bg-danger mx-1">{{ out_of_stock_items|length }} Out of Stock</span>
          {% endif %}
          {% if low_stock_items %}
            <span class="badge bg-warning mx-1">{{ low_stock_items|length }} Low Stock</span>
          {% endif %}
          {% if expiring_soon_items %}
            <span class="badge bg-info mx-1">{{ expiring_soon_items|length }} Expiring Soon</span>
          {% endif %}
        </div>
        <a href="{{ url_for('pantry.generate_shopping_list') }}" class="btn btn-warning btn-sm">
          <i class="fas fa-shopping-cart me-1"></i>Generate Shopping List
        </a>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Category Filters -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-wrap align-items-center">
        <h5 class="me-3 mb-0">Filter by Category:</h5>
        <div class="category-tab active" data-category="all">
          <i class="fas fa-th-large me-2"></i>All Items
        </div>
        {% for category in categories %}
        <div class="category-tab" data-category="{{ category.id }}" style="color: {{ category.color }};">
          <i class="{{ category.icon }} me-2"></i>{{ category.name }}
        </div>
        {% endfor %}
        <div class="category-tab" data-category="uncategorized">
          <i class="fas fa-question-circle me-2"></i>Uncategorized
        </div>
      </div>
    </div>
  </div>
  
  <!-- Pantry Items Grid -->
  <div class="row" id="pantryItemsGrid">
    {% for item in pantry_items %}
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4 pantry-item" 
         data-category="{{ item.category.id if item.category else 'uncategorized' }}"
         data-stock-status="{{ item.stock_status }}">
      <div class="card pantry-item-card h-100">
        <div class="stock-indicator {{ item.stock_status }}"></div>
        
        <div class="card-header d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="card-title mb-1 fw-bold">{{ item.name }}</h6>
            {% if item.brand %}
            <small class="text-muted">{{ item.brand }}</small>
            {% endif %}
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-link text-muted" data-bs-toggle="dropdown">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('pantry.edit_item', id=item.id) }}">
                <i class="fas fa-edit me-2"></i>Edit Item
              </a></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteItem({{ item.id }})">
                <i class="fas fa-trash me-2"></i>Delete Item
              </a></li>
            </ul>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Quantity Display -->
          <div class="row mb-3">
            <div class="col-8">
              <div class="d-flex align-items-center">
                <span class="fs-4 fw-bold me-2" id="quantity-{{ item.id }}">{{ item.current_quantity }}</span>
                <span class="text-muted">{{ item.unit }}</span>
              </div>
              <small class="text-muted">
                Min: {{ item.minimum_quantity }} | Ideal: {{ item.ideal_quantity }}
              </small>
            </div>
            <div class="col-4">
              <!-- Stock Status Badge -->
              {% if item.stock_status == 'out_of_stock' %}
                <span class="badge bg-danger">Out of Stock</span>
              {% elif item.stock_status == 'low_stock' %}
                <span class="badge bg-warning">Low Stock</span>
              {% elif item.stock_status == 'well_stocked' %}
                <span class="badge bg-success">Well Stocked</span>
              {% else %}
                <span class="badge bg-info">Adequate</span>
              {% endif %}
            </div>
          </div>
          
          <!-- Quick Quantity Controls -->
          <div class="quantity-controls mb-3">
            <button class="quantity-btn btn btn-outline-danger" onclick="updateQuantity({{ item.id }}, 1, 'subtract')">
              <i class="fas fa-minus"></i>
            </button>
            <input type="number" class="form-control form-control-sm text-center" 
                   style="width: 80px;" value="{{ item.current_quantity }}" 
                   onchange="updateQuantity({{ item.id }}, this.value, 'set')" min="0" step="0.1">
            <button class="quantity-btn btn btn-outline-success" onclick="updateQuantity({{ item.id }}, 1, 'add')">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          
          <!-- Additional Info -->
          <div class="row text-center">
            {% if item.category %}
            <div class="col-6">
              <small class="text-muted d-block">Category</small>
              <span class="badge" style="background-color: {{ item.category.color }}; color: white;">
                <i class="{{ item.category.icon }} me-1"></i>{{ item.category.name }}
              </span>
            </div>
            {% endif %}
            
            {% if item.storage_location %}
            <div class="col-6">
              <small class="text-muted d-block">Location</small>
              <small class="fw-bold">{{ item.storage_location }}</small>
            </div>
            {% endif %}
          </div>
          
          <!-- Expiry Warning -->
          {% if item.is_expiring_soon %}
          <div class="mt-2">
            <div class="expiry-warning text-center">
              <i class="fas fa-clock me-1"></i>
              {% if item.days_until_expiry > 0 %}
                Expires in {{ item.days_until_expiry }} days
              {% else %}
                Expired {{ item.days_until_expiry|abs }} days ago
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Cost Info -->
          {% if item.cost_per_unit %}
          <div class="mt-2 text-center">
            <small class="text-muted">
              Â£{{ "%.2f"|format(item.cost_per_unit) }}/{{ item.unit }}
              {% if item.total_cost %}
                | Total: Â£{{ "%.2f"|format(item.total_cost) }}
              {% endif %}
            </small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
    
    <!-- Empty State -->
    {% if not pantry_items %}
    <div class="col-12">
      <div class="text-center py-5">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h3 class="text-muted">Your pantry is empty</h3>
        <p class="text-muted">Start adding items to track your inventory</p>
        <a href="{{ url_for('pantry.add_item') }}" class="btn btn-primary btn-lg">
          <i class="fas fa-plus me-2"></i>Add Your First Item
        </a>
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Recent Activity -->
  {% if recent_logs %}
  <div class="row mt-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>Recent Activity
          </h5>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            {% for log in recent_logs[:5] %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ log.item.name if log.item else 'Unknown Item' }}</strong>
                <span class="text-muted">
                  {% if log.quantity_change > 0 %}
                    <i class="fas fa-plus text-success me-1"></i>Added {{ log.quantity_change }}
                  {% else %}
                    <i class="fas fa-minus text-danger me-1"></i>Used {{ log.quantity_change|abs }}
                  {% endif %}
                  {{ log.item.unit if log.item else 'units' }}
                </span>
                <small class="text-muted d-block">{{ log.reason.replace('_', ' ').title() }}</small>
              </div>
              <small class="text-muted">{{ log.timestamp.strftime('%m/%d %H:%M') }}</small>
            </div>
            {% endfor %}
          </div>
          <div class="text-center mt-3">
            <a href="{{ url_for('pantry.analytics') }}" class="btn btn-outline-primary btn-sm">
              View Full Analytics
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Quick Actions Floating Buttons -->
<div class="quick-actions">
  <a href="{{ url_for('pantry.shopping_list') }}" class="floating-btn btn btn-warning" title="Shopping List">
    <i class="fas fa-shopping-cart"></i>
  </a>
  <a href="{{ url_for('pantry.add_item') }}" class="floating-btn btn btn-primary" title="Add Item">
    <i class="fas fa-plus"></i>
  </a>
</div>

<!-- Quick Add Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddForm">
          <div class="mb-3">
            <label for="quickItemName" class="form-label">Item Name</label>
            <input type="text" class="form-control" id="quickItemName" required>
          </div>
          <div class="row">
            <div class="col-8">
              <label for="quickQuantity" class="form-label">Quantity</label>
              <input type="number" class="form-control" id="quickQuantity" value="1" min="0" step="0.1" required>
            </div>
            <div class="col-4">
              <label for="quickUnit" class="form-label">Unit</label>
              <select class="form-select" id="quickUnit">
                <option value="units">Units</option>
                <option value="kg">Kg</option>
                <option value="g">Grams</option>
                <option value="L">Liters</option>
                <option value="ml">mL</option>
                <option value="pieces">Pieces</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="quickAddItem()">Add Item</button>
      </div>
    </div>
  </div>
</div>

<script>
// Category filtering
document.querySelectorAll('.category-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const category = this.dataset.category;
        const items = document.querySelectorAll('.pantry-item');
        
        items.forEach(item => {
            if (category === 'all' || item.dataset.category === category) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
});

// Update quantity function
function updateQuantity(itemId, amount, operation) {
    fetch(`/pantry/update_quantity/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            amount: parseFloat(amount),
            operation: operation,
            reason: 'manual_adjustment'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update quantity display
            document.getElementById(`quantity-${itemId}`).textContent = data.new_quantity;
            
            // Update input value
            const input = document.querySelector(`input[onchange*="${itemId}"]`);
            if (input) input.value = data.new_quantity;
            
            // Show success toast
            showToast('success', data.message);
            
            // Refresh page if stock status changed significantly
            if (data.is_low_stock || data.new_quantity <= 0) {
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            showToast('error', data.error);
        }
    })
    .catch(error => {
        showToast('error', 'Error updating quantity');
        console.error('Error:', error);
    });
}

// Quick add item function
function quickAddItem() {
    const name = document.getElementById('quickItemName').value;
    const quantity = document.getElementById('quickQuantity').value;
    const unit = document.getElementById('quickUnit').value;
    
    if (!name || !quantity) {
        showToast('error', 'Please fill in all fields');
        return;
    }
    
    fetch('/pantry/quick_add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            name: name,
            quantity: parseFloat(quantity),
            unit: unit
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', data.error);
        }
    })
    .catch(error => {
        showToast('error', 'Error adding item');
        console.error('Error:', error);
    });
}

// Delete item function
function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item from your pantry?')) {
        fetch(`/pantry/delete_item/${itemId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
            }
        })
        .then(() => {
            location.reload();
        })
        .catch(error => {
            showToast('error', 'Error deleting item');
            console.error('Error:', error);
        });
    }
}

// Toast notification function
function showToast(type, message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Quick add modal trigger
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        new bootstrap.Modal(document.getElementById('quickAddModal')).show();
    }
});
</script>
{% endblock %}
