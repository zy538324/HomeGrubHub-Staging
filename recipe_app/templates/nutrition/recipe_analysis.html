<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recipe Nutritional Analysis</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation for Home+ tier features -->
    <nav style="background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <a href="/nutrition/recipe-search" style="margin-right: 15px;">üìù Recipe Search</a>
        <a href="/nutrition/smart-shopping-list" style="margin-right: 15px;">üõí Smart Shopping List</a>
        <a href="/nutrition/recipe-analysis" style="margin-right: 15px; font-weight: bold; color: #007bff;">üìä Recipe Analysis</a>
        <a href="/nutrition/enhanced-progress" style="margin-right: 15px;">üìà Progress Dashboard</a>
        <a href="/nutrition/weekly-calendar" style="margin-right: 15px;">üìÖ Weekly Calendar</a>
        <a href="/nutrition/barcode-scanner" style="margin-right: 15px;">üì± Barcode Scanner</a>
    </nav>

    <h1>üìä Recipe Nutritional Analysis</h1>
    <p><em>Home+ Tier Feature: Get detailed nutritional breakdowns of your recipes!</em></p>
    
    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Analyze Recipe</h3>
            <form method="POST" action="/nutrition/analyze-recipe">
                <label for="recipe_text">Recipe Ingredients:</label><br>
                <textarea name="recipe_text" id="recipe_text" rows="8" cols="50" 
                         placeholder="Enter recipe ingredients, one per line:
2 cups flour
1 cup sugar  
3 eggs
1/2 cup butter
1 tsp vanilla
...">{{ recipe_text or '' }}</textarea><br><br>
                
                <label for="servings">Number of servings:</label>
                <input type="number" name="servings" id="servings" value="{{ servings or 4 }}" min="1" max="20"><br><br>
                
                <button type="submit">üìä Analyze Nutrition</button>
            </form>
            
            {% if saved_recipes %}
            <h4>Or analyze a saved recipe:</h4>
            <form method="POST" action="/nutrition/analyze-saved-recipe">
                <select name="recipe_id">
                    {% for recipe in saved_recipes %}
                    <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Analyze Saved Recipe</button>
            </form>
            {% endif %}
        </div>
        
        <div style="flex: 2;">
            {% if analysis %}
            <h3>Nutritional Analysis Results</h3>
            <div style="border: 1px solid #ddd; padding: 20px; border-radius: 5px; background: #f9f9f9;">
                <h4>{{ analysis.recipe_name or 'Custom Recipe' }}</h4>
                <p><strong>Servings:</strong> {{ analysis.servings }}</p>
                
                <!-- Macro breakdown -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h5>Per Serving</h5>
                        <ul style="list-style: none; padding: 0;">
                            <li><strong>Calories:</strong> {{ analysis.per_serving.calories }} kcal</li>
                            <li><strong>Protein:</strong> {{ analysis.per_serving.protein }}g</li>
                            <li><strong>Carbs:</strong> {{ analysis.per_serving.carbs }}g</li>
                            <li><strong>Fat:</strong> {{ analysis.per_serving.fat }}g</li>
                            <li><strong>Fiber:</strong> {{ analysis.per_serving.fiber }}g</li>
                            <li><strong>Sugar:</strong> {{ analysis.per_serving.sugar }}g</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5>Total Recipe</h5>
                        <ul style="list-style: none; padding: 0;">
                            <li><strong>Calories:</strong> {{ analysis.total.calories }} kcal</li>
                            <li><strong>Protein:</strong> {{ analysis.total.protein }}g</li>
                            <li><strong>Carbs:</strong> {{ analysis.total.carbs }}g</li>
                            <li><strong>Fat:</strong> {{ analysis.total.fat }}g</li>
                            <li><strong>Fiber:</strong> {{ analysis.total.fiber }}g</li>
                            <li><strong>Sugar:</strong> {{ analysis.total.sugar }}g</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Macronutrient pie chart -->
                <div style="width: 400px; height: 400px; margin: 20px auto;">
                    <canvas id="macroChart"></canvas>
                </div>
                
                <!-- Key micronutrients -->
                <h5>Key Micronutrients (per serving)</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
                    {% for nutrient, value in analysis.micronutrients.items() %}
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; text-align: center;">
                        <strong>{{ nutrient }}</strong><br>
                        {{ value.amount }}{{ value.unit }}<br>
                        <small>({{ value.daily_value }}% DV)</small>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Health score and recommendations -->
                <div style="background: #f0f8f0; padding: 15px; border-radius: 5px; border-left: 4px solid #4caf50; margin: 20px 0;">
                    <h5>Health Score: {{ analysis.health_score }}/10</h5>
                    <p>{{ analysis.health_feedback }}</p>
                    
                    {% if analysis.recommendations %}
                    <h6>Recommendations:</h6>
                    <ul>
                        {% for rec in analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                
                <!-- Save analysis -->
                <form method="POST" action="/nutrition/save-recipe-analysis" style="margin-top: 20px;">
                    <input type="hidden" name="analysis_data" value="{{ analysis_json }}">
                    <button type="submit">üíæ Save Analysis</button>
                </form>
            </div>
            
            <script>
            // Create macronutrient pie chart
            const ctx = document.getElementById('macroChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Protein ({{ analysis.per_serving.protein }}g)', 
                             'Carbs ({{ analysis.per_serving.carbs }}g)', 
                             'Fat ({{ analysis.per_serving.fat }}g)'],
                    datasets: [{
                        data: [{{ analysis.per_serving.protein * 4 }}, 
                               {{ analysis.per_serving.carbs * 4 }}, 
                               {{ analysis.per_serving.fat * 9 }}],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                        hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Macronutrient Distribution (Calories)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            </script>
            {% else %}
            <div style="padding: 40px; text-align: center; color: #666;">
                <h3>üçΩÔ∏è No Analysis Yet</h3>
                <p>Enter recipe ingredients on the left to get a detailed nutritional analysis!</p>
                <p><em>Analysis includes macros, micronutrients, health scoring, and personalized recommendations.</em></p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent analyses -->
    {% if recent_analyses %}
    <div style="margin-top: 30px;">
        <h3>Recent Analyses</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            {% for analysis in recent_analyses %}
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f9f9f9;">
                <h5>{{ analysis.recipe_name }}</h5>
                <p><strong>{{ analysis.calories_per_serving }} cal/serving</strong></p>
                <p>Health Score: <strong>{{ analysis.health_score }}/10</strong></p>
                <p style="font-size: 0.9em; color: #666;">{{ analysis.created_at.strftime('%Y-%m-%d') }}</p>
                <form method="POST" action="/nutrition/load-analysis" style="display: inline;">
                    <input type="hidden" name="analysis_id" value="{{ analysis.id }}">
                    <button type="submit">üìä View Details</button>
                </form>
                <form method="POST" action="/nutrition/delete-analysis" style="display: inline; margin-left: 5px;">
                    <input type="hidden" name="analysis_id" value="{{ analysis.id }}">
                    <button type="submit" onclick="return confirm('Delete analysis?')">üóëÔ∏è</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</body>
</html>
