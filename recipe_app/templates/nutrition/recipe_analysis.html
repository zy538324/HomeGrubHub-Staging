{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <nav class="mb-4">
    <a href="/nutrition/recipe-search" class="me-3">📝 Recipe Search</a>
    <a href="/nutrition/smart-shopping-list" class="me-3">🛒 Smart Shopping List</a>
    <a href="/nutrition/recipe-analysis" class="me-3 fw-bold text-primary">📊 Recipe Analysis</a>
    <a href="/nutrition/enhanced-progress" class="me-3">📈 Progress Dashboard</a>
    <a href="/nutrition/weekly-calendar" class="me-3">📅 Weekly Calendar</a>
    <a href="/nutrition/barcode-scanner" class="me-3">📱 Barcode Scanner</a>
  </nav>

  <h1>📊 Recipe Nutritional Analysis</h1>
  <p><em>Home+ Tier Feature: Get detailed nutritional breakdowns of your recipes!</em></p>

  <div class="row g-4">
    <div class="col-md-4">
      <h3>Analyze Recipe</h3>
      <form method="POST" action="/nutrition/analyze-recipe" class="mb-3">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          <label for="recipe_text" class="form-label">Recipe Ingredients:</label>
          <textarea name="recipe_text" id="recipe_text" rows="8" class="form-control" placeholder="Enter recipe ingredients, one per line:\n2 cups flour\n1 cup sugar\n3 eggs\n1/2 cup butter\n1 tsp vanilla\n...">{{ recipe_text or '' }}</textarea>
        </div>
        <div class="mb-3">
          <label for="servings" class="form-label">Number of servings:</label>
          <input type="number" name="servings" id="servings" value="{{ servings or 4 }}" min="1" max="20" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary">📊 Analyze Nutrition</button>
      </form>

      {% if saved_recipes %}
      <h4>Or analyze a saved recipe:</h4>
      <form method="POST" action="/nutrition/analyze-saved-recipe" class="mb-3">
        {{ form.hidden_tag() }}
        <select name="recipe_id" class="form-select mb-2">
          {% for recipe in saved_recipes %}
          <option value="{{ recipe.id }}">{{ recipe.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-secondary">Analyze Saved Recipe</button>
      </form>
      {% endif %}
    </div>

    <div class="col-md-8">
      {% if analysis %}
      <h3>Nutritional Analysis Results</h3>
      <div class="border p-3 rounded bg-light">
        <h4>{{ analysis.recipe_name or 'Custom Recipe' }}</h4>
        <p><strong>Servings:</strong> {{ analysis.servings }}</p>

        <div class="row">
          <div class="col-md-6">
            <h5>Per Serving</h5>
            <ul class="list-unstyled">
              <li><strong>Calories:</strong> {{ analysis.per_serving.calories }} kcal</li>
              <li><strong>Protein:</strong> {{ analysis.per_serving.protein }}g</li>
              <li><strong>Carbs:</strong> {{ analysis.per_serving.carbs }}g</li>
              <li><strong>Fat:</strong> {{ analysis.per_serving.fat }}g</li>
              <li><strong>Fiber:</strong> {{ analysis.per_serving.fiber }}g</li>
              <li><strong>Sugar:</strong> {{ analysis.per_serving.sugar }}g</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h5>Total Recipe</h5>
            <ul class="list-unstyled">
              <li><strong>Calories:</strong> {{ analysis.total.calories }} kcal</li>
              <li><strong>Protein:</strong> {{ analysis.total.protein }}g</li>
              <li><strong>Carbs:</strong> {{ analysis.total.carbs }}g</li>
              <li><strong>Fat:</strong> {{ analysis.total.fat }}g</li>
              <li><strong>Fiber:</strong> {{ analysis.total.fiber }}g</li>
              <li><strong>Sugar:</strong> {{ analysis.total.sugar }}g</li>
            </ul>
          </div>
        </div>

        <div class="my-4">
          <canvas id="macroChart"></canvas>
        </div>

        <h5>Key Micronutrients (per serving)</h5>
        <div class="row row-cols-auto g-2 mb-3">
          {% for nutrient, value in analysis.micronutrients.items() %}
          <div class="col text-center bg-info-subtle p-2 rounded">
            <strong>{{ nutrient }}</strong><br>
            {{ value.amount }}{{ value.unit }}<br>
            <small>({{ value.daily_value }}% DV)</small>
          </div>
          {% endfor %}
        </div>

        <div class="alert alert-success">
          <h5>Health Score: {{ analysis.health_score }}/10</h5>
          <p>{{ analysis.health_feedback }}</p>
          {% if analysis.recommendations %}
          <h6>Recommendations:</h6>
          <ul>
            {% for rec in analysis.recommendations %}
            <li>{{ rec }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        <form method="POST" action="/nutrition/save-recipe-analysis" class="mt-3">
          {{ form.hidden_tag() }}
          <input type="hidden" name="analysis_data" value="{{ analysis_json }}">
          <button type="submit" class="btn btn-success">💾 Save Analysis</button>
        </form>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
      const ctx = document.getElementById('macroChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Protein ({{ analysis.per_serving.protein }}g)', 'Carbs ({{ analysis.per_serving.carbs }}g)', 'Fat ({{ analysis.per_serving.fat }}g)'],
          datasets: [{
            data: [{{ analysis.per_serving.protein * 4 }}, {{ analysis.per_serving.carbs * 4 }}, {{ analysis.per_serving.fat * 9 }}],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
            hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });
      </script>
      {% else %}
      <div class="text-center text-muted p-5">
        <h3>🍽️ No Analysis Yet</h3>
        <p>Enter recipe ingredients on the left to get a detailed nutritional analysis!</p>
        <p><em>Analysis includes macros, micronutrients, health scoring, and personalized recommendations.</em></p>
      </div>
      {% endif %}
    </div>
  </div>

  {% if recent_analyses %}
  <div class="mt-4">
    <h3>Recent Analyses</h3>
    <div class="row g-3">
      {% for analysis in recent_analyses %}
      <div class="col-md-4">
        <div class="border p-3 rounded bg-light">
          <h5>{{ analysis.recipe_name }}</h5>
          <p><strong>{{ analysis.calories_per_serving }} cal/serving</strong></p>
          <p>Health Score: <strong>{{ analysis.health_score }}/10</strong></p>
          <p class="text-muted">{{ analysis.created_at.strftime('%Y-%m-%d') }}</p>
          <form method="POST" action="/nutrition/load-analysis" class="d-inline">
            {{ form.hidden_tag() }}
            <input type="hidden" name="analysis_id" value="{{ analysis.id }}">
            <button type="submit" class="btn btn-primary btn-sm">📊 View Details</button>
          </form>
          <form method="POST" action="/nutrition/delete-analysis" class="d-inline ms-2">
            {{ form.hidden_tag() }}
            <input type="hidden" name="analysis_id" value="{{ analysis.id }}">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete analysis?')">🗑️</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
