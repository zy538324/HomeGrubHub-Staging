{% extends "base.html" %}

{% block title %}Nutrition Tracker - HomeGrubHub{% endblock %}

 {% block page_styles %}
<style>
    /* Advanced Nutrition Tracker Styles */
/* This file contains comprehensive styling for the nutrition tracking system */

:root {
    /* Nutrition Color Palette */
    --nutrition-primary: #27ae60;
    --nutrition-secondary: #2ecc71;
    --nutrition-accent: #3498db;
    --nutrition-warning: #f39c12;
    --nutrition-danger: #e74c3c;
    --nutrition-purple: #9b59b6;
    --nutrition-dark: #2c3e50;
    --nutrition-light: #ecf0f1;
    --nutrition-gray: #95a5a6;
    --nutrition-white: #ffffff;
    
    /* Macro Colors */
    --calories-color: #e74c3c;
    --protein-color: #3498db;
    --carbs-color: #f39c12;
    --fat-color: #9b59b6;
    --fiber-color: #27ae60;
    --sugar-color: #e67e22;
    --sodium-color: #34495e;
    
    /* Gradient Definitions */
    --gradient-green: linear-gradient(135deg, var(--nutrition-primary) 0%, var(--nutrition-secondary) 100%);
    --gradient-blue: linear-gradient(135deg, var(--nutrition-accent) 0%, #2980b9 100%);
    --gradient-orange: linear-gradient(135deg, var(--nutrition-warning) 0%, #e67e22 100%);
    --gradient-red: linear-gradient(135deg, var(--nutrition-danger) 0%, #c0392b 100%);
    --gradient-purple: linear-gradient(135deg, var(--nutrition-purple) 0%, #8e44ad 100%);
    --gradient-dark: linear-gradient(135deg, var(--nutrition-dark) 0%, #34495e 100%);
    
    /* Spacing */
    --spacing-xs: 0.5rem;
    --spacing-sm: 1rem;
    --spacing-md: 1.5rem;
    --spacing-lg: 2rem;
    --spacing-xl: 3rem;
    
    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 15px;
    --radius-lg: 20px;
    --radius-xl: 25px;
    --radius-full: 50px;
    
    /* Shadows */
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
    --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
    --shadow-2xl: 0 25px 50px rgba(0,0,0,0.25);

    /* Transitions */
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;

    /* Dark Theme Variables */
    --nutrition-bg-dark: #121212;
    --nutrition-card-dark: #1e1e1e;
    --nutrition-text-light: #f5f5f5;
}

/* Base Nutrition Styles */
.nutrition-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: var(--spacing-lg) 0;
}

/* Card Components */
.nutrition-card {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    box-shadow: var(--shadow-lg);
    border: none;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.nutrition-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-green);
}

.nutrition-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.nutrition-card.macro-card {
    text-align: center;
    border-top: 5px solid;
}

.nutrition-card.macro-card.calories {
    border-top-color: var(--calories-color);
}

.nutrition-card.macro-card.protein {
    border-top-color: var(--protein-color);
}

.nutrition-card.macro-card.carbs {
    border-top-color: var(--carbs-color);
}

.nutrition-card.macro-card.fat {
    border-top-color: var(--fat-color);
}

/* Hero Section */
.nutrition-hero {
    background: var(--gradient-green);
    color: var(--nutrition-white);
    padding: var(--spacing-xl) 0;
    border-radius: var(--radius-xl);
    margin-bottom: var(--spacing-xl);
    position: relative;
    overflow: hidden;
}

.nutrition-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
    opacity: 0.1;
}

.nutrition-hero h1 {
    font-weight: 700;
    margin-bottom: var(--spacing-md);
}

.nutrition-hero p {
    font-size: 1.125rem;
    opacity: 0.9;
    margin-bottom: var(--spacing-lg);
}

/* Button Styles */
.btn-nutrition {
    background: var(--gradient-green);
    border: none;
    color: var(--nutrition-white);
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-xl);
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    transition: all var(--transition-normal);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.btn-nutrition::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
}

.btn-nutrition:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
    color: var(--nutrition-white);
    text-decoration: none;
}

.btn-nutrition:hover::before {
    left: 100%;
}

.btn-nutrition.btn-scan {
    background: var(--gradient-green);
}

.btn-nutrition.btn-goals {
    background: var(--gradient-blue);
}

.btn-nutrition.btn-report {
    background: var(--gradient-orange);
}

/* Progress Bars */
.nutrition-progress {
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--nutrition-light);
    overflow: hidden;
    margin: var(--spacing-sm) 0;
    position: relative;
}

.nutrition-progress-bar {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width var(--transition-slow);
    position: relative;
    background: var(--gradient-green);
}

.nutrition-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.nutrition-progress-bar.calories {
    background: var(--gradient-red);
}

.nutrition-progress-bar.protein {
    background: var(--gradient-blue);
}

.nutrition-progress-bar.carbs {
    background: var(--gradient-orange);
}

.nutrition-progress-bar.fat {
    background: var(--gradient-purple);
}

/* Macro Value Display */
.macro-value {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
    color: var(--nutrition-dark);
    line-height: 1;
}

.macro-label {
    font-size: 0.875rem;
    color: var(--nutrition-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--spacing-sm);
    font-weight: 600;
}

.macro-goal {
    font-size: 0.875rem;
    color: var(--nutrition-gray);
    margin-top: var(--spacing-xs);
}

/* Circular Progress */
.circular-progress {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    width: 80px;
    height: 80px;
}

.circular-progress svg {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
}

.circular-progress-circle {
    fill: none;
    stroke-width: 6;
    stroke-linecap: round;
    transition: stroke-dasharray var(--transition-slow);
}

.circular-progress-bg {
    stroke: var(--nutrition-light);
}

/* Meal Sections */
.meal-section {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
}

.meal-section:hover {
    box-shadow: var(--shadow-xl);
}

.meal-header {
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--gradient-dark);
    color: var(--nutrition-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.meal-header h5 {
    margin: 0;
    font-weight: 600;
}

.meal-body {
    padding: var(--spacing-lg);
    min-height: 120px;
}

.meal-entry {
    background: #f8f9fa;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    border-left: 4px solid var(--nutrition-primary);
    transition: all var(--transition-normal);
    cursor: pointer;
}

.meal-entry:hover {
    background: #e9ecef;
    transform: translateX(10px);
    border-left-color: var(--nutrition-secondary);
}

.entry-name {
    font-weight: 600;
    color: var(--nutrition-dark);
    margin-bottom: var(--spacing-xs);
}

.entry-nutrition {
    display: flex;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--nutrition-gray);
    flex-wrap: wrap;
}

.nutrition-badge {
    background: var(--nutrition-white);
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-xl);
    font-weight: 500;
    font-size: 0.8rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--nutrition-light);
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.stat-item {
    background: var(--nutrition-white);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    text-align: center;
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-normal);
    border-top: 3px solid var(--nutrition-primary);
}

.stat-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
    color: var(--nutrition-primary);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
    color: var(--nutrition-dark);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--nutrition-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 500;
}

/* Charts */
.chart-container {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
}

.chart-container h5 {
    color: var(--nutrition-dark);
    margin-bottom: var(--spacing-md);
    font-weight: 600;
}

/* Date Navigation */
.date-nav {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.date-nav-btn {
    background: var(--nutrition-light);
    border: none;
    color: var(--nutrition-dark);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 500;
    transition: all var(--transition-normal);
}

.date-nav-btn:hover {
    background: var(--nutrition-primary);
    color: var(--nutrition-white);
    transform: translateY(-2px);
}

/* Quick Actions */
.quick-actions {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
}

.quick-actions h5 {
    color: var(--nutrition-dark);
    margin-bottom: var(--spacing-md);
    font-weight: 600;
}

.action-btn {
    background: var(--gradient-green);
    color: var(--nutrition-white);
    border: none;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-md);
    margin: var(--spacing-xs);
    font-weight: 600;
    transition: all var(--transition-normal);
    box-shadow: var(--shadow-md);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
    color: var(--nutrition-white);
    text-decoration: none;
}

/* Empty States */
.empty-meal {
    text-align: center;
    color: var(--nutrition-gray);
    padding: var(--spacing-xl);
}

.empty-meal i {
    font-size: 3rem;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

.empty-meal p {
    margin-bottom: var(--spacing-md);
    font-size: 1.1rem;
}

/* Modal Enhancements */
.modal-content {
    border-radius: var(--radius-lg);
    border: none;
    box-shadow: var(--shadow-2xl);
}

.modal-header {
    background: var(--gradient-green);
    color: var(--nutrition-white);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    border-bottom: none;
    padding: var(--spacing-md) var(--spacing-lg);
}

.modal-body {
    padding: var(--spacing-lg);
}

.form-control {
    border-radius: var(--radius-md);
    border: 2px solid var(--nutrition-light);
    padding: var(--spacing-sm) var(--spacing-md);
    transition: all var(--transition-normal);
    font-size: 0.95rem;
}

.form-control:focus {
    border-color: var(--nutrition-primary);
    box-shadow: 0 0 0 0.2rem rgba(39, 174, 96, 0.25);
}

.form-label {
    font-weight: 600;
    color: var(--nutrition-dark);
    margin-bottom: var(--spacing-xs);
}

/* Tables */
.nutrition-table {
    background: var(--nutrition-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin-bottom: var(--spacing-lg);
}

.table-header {
    background: var(--gradient-dark);
    color: var(--nutrition-white);
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: 1.2rem;
    font-weight: 600;
}

.nutrition-table table {
    width: 100%;
    margin: 0;
}

.nutrition-table th {
    background: #f8f9fa;
    padding: var(--spacing-md);
    font-weight: 600;
    color: var(--nutrition-dark);
    border: none;
    text-align: center;
}

.nutrition-table td {
    padding: var(--spacing-md);
    border: none;
    text-align: center;
    border-bottom: 1px solid var(--nutrition-light);
    vertical-align: middle;
}

.nutrition-table tbody tr:hover {
    background: #f8f9fa;
    transform: scale(1.01);
    transition: all var(--transition-normal);
}

.date-link {
    color: var(--nutrition-accent);
    text-decoration: none;
    font-weight: 600;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-lg);
    transition: all var(--transition-normal);
    display: inline-block;
}

.date-link:hover {
    background: var(--nutrition-accent);
    color: var(--nutrition-white);
    text-decoration: none;
    transform: translateY(-2px);
}

/* Badges */
.macro-badge {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    font-weight: 600;
    margin: 0.2rem;
    color: var(--nutrition-white);
}

.macro-badge.calories { 
    background: var(--gradient-red); 
}

.macro-badge.protein { 
    background: var(--gradient-blue); 
}

.macro-badge.carbs { 
    background: var(--gradient-orange); 
}

.macro-badge.fat { 
    background: var(--gradient-purple); 
}

.meal-count {
    background: var(--gradient-green);
    color: var(--nutrition-white);
    border-radius: var(--radius-full);
    width: 40px;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
}

/* Animations */
.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in-left {
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from { transform: translateX(-100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.bounce-in {
    animation: bounceIn 0.8s ease-out;
}

@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Responsive Design */
@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    
    .macro-value {
        font-size: 2.5rem;
    }
}

@media (max-width: 768px) {
    .nutrition-hero {
        padding: var(--spacing-lg) 0;
    }
    
    .nutrition-card {
        padding: var(--spacing-md);
    }
    
    .macro-value {
        font-size: 2rem;
    }
    
    .circular-progress {
        display: none;
    }
    
    .date-nav {
        flex-direction: column;
        gap: var(--spacing-md);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .meal-header {
        padding: var(--spacing-sm) var(--spacing-md);
    }
    
    .meal-body {
        padding: var(--spacing-md);
    }
    
    .entry-nutrition {
        flex-direction: column;
        gap: var(--spacing-xs);
    }
    
    .action-btn {
        display: block;
        width: 100%;
        margin-bottom: var(--spacing-xs);
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .macro-value {
        font-size: 1.8rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .quick-actions {
        padding: var(--spacing-md);
    }
    
    .nutrition-hero {
        padding: var(--spacing-md) 0;
    }
    
    .nutrition-hero h1 {
        font-size: 2rem;
    }
}

/* Dark Mode Support */
body.dark-mode {
    --nutrition-white: var(--nutrition-card-dark);
    --nutrition-light: #2d2d2d;
    --nutrition-dark: var(--nutrition-text-light);
    --nutrition-gray: #b0b0b0;
    background: var(--nutrition-bg-dark);
    color: var(--nutrition-text-light);
}

body.dark-mode .nutrition-container {
    background: var(--nutrition-bg-dark);
}

body.dark-mode .nutrition-card {
    background: var(--nutrition-card-dark);
    color: var(--nutrition-text-light);
}

body.dark-mode .form-control {
    background: #2d2d2d;
    border-color: #404040;
    color: var(--nutrition-text-light);
}

body.dark-mode .meal-entry {
    background: #2d2d2d;
    color: var(--nutrition-text-light);
}

body.dark-mode .meal-entry:hover {
    background: #3d3d3d;
}

/* Print Styles */
@media print {
    .nutrition-hero,
    .quick-actions,
    .action-btn,
    .btn-nutrition {
        display: none;
    }
    
    .nutrition-card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Focus Styles for Accessibility */
.btn-nutrition:focus,
.action-btn:focus,
.date-nav-btn:focus {
    outline: 3px solid rgba(39, 174, 96, 0.5);
    outline-offset: 2px;
}

.form-control:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.25);
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .nutrition-card {
        border: 2px solid #333;
    }
    
    .btn-nutrition,
    .action-btn {
        border: 2px solid currentColor;
    }
    
    .macro-badge {
        border: 1px solid #333;
    }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .pulse,
    .shimmer {
        animation: none;
    }
}

/* Summary Carousel */
.summary-carousel {
    display: flex;
    gap: var(--spacing-sm);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: var(--spacing-sm);
}

.summary-card {
    flex: 0 0 80%;
    scroll-snap-align: start;
}

@media (min-width: 576px) {
    .summary-card {
        flex: 0 0 45%;
    }
}

@media (min-width: 768px) {
    .summary-carousel {
        flex-wrap: wrap;
        overflow-x: visible;
    }
    .summary-card {
        flex: 0 0 calc(25% - var(--spacing-sm));
    }
}

</style>
{% endblock %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-chart-line"></i> Nutrition Tracker</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showAddEntryModal()">
                        <i class="fas fa-plus"></i> Add Entry
                    </button>
                    <a href="{{ url_for('scanner_upload.barcode_scanner_page') }}" class="btn btn-success">
                        <i class="fas fa-barcode"></i> Scan Barcode
                    </a>
                    <a href="/weekly-shopping/" class="btn btn-info">
                        <i class="fas fa-calendar-week"></i> Weekly Shopping
                    </a>
                    <button class="btn btn-outline-secondary" onclick="showGoalsModal()">
                        <i class="fas fa-cog"></i> Goals
                    </button>
                    <button id="theme-toggle" class="btn btn-outline-secondary">
                        <i class="fas fa-adjust"></i> Toggle Theme
                    </button>
                </div>
            </div>
        </div>
    </div>
     <!-- Weight and Fitness Tracking -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-weight"></i> Weight Tracker</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showWeightLogModal()">
                        <i class="fas fa-plus"></i> Log Weight
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="weightChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-dumbbell"></i> Recent Workouts</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showWorkoutLogModal()">
                        <i class="fas fa-plus"></i> Log Workout
                    </button>
                </div>
                <div class="card-body" id="recent-workouts">
                    <!-- Recent workouts will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Today's Summary Cards -->
    <div class="summary-carousel mb-4">
        <div class="summary-card card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="calories-consumed">{{ daily_summary.total_calories|round(0)|int if daily_summary else 0 }}</h4>
                        <p class="mb-0">Calories</p>
                        <small>Goal: {{ goals.daily_calories|round(0)|int }}</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-fire fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set calories_percent = ((daily_summary.total_calories / goals.daily_calories) * 100) if daily_summary and goals.daily_calories > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [calories_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="protein-consumed">{{ daily_summary.total_protein|round(1) if daily_summary else 0 }}g</h4>
                        <p class="mb-0">Protein</p>
                        <small>Goal: {{ goals.daily_protein|round(0)|int }}g</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dumbbell fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set protein_percent = ((daily_summary.total_protein / goals.daily_protein) * 100) if daily_summary and goals.daily_protein > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [protein_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="carbs-consumed">{{ daily_summary.total_carbs|round(1) if daily_summary else 0 }}g</h4>
                        <p class="mb-0">Carbs</p>
                        <small>Goal: {{ goals.daily_carbs|round(0)|int }}g</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bread-slice fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set carbs_percent = ((daily_summary.total_carbs / goals.daily_carbs) * 100) if daily_summary and goals.daily_carbs > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [carbs_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="fat-consumed">{{ daily_summary.total_fat|round(1) if daily_summary else 0 }}g</h4>
                        <p class="mb-0">Fat</p>
                        <small>Goal: {{ goals.daily_fat|round(0)|int }}g</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cheese fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set fat_percent = ((daily_summary.total_fat / goals.daily_fat) * 100) if daily_summary and goals.daily_fat > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [fat_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="fiber-consumed">{{ daily_summary.total_fiber|round(1) if daily_summary else 0 }}g</h4>
                        <p class="mb-0">Fiber</p>
                        <small>Goal: {{ goals.daily_fiber|round(0)|int }}g</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-seedling fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set fiber_percent = ((daily_summary.total_fiber / goals.daily_fiber) * 100) if daily_summary and goals.daily_fiber > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [fiber_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="sugar-consumed">{{ daily_summary.total_sugar|round(1) if daily_summary else 0 }}g</h4>
                        <p class="mb-0">Sugar</p>
                        <small>Goal: {{ goals.daily_sugar|round(0)|int }}g</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-candy-cane fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set sugar_percent = ((daily_summary.total_sugar / goals.daily_sugar) * 100) if daily_summary and goals.daily_sugar > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [sugar_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-dark text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="sodium-consumed">{{ daily_summary.total_sodium|round(0)|int if daily_summary else 0 }}mg</h4>
                        <p class="mb-0">Sodium</p>
                        <small>Goal: {{ goals.daily_sodium|round(0)|int }}mg</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tint fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set sodium_percent = ((daily_summary.total_sodium / goals.daily_sodium) * 100) if daily_summary and goals.daily_sodium > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [sodium_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="water-consumed">{{ water_total|int }}</h4>
                        <p class="mb-0">Water (ml)</p>
                        <small>Goal: 2000ml</small>
                    </div>
                    <div class="align-self-center">
                        <button class="btn btn-sm btn-outline-light" onclick="showWaterLogPrompt()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set water_percent = ((water_total / 2000) * 100) if water_total else 0 %}
                    <div class="progress-bar bg-white" id="water-progress" style="width: {{ [water_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="cholesterol-consumed">{{ daily_summary.total_cholesterol|round(0)|int if daily_summary else 0 }}mg</h4>
                        <p class="mb-0">Cholesterol</p>
                        <small>Goal: {{ goals.daily_cholesterol|round(0)|int }}mg</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-heart fa-2x"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    {% set chol_percent = ((daily_summary.total_cholesterol / goals.daily_cholesterol) * 100) if daily_summary and goals.daily_cholesterol > 0 else 0 %}
                    <div class="progress-bar bg-white" style="width: {{ [chol_percent, 100]|min }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-primary" onclick="changeDate(-1)">
                            <i class="fas fa-chevron-left"></i> Previous Day
                        </button>
                        <h5 id="current-date" class="mb-0">{{ today.strftime('%A, %B %d, %Y') }}</h5>
                        <button class="btn btn-outline-primary" onclick="changeDate(1)">
                            Next Day <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Sections -->
    <div class="row">
        <div class="col-md-6">
            <!-- Breakfast -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-sun"></i> Breakfast</h6>
                    <div>
                        <span id="breakfast-calories" class="badge badge-primary">
                            {{ daily_summary.breakfast_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-primary ml-2" onclick="showAddEntryModal('breakfast')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="breakfast-entries">
                    <!-- Breakfast entries will be loaded here -->
                </div>
            </div>

            <!-- Lunch -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-sun"></i> Lunch</h6>
                    <div>
                        <span id="lunch-calories" class="badge badge-success">
                            {{ daily_summary.lunch_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-success ml-2" onclick="showAddEntryModal('lunch')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="lunch-entries">
                    <!-- Lunch entries will be loaded here -->
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Dinner -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-moon"></i> Dinner</h6>
                    <div>
                        <span id="dinner-calories" class="badge badge-warning">
                            {{ daily_summary.dinner_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-warning ml-2" onclick="showAddEntryModal('dinner')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="dinner-entries">
                    <!-- Dinner entries will be loaded here -->
                </div>
            </div>

            <!-- Snacks -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-apple-alt"></i> Snacks</h6>
                    <div>
                        <span id="snack-calories" class="badge badge-info">
                            {{ daily_summary.snack_calories|round(0)|int if daily_summary else 0 }} cal
                        </span>
                        <button class="btn btn-sm btn-outline-info ml-2" onclick="showAddEntryModal('snack')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="snack-entries">
                    <!-- Snack entries will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Chart -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Weekly Overview</h6>
                </div>
                <div class="card-body">
                    <canvas id="weeklyChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Entry Modal -->
<div class="modal fade" id="addEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Nutrition Entry</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addEntryForm">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" class="form-control" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="brand">Brand (optional)</label>
                        <input type="text" class="form-control" id="brand">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="portion-size">Portion Size (g)</label>
                                <input type="number" class="form-control" id="portion-size" value="100" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="servings">Servings</label>
                                <input type="number" class="form-control" id="servings" value="1" min="0.1" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="meal-type">Meal Type</label>
                        <select class="form-control" id="meal-type" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    
                    <!-- Nutrition Information -->
                    <h6>Nutrition Information (per 100g)</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calories">Calories</label>
                                <input type="number" class="form-control" id="calories" min="0" step="0.1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="protein">Protein (g)</label>
                                <input type="number" class="form-control" id="protein" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="carbs">Carbs (g)</label>
                                <input type="number" class="form-control" id="carbs" min="0" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fat">Fat (g)</label>
                                <input type="number" class="form-control" id="fat" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fiber">Fiber (g)</label>
                                <input type="number" class="form-control" id="fiber" min="0" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sugar">Sugar (g)</label>
                                <input type="number" class="form-control" id="sugar" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sodium">Sodium (mg)</label>
                        <input type="number" class="form-control" id="sodium" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="cholesterol">Cholesterol (mg)</label>
                        <input type="number" class="form-control" id="cholesterol" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNutritionEntry()">Add Entry</button>
            </div>
        </div>
    </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nutrition Goals</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="goalsForm">
                    <h6>Daily Nutrition Goals</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-calories">Daily Calories</label>
                                <input type="number" class="form-control" id="daily-calories" value="{{ goals.daily_calories }}" min="1000" max="10000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-protein">Daily Protein (g)</label>
                                <input type="number" class="form-control" id="daily-protein" value="{{ goals.daily_protein }}" min="20" max="500">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-carbs">Daily Carbs (g)</label>
                                <input type="number" class="form-control" id="daily-carbs" value="{{ goals.daily_carbs }}" min="50" max="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-fat">Daily Fat (g)</label>
                                <input type="number" class="form-control" id="daily-fat" value="{{ goals.daily_fat }}" min="20" max="300">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-fiber">Daily Fiber (g)</label>
                                <input type="number" class="form-control" id="daily-fiber" value="{{ goals.daily_fiber }}" min="10" max="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-sugar">Daily Sugar (g)</label>
                                <input type="number" class="form-control" id="daily-sugar" value="{{ goals.daily_sugar }}" min="10" max="200">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-sodium">Max Sodium (mg)</label>
                                <input type="number" class="form-control" id="daily-sodium" value="{{ goals.daily_sodium }}" min="500" max="5000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="daily-cholesterol">Max Cholesterol (mg)</label>
                                <input type="number" class="form-control" id="daily-cholesterol" value="{{ goals.daily_cholesterol }}" min="0" max="1000">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateGoals()">Save Goals</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentDate = new Date('{{ today }}');
let weeklyChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTodaysEntries();
    loadWeeklyChart();
    initSummaryCarousel();
});

function initSummaryCarousel() {
    const container = document.querySelector('.summary-carousel');
    if (!container) return;

    let startX = 0;
    let scrollStart = 0;

    container.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        scrollStart = container.scrollLeft;
    });

    container.addEventListener('touchend', (e) => {
        const delta = startX - e.changedTouches[0].clientX;
        if (Math.abs(delta) > 50) {
            const card = container.querySelector('.summary-card');
            if (card) {
                const gap = parseInt(getComputedStyle(container).gap) || 16;
                const step = card.offsetWidth + gap;
                container.scrollTo({
                    left: scrollStart + (delta > 0 ? step : -step),
                    behavior: 'smooth'
                });
            }
        }
    });
}

// Change date and reload data
function changeDate(days) {
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
    loadEntriesForDate(currentDate);
}

// Update date display
function updateDateDisplay() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = currentDate.toLocaleDateString('en-US', options);
}

// Load today's entries
function loadTodaysEntries() {
    loadEntriesForDate(currentDate);
}

// Load entries for specific date
function loadEntriesForDate(date) {
    const dateStr = date.toISOString().split('T')[0];
    
    fetch(`/nutrition-entries/${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEntries(data.entries);
                updateSummaryForDate(dateStr);
            } else {
                console.error('Error loading entries:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading entries:', error);
        });
}

// Display entries in meal sections
function displayEntries(entries) {
    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
    
    mealTypes.forEach(mealType => {
        const container = document.getElementById(`${mealType}-entries`);
        const mealEntries = entries[mealType] || [];
        
        if (mealEntries.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No entries for this meal</p>';
        } else {
            container.innerHTML = mealEntries.map(entry => createEntryHTML(entry)).join('');
        }
    });
}

// Create HTML for entry
function createEntryHTML(entry) {
    return `
        <div class="nutrition-entry mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${entry.product_name}</strong>
                            ${entry.brand ? `<br><small class="text-muted">${entry.brand}</small>` : ''}
                            <br><small class="text-muted">${entry.portion_size}g × ${entry.servings} serving${entry.servings > 1 ? 's' : ''} = ${entry.total_weight}g total</small>
                            ${entry.notes ? `<br><small class="text-info"><i class="fas fa-sticky-note"></i> ${entry.notes}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleNutritionDetails(${entry.id})" title="Show/hide nutrition details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editEntry(${entry.id})" title="Edit entry">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${entry.id})" title="Delete entry">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main nutrition summary (always visible) -->
                    <div class="nutrition-summary">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h5 mb-0 text-primary">${Math.round(entry.calories || 0)}</div>
                                    <small class="text-muted">Calories</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-success">${(entry.protein || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Protein</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-warning">${(entry.carbs || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Carbs</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="nutrition-stat">
                                    <div class="h6 mb-0 text-info">${(entry.fat || 0).toFixed(1)}g</div>
                                    <small class="text-muted">Fat</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed nutrition (collapsible) -->
                    <div class="nutrition-details mt-2" id="details-${entry.id}" style="display: none;">
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1"><strong>Additional Nutrients:</strong></small>
                                ${entry.fiber ? `<small class="d-block">Fiber: <span class="float-end">${(entry.fiber).toFixed(1)}g</span></small>` : ''}
                                ${entry.sugar ? `<small class="d-block">Sugar: <span class="float-end">${(entry.sugar).toFixed(1)}g</span></small>` : ''}
                                ${entry.saturated_fat ? `<small class="d-block">Saturated Fat: <span class="float-end">${(entry.saturated_fat).toFixed(1)}g</span></small>` : ''}
                                ${entry.sodium ? `<small class="d-block">Sodium: <span class="float-end">${Math.round(entry.sodium)}mg</span></small>` : ''}
                                ${entry.cholesterol ? `<small class="d-block">Cholesterol: <span class="float-end">${Math.round(entry.cholesterol)}mg</span></small>` : ''}
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1"><strong>Entry Details:</strong></small>
                                <small class="d-block">Logged: <span class="float-end">${new Date(entry.entry_time).toLocaleTimeString()}</span></small>
                                <small class="d-block">Meal: <span class="float-end badge bg-secondary">${entry.meal_type}</span></small>
                                ${entry.barcode ? `<small class="d-block">Barcode: <span class="float-end">${entry.barcode}</span></small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Update summary for date
function updateSummaryForDate(dateStr) {
    fetch(`/nutrition-summary/${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSummaryDisplay(data.summary);
            }
        })
        .catch(error => {
            console.error('Error loading summary:', error);
        });
}

// Update summary display
function updateSummaryDisplay(summary) {
    document.getElementById('calories-consumed').textContent = Math.round(summary.total_calories || 0);
    document.getElementById('protein-consumed').textContent = (summary.total_protein || 0).toFixed(1) + 'g';
    document.getElementById('carbs-consumed').textContent = (summary.total_carbs || 0).toFixed(1) + 'g';
    document.getElementById('fat-consumed').textContent = (summary.total_fat || 0).toFixed(1) + 'g';
    
    // Update meal calories
    document.getElementById('breakfast-calories').textContent = Math.round(summary.breakfast_calories || 0) + ' cal';
    document.getElementById('lunch-calories').textContent = Math.round(summary.lunch_calories || 0) + ' cal';
    document.getElementById('dinner-calories').textContent = Math.round(summary.dinner_calories || 0) + ' cal';
    document.getElementById('snack-calories').textContent = Math.round(summary.snack_calories || 0) + ' cal';
}

// Toggle nutrition details visibility
function toggleNutritionDetails(entryId) {
    const detailsElement = document.getElementById(`details-${entryId}`);
    if (detailsElement) {
        if (detailsElement.style.display === 'none') {
            detailsElement.style.display = 'block';
        } else {
            detailsElement.style.display = 'none';
        }
    }
}

// Show add entry modal
function showAddEntryModal(mealType = 'snack') {
    document.getElementById('meal-type').value = mealType;
    $('#addEntryModal').modal('show');
}

// Add nutrition entry
function addNutritionEntry() {
    const formData = {
        product_name: document.getElementById('product-name').value,
        brand: document.getElementById('brand').value,
        portion_size: parseFloat(document.getElementById('portion-size').value),
        servings: parseFloat(document.getElementById('servings').value),
        meal_type: document.getElementById('meal-type').value,
        notes: document.getElementById('notes').value,
        nutrition: {
            calories: parseFloat(document.getElementById('calories').value) || 0,
            protein: parseFloat(document.getElementById('protein').value) || 0,
            carbs: parseFloat(document.getElementById('carbs').value) || 0,
            fat: parseFloat(document.getElementById('fat').value) || 0,
            fiber: parseFloat(document.getElementById('fiber').value) || 0,
            sugar: parseFloat(document.getElementById('sugar').value) || 0,
            sodium: parseFloat(document.getElementById('sodium').value) || 0,
            cholesterol: parseFloat(document.getElementById('cholesterol').value) || 0
        }
    };
    
    // Calculate actual nutrition based on portion size and servings
    const portionMultiplier = (formData.portion_size / 100) * formData.servings;
    Object.keys(formData.nutrition).forEach(key => {
        formData.nutrition[key] *= portionMultiplier;
    });
    
    fetch('/log-nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#addEntryModal').modal('hide');
            document.getElementById('addEntryForm').reset();
            loadEntriesForDate(currentDate);
            showNotification('Entry added successfully!', 'success');
        } else {
            showNotification('Error adding entry: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error adding entry:', error);
        showNotification('Error adding entry', 'error');
    });
}

// Delete entry
function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this entry?')) {
        fetch(`/delete-nutrition-entry/${entryId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadEntriesForDate(currentDate);
                showNotification('Entry deleted successfully!', 'success');
            } else {
                showNotification('Error deleting entry: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting entry:', error);
            showNotification('Error deleting entry', 'error');
        });
    }
}

// Show goals modal
function showGoalsModal() {
    $('#goalsModal').modal('show');
}

// Update goals
function updateGoals() {
    const formData = {
        daily_calories: parseFloat(document.getElementById('daily-calories').value),
        daily_protein: parseFloat(document.getElementById('daily-protein').value),
        daily_carbs: parseFloat(document.getElementById('daily-carbs').value),
        daily_fat: parseFloat(document.getElementById('daily-fat').value),
        daily_fiber: parseFloat(document.getElementById('daily-fiber').value),
        daily_sugar: parseFloat(document.getElementById('daily-sugar').value),
        daily_sodium: parseFloat(document.getElementById('daily-sodium').value),
        daily_cholesterol: parseFloat(document.getElementById('daily-cholesterol').value)
    };
    
    fetch('/nutrition-goals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#goalsModal').modal('hide');
            location.reload(); // Reload to update progress bars
            showNotification('Goals updated successfully!', 'success');
        } else {
            showNotification('Error updating goals: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating goals:', error);
        showNotification('Error updating goals', 'error');
    });
}

// Load weekly chart
function loadWeeklyChart() {
    fetch('/weekly-summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createWeeklyChart(data.summaries, data.averages);
            }
        })
        .catch(error => {
            console.error('Error loading weekly chart:', error);
        });
}

// Create weekly chart
function createWeeklyChart(summaries, averages) {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    if (weeklyChart) {
        weeklyChart.destroy();
    }
    
    const labels = summaries.map(s => new Date(s.summary_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
    const caloriesData = summaries.map(s => s.total_calories);
    const proteinData = summaries.map(s => s.total_protein);
    const carbsData = summaries.map(s => s.total_carbs);
    const fatData = summaries.map(s => s.total_fat);
    
    weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Calories',
                data: caloriesData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: 'Protein (g)',
                data: proteinData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }, {
                label: 'Carbs (g)',
                data: carbsData,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                yAxisID: 'y1'
            }, {
                label: 'Fat (g)',
                data: fatData,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Calories'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Macros (g)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// CSRF token helper
function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]').getAttribute('content');
}

// Notification helper
function showNotification(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

<style>
.nutrition-entry {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.nutrition-entry:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.nutrition-stat {
    padding: 8px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.8);
    margin: 2px;
}

.nutrition-details {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    padding: 10px;
}

.float-end {
    float: right;
}

.meal-section .card-header {
    cursor: pointer;
}

.meal-section .card-header:hover {
    background: #e9ecef !important;
}
</style>
{% endblock %}
