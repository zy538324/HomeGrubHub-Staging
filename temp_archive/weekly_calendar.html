<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weekly Meal Planning Calendar</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        background: #ddd;
        border-radius: 5px;
        overflow: hidden;
    }
    .calendar-header {
        background: #4285f4;
        color: white;
        padding: 15px 5px;
        text-align: center;
        font-weight: bold;
    }
    .calendar-day {
        background: white;
        min-height: 200px;
        position: relative;
        border: 1px solid #eee;
    }
    .day-header {
        background: #f8f9fa;
        padding: 10px 5px;
        font-weight: bold;
        text-align: center;
        border-bottom: 1px solid #ddd;
        font-size: 0.9em;
    }
    .meal-slot {
        padding: 5px;
        margin: 2px;
        background: #f0f8ff;
        border-radius: 3px;
        font-size: 0.8em;
        border: 1px dashed #ccc;
        min-height: 35px;
        cursor: pointer;
        position: relative;
    }
    .meal-slot.has-meal {
        background: #e8f5e8;
        border: 1px solid #4caf50;
    }
    .meal-slot:hover {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    .meal-title {
        font-weight: bold;
        color: #333;
    }
    .meal-calories {
        color: #666;
        font-size: 0.7em;
    }
    .add-meal-btn {
        position: absolute;
        right: 2px;
        top: 2px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
    }
    .meal-actions {
        display: none;
        position: absolute;
        top: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
        z-index: 10;
    }
    .meal-slot:hover .meal-actions {
        display: block;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
    }
    </style>
</head>
<body>
    <!-- Navigation for Home+ tier features -->
    <nav style="background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <a href="/nutrition/recipe-search" style="margin-right: 15px;">📝 Recipe Search</a>
        <a href="/nutrition/smart-shopping-list" style="margin-right: 15px;">🛒 Smart Shopping List</a>
        <a href="/nutrition/recipe-analysis" style="margin-right: 15px;">📊 Recipe Analysis</a>
        <a href="/nutrition/enhanced-progress" style="margin-right: 15px;">📈 Progress Dashboard</a>
        <a href="/nutrition/weekly-calendar" style="margin-right: 15px; font-weight: bold; color: #007bff;">📅 Weekly Calendar</a>
        <a href="/nutrition/barcode-scanner" style="margin-right: 15px;">📱 Barcode Scanner</a>
    </nav>

    <h1>📅 Weekly Meal Planning Calendar</h1>
    <p><em>Home+ Tier Feature: Visual meal planning with drag-and-drop functionality!</em></p>
    
    <!-- Calendar Controls -->
    <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <button onclick="changeWeek(-1)" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-right: 10px;">← Previous Week</button>
            <span style="font-weight: bold; font-size: 1.1em;">{{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}</span>
            <button onclick="changeWeek(1)" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-left: 10px;">Next Week →</button>
        </div>
        <div>
            <button onclick="generateWeekMeals()" style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-right: 10px;">🤖 Auto-Generate Week</button>
            <button onclick="clearWeek()" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-right: 10px;">🗑️ Clear Week</button>
            <button onclick="exportWeek()" style="background: #6f42c1; color: white; padding: 8px 15px; border: none; border-radius: 5px;">📄 Export Week</button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <!-- Headers -->
        <div class="calendar-header">Meal Type</div>
        <div class="calendar-header">Monday</div>
        <div class="calendar-header">Tuesday</div>
        <div class="calendar-header">Wednesday</div>
        <div class="calendar-header">Thursday</div>
        <div class="calendar-header">Friday</div>
        <div class="calendar-header">Saturday</div>
        <div class="calendar-header">Sunday</div>

        <!-- Breakfast Row -->
        <div class="calendar-header" style="background: #ff9800;">🌅 Breakfast</div>
        {% for day in range(7) %}
        <div class="calendar-day">
            <div class="meal-slot" id="breakfast-{{ day }}" onclick="openMealModal('breakfast', {{ day }})">
                {% set meal = weekly_meals.get('breakfast', {}).get(day) %}
                {% if meal %}
                <div class="meal-title">{{ meal.name }}</div>
                <div class="meal-calories">{{ meal.calories }} cal</div>
                {% else %}
                <div style="text-align: center; color: #999; padding: 10px;">+ Add Breakfast</div>
                {% endif %}
                <button class="add-meal-btn" onclick="openMealModal('breakfast', {{ day }})">+</button>
            </div>
        </div>
        {% endfor %}

        <!-- Lunch Row -->
        <div class="calendar-header" style="background: #4caf50;">☀️ Lunch</div>
        {% for day in range(7) %}
        <div class="calendar-day">
            <div class="meal-slot" id="lunch-{{ day }}" onclick="openMealModal('lunch', {{ day }})">
                {% set meal = weekly_meals.get('lunch', {}).get(day) %}
                {% if meal %}
                <div class="meal-title">{{ meal.name }}</div>
                <div class="meal-calories">{{ meal.calories }} cal</div>
                {% else %}
                <div style="text-align: center; color: #999; padding: 10px;">+ Add Lunch</div>
                {% endif %}
                <button class="add-meal-btn" onclick="openMealModal('lunch', {{ day }})">+</button>
            </div>
        </div>
        {% endfor %}

        <!-- Dinner Row -->
        <div class="calendar-header" style="background: #2196f3;">🌙 Dinner</div>
        {% for day in range(7) %}
        <div class="calendar-day">
            <div class="meal-slot" id="dinner-{{ day }}" onclick="openMealModal('dinner', {{ day }})">
                {% set meal = weekly_meals.get('dinner', {}).get(day) %}
                {% if meal %}
                <div class="meal-title">{{ meal.name }}</div>
                <div class="meal-calories">{{ meal.calories }} cal</div>
                {% else %}
                <div style="text-align: center; color: #999; padding: 10px;">+ Add Dinner</div>
                {% endif %}
                <button class="add-meal-btn" onclick="openMealModal('dinner', {{ day }})">+</button>
            </div>
        </div>
        {% endfor %}

        <!-- Snack Row -->
        <div class="calendar-header" style="background: #9c27b0;">🍎 Snacks</div>
        {% for day in range(7) %}
        <div class="calendar-day">
            <div class="meal-slot" id="snack-{{ day }}" onclick="openMealModal('snack', {{ day }})">
                {% set meal = weekly_meals.get('snack', {}).get(day) %}
                {% if meal %}
                <div class="meal-title">{{ meal.name }}</div>
                <div class="meal-calories">{{ meal.calories }} cal</div>
                {% else %}
                <div style="text-align: center; color: #999; padding: 10px;">+ Add Snack</div>
                {% endif %}
                <button class="add-meal-btn" onclick="openMealModal('snack', {{ day }})">+</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Weekly Summary -->
    <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0; color: #ff6384;">📊 Total Meals</h3>
            <div style="font-size: 2em; font-weight: bold; margin: 10px 0;">{{ weekly_summary.total_meals }}</div>
            <div style="color: #666;">meals planned</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0; color: #36a2eb;">🔥 Avg Calories</h3>
            <div style="font-size: 2em; font-weight: bold; margin: 10px 0;">{{ weekly_summary.avg_calories }}</div>
            <div style="color: #666;">per day</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0; color: #4bc0c0;">🥗 Variety Score</h3>
            <div style="font-size: 2em; font-weight: bold; margin: 10px 0;">{{ weekly_summary.variety_score }}/10</div>
            <div style="color: #666;">meal diversity</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0; color: #9966ff;">📝 Completion</h3>
            <div style="font-size: 2em; font-weight: bold; margin: 10px 0;">{{ weekly_summary.completion }}%</div>
            <div style="color: #666;">week planned</div>
        </div>
    </div>

    <!-- Meal Selection Modal -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Add Meal</h3>
            <div style="margin-bottom: 15px;">
                <label for="mealSource">Choose meal source:</label>
                <select id="mealSource" onchange="updateMealOptions()">
                    <option value="saved">Saved Recipes</option>
                    <option value="recent">Recent Meals</option>
                    <option value="suggestions">AI Suggestions</option>
                    <option value="custom">Custom Entry</option>
                </select>
            </div>
            
            <div id="mealOptions">
                <!-- Dynamic content based on selection -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeMealModal()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; margin-right: 10px;">Cancel</button>
                <button onclick="addMealToCalendar()" style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 5px;">Add Meal</button>
            </div>
        </div>
    </div>

    <script>
    let currentMealType = '';
    let currentDay = 0;
    let currentWeekOffset = {{ week_offset or 0 }};

    function changeWeek(direction) {
        window.location.href = `/nutrition/weekly-calendar?week_offset=${currentWeekOffset + direction}`;
    }

    function openMealModal(mealType, day) {
        event.stopPropagation();
        currentMealType = mealType;
        currentDay = day;
        
        const modal = document.getElementById('mealModal');
        const title = document.getElementById('modalTitle');
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        title.textContent = `Add ${mealType.charAt(0).toUpperCase() + mealType.slice(1)} - ${days[day]}`;
        modal.style.display = 'block';
        updateMealOptions();
    }

    function closeMealModal() {
        document.getElementById('mealModal').style.display = 'none';
    }

    function updateMealOptions() {
        const source = document.getElementById('mealSource').value;
        const optionsDiv = document.getElementById('mealOptions');
        
        // Sample data - in production, fetch from backend
        const options = {
            saved: [
                {name: 'Chicken Stir Fry', calories: 450},
                {name: 'Greek Salad', calories: 320},
                {name: 'Salmon with Rice', calories: 520}
            ],
            recent: [
                {name: 'Yesterday\'s Pasta', calories: 380},
                {name: 'Morning Smoothie', calories: 250},
                {name: 'Tuna Sandwich', calories: 420}
            ],
            suggestions: [
                {name: 'AI Recommended Bowl', calories: 400},
                {name: 'Balanced Protein Meal', calories: 480},
                {name: 'Veggie Power Lunch', calories: 350}
            ]
        };
        
        if (source === 'custom') {
            optionsDiv.innerHTML = `
                <div>
                    <label for="customMealName">Meal Name:</label><br>
                    <input type="text" id="customMealName" style="width: 100%; padding: 8px; margin: 5px 0;"><br>
                    <label for="customCalories">Estimated Calories:</label><br>
                    <input type="number" id="customCalories" style="width: 100%; padding: 8px; margin: 5px 0;">
                </div>
            `;
        } else {
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            options[source].forEach((meal, index) => {
                html += `
                    <div onclick="selectMeal('${meal.name}', ${meal.calories})" 
                         style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; cursor: pointer; background: white;">
                        <strong>${meal.name}</strong><br>
                        <small>${meal.calories} calories</small>
                    </div>
                `;
            });
            html += '</div>';
            optionsDiv.innerHTML = html;
        }
    }

    function selectMeal(name, calories) {
        // Highlight selected meal
        document.querySelectorAll('#mealOptions > div > div').forEach(el => {
            el.style.background = 'white';
            el.style.borderColor = '#ddd';
        });
        event.currentTarget.style.background = '#e3f2fd';
        event.currentTarget.style.borderColor = '#2196f3';
        
        // Store selected meal data
        document.selectedMeal = {name, calories};
    }

    function addMealToCalendar() {
        let mealData;
        
        if (document.getElementById('mealSource').value === 'custom') {
            const name = document.getElementById('customMealName').value;
            const calories = document.getElementById('customCalories').value;
            if (!name || !calories) {
                alert('Please fill in all fields');
                return;
            }
            mealData = {name, calories: parseInt(calories)};
        } else {
            if (!document.selectedMeal) {
                alert('Please select a meal');
                return;
            }
            mealData = document.selectedMeal;
        }
        
        // Send to backend
        fetch('/nutrition/add-calendar-meal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                meal_type: currentMealType,
                day: currentDay,
                week_offset: currentWeekOffset,
                name: mealData.name,
                calories: mealData.calories
            })
        }).then(response => {
            if (response.ok) {
                // Update UI
                const slot = document.getElementById(`${currentMealType}-${currentDay}`);
                slot.innerHTML = `
                    <div class="meal-title">${mealData.name}</div>
                    <div class="meal-calories">${mealData.calories} cal</div>
                    <button class="add-meal-btn" onclick="openMealModal('${currentMealType}', ${currentDay})">+</button>
                `;
                slot.classList.add('has-meal');
                closeMealModal();
                location.reload(); // Refresh to update summary
            } else {
                alert('Error adding meal');
            }
        });
    }

    function generateWeekMeals() {
        if (confirm('This will replace all current meals for this week. Continue?')) {
            fetch('/nutrition/generate-week-meals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    week_offset: currentWeekOffset
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error generating meals');
                }
            });
        }
    }

    function clearWeek() {
        if (confirm('This will remove all meals for this week. Continue?')) {
            fetch('/nutrition/clear-week-meals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    week_offset: currentWeekOffset
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error clearing meals');
                }
            });
        }
    }

    function exportWeek() {
        window.open(`/nutrition/export-week-meals?week_offset=${currentWeekOffset}`, '_blank');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('mealModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
    </script>
</body>
</html>
