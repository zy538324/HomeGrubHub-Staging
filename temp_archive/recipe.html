{% extends "base.html" %}

{% block extra_styles %}
<style>
/* Star Rating Input Styles */
.star-rating-input {
    direction: rtl;
    unicode-bidi: bidi-override;
    text-align: center;
}

.star-rating-input input[type="radio"] {
    display: none;
}

.star-label {
    display: inline-block;
    cursor: pointer;
    color: #ddd;
    font-size: 2em;
    transition: color 0.2s;
    padding: 0 2px;
}

.star-label:hover,
.star-label:hover ~ .star-label {
    color: #ffc107;
}

.star-rating-input input[type="radio"]:checked ~ .star-label {
    color: #ffc107;
}

/* Circular Action Icons */
.recipe-action-icons {
    margin-top: 20px;
}

.action-icon-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
}

.action-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 1.5rem;
    cursor: pointer;
}

.action-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    color: white;
}

.action-icon:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
}

.action-label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    margin-top: 8px;
    text-align: center;
    font-size: 0.85rem;
}

.action-count {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.7);
    font-weight: normal;
    margin-top: 2px;
    display: block;
}

/* Special styling for favorited state */
.action-icon.favorited {
    background: rgba(220, 53, 69, 0.3);
    border-color: rgba(220, 53, 69, 0.5);
}

.action-icon.favorited:hover {
    background: rgba(220, 53, 69, 0.4);
    border-color: rgba(220, 53, 69, 0.6);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .action-icon {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
    }
    
    .action-label {
        font-size: 0.75rem;
    }
    
    .recipe-action-icons {
        gap: 1rem !important;
    }
}
</style>
{% endblock %}

{% block seo_title %}{{ recipe.title }} - Easy {{ recipe.cuisine_type or 'Homemade' }} Recipe | HomeGrubHub{% endblock %}

{% block seo_description %}{{ recipe.description[:150] if recipe.description else 'Delicious ' + recipe.title + ' recipe with step-by-step instructions' }}. Prep time: {{ recipe.prep_time or 'Quick' }} minutes. Serves {{ recipe.servings or 4 }}. Perfect for {{ recipe.cuisine_type or 'family dinners' }}.{% endblock %}

{% block seo_keywords %}{{ recipe.title|lower }}, {{ recipe.cuisine_type|lower if recipe.cuisine_type }} recipe, {{ recipe.country|lower if recipe.country }} food, {{ 'vegetarian' if 'vegetarian' in recipe.tags|map(attribute='name')|list }} recipe, {{ 'quick' if recipe.prep_time and recipe.prep_time|int < 30 else 'easy' }} dinner{% endblock %}

{% block og_title %}{{ recipe.title }} - {{ recipe.cuisine_type or 'Homemade' }} Recipe{% endblock %}
{% block og_description %}{{ recipe.description[:200] if recipe.description else 'Delicious ' + recipe.title + ' recipe with step-by-step instructions. Ready in ' + (recipe.prep_time + recipe.cook_time)|string + ' minutes.' }}{% endblock %}
{% block og_image %}{% if recipe.image_file %}{{ url_for('static', filename='uploads/' + recipe.image_file, _external=True) }}{% else %}{{ url_for('static', filename='images/default-recipe.jpg', _external=True) }}{% endif %}{% endblock %}
{% block og_type %}article{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Recipe",
  "name": "{{ recipe.title }}",
  "description": "{{ recipe.description|escape if recipe.description else 'Delicious ' + recipe.title + ' recipe with step-by-step instructions.' }}",
  "image": [
    {% if recipe.image_file %}
    "{{ url_for('static', filename='uploads/' + recipe.image_file, _external=True) }}"
    {% else %}
    "{{ url_for('static', filename='images/default-recipe.jpg', _external=True) }}"
    {% endif %}
  ],
  "author": {
    "@type": "Person",
    "name": "{{ recipe.user.username }}"
  },
  "datePublished": "{{ recipe.date_created.isoformat() if recipe.date_created }}",
  "dateModified": "{{ recipe.date_created.isoformat() if recipe.date_created }}",
  "prepTime": "PT{{ recipe.prep_time or 15 }}M",
  "cookTime": "PT{{ recipe.cook_time or 30 }}M",
  "totalTime": "PT{{ (recipe.prep_time or 15) + (recipe.cook_time or 30) }}M",
  "recipeYield": "{{ recipe.servings or 4 }} servings",
  "recipeCategory": "{{ recipe.cuisine_type or 'Main Course' }}",
  "recipeCuisine": "{{ recipe.country or 'International' }}",
  {% if recipe.difficulty %}
  "recipeSkillLevel": "{{ recipe.difficulty }}",
  {% endif %}
  "recipeIngredient": [
    {% set ingredients = recipe.ingredients.split('\n') if recipe.ingredients else [] %}
    {% for ingredient in ingredients %}
    "{{ ingredient.strip()|escape }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  "recipeInstructions": [
    {% set instructions = recipe.method.split('\n') if recipe.method else [] %}
    {% for instruction in instructions %}
    {
      "@type": "HowToStep",
      "text": "{{ instruction.strip()|escape }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  {% if recipe.tags %}
  "keywords": "{{ recipe.tags|map(attribute='name')|join(', ') }}",
  {% endif %}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ recipe.average_rating() or 4.5 }}",
    "reviewCount": "{{ recipe.reviews|length or 1 }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  "nutrition": {
    "@type": "NutritionInformation",
    "servingSize": "1 serving",
    "calories": "{{ recipe.calories or 'Not specified' }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "HomeGrubHub",
    "url": "{{ url_for('main.index', _external=True) }}",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ url_for('static', filename='images/logo.png', _external=True) }}"
    }
  }
}
</script>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Recipe Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="card-title mb-1 display-6">
                {{ recipe.title }}
                {% if recipe.is_private %}
                  {% if recipe.user.current_plan == 'Free' %}
                    <span class="badge bg-warning text-dark ms-2">
                      <i class="fas fa-shield-alt me-1"></i>Limited Access
                    </span>
                  {% else %}
                    <span class="badge bg-secondary ms-2">
                      <i class="fas fa-lock me-1"></i>Private
                    </span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-success ms-2">
                    <i class="fas fa-globe me-1"></i>Public
                  </span>
                {% endif %}
              </h1>
              {% if recipe.description %}
              <p class="card-text mb-0 opacity-75">{{ recipe.description }}</p>
              {% endif %}
            </div>
            <div class="col-md-4 text-md-end">
              <!-- Action Icons - Individual circular buttons -->
              <div class="recipe-action-icons d-flex justify-content-center flex-wrap gap-3 mt-3">
                <!-- Tools -->
                <div class="action-icon-wrapper">
                  <a href="{{ url_for('main.recipe_conversions', recipe_id=recipe.id) }}" class="action-icon" title="Recipe Tools & Conversions">
                    <i class="fas fa-calculator"></i>
                  </a>
                  <small class="action-label">Tools</small>
                </div>
                
                {% if current_user.is_authenticated %}
                <!-- Favorite -->
                <div class="action-icon-wrapper">
                  <button type="button" class="action-icon" id="favoriteBtn" 
                          data-recipe-id="{{ recipe.id }}" 
                          data-is-favorite="{{ 'true' if is_favorite else 'false' }}"
                          title="{{ 'Remove from Favorites' if is_favorite else 'Add to Favorites' }}">
                    <i class="fas fa-heart{% if not is_favorite %}-o{% endif %}"></i>
                  </button>
                  <small class="action-label">
                    {{ 'Favorited' if is_favorite else 'Favorite' }}
                    <div class="action-count">
                      <span id="favoriteCount">{{ recipe.favorited_by|length }}</span> total
                    </div>
                  </small>
                </div>
                
                <!-- Shopping List -->
                <div class="action-icon-wrapper">
                  <button type="button" class="action-icon" id="addToShoppingListBtn" title="Add to Shopping List">
                    <i class="fas fa-shopping-cart"></i>
                  </button>
                  <small class="action-label">Shopping List</small>
                </div>
                
                <!-- Meal Plan -->
                <div class="action-icon-wrapper">
                  <button type="button" class="action-icon" data-bs-toggle="modal" data-bs-target="#mealPlanModal" title="Add to Meal Plan">
                    <i class="fas fa-calendar-plus"></i>
                  </button>
                  <small class="action-label">Meal Plan</small>
                </div>
                {% endif %}
                
                {% if current_user.is_authenticated and (current_user.id == recipe.user_id or current_user.is_admin) %}
                <!-- Edit (Only for recipe creator/admin) -->
                <div class="action-icon-wrapper">
                  <a href="{{ url_for('main.edit_recipe', recipe_id=recipe.id) }}" class="action-icon" title="Edit Recipe">
                    <i class="fas fa-edit"></i>
                  </a>
                  <small class="action-label">Edit</small>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Recipe Image and Quick Info -->
    <div class="col-lg-4 mb-4">
      <!-- Recipe Image -->
      <div class="card shadow mb-4">
        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
          {% if recipe.image_file %}
          {% if recipe.image_file.startswith('imported_') %}
          <img src="{{ url_for('static', filename='uploads/imported_' + recipe.image_file[9:]) }}" 
               class="img-fluid rounded" style="max-height: 100%; max-width: 100%; object-fit: cover;" 
               alt="{{ recipe.title }}">
          {% else %}
          <img src="{{ url_for('static', filename='uploads/' + recipe.image_file) }}" 
               class="img-fluid rounded" style="max-height: 100%; max-width: 100%; object-fit: cover;" 
               alt="{{ recipe.title }}">
          {% endif %}
          {% else %}
          <div class="text-center text-muted">
            <i class="fas fa-utensils fa-4x mb-3"></i>
            <p class="mb-0">No image available</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Recipe Info Card -->
      <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>Recipe Info
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if recipe.prep_time %}
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-clock fa-2x text-primary mb-2 d-block"></i>
                <div class="fw-bold">{{ recipe.prep_time }} min</div>
                <small class="text-muted">Prep Time</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.cook_time %}
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-fire fa-2x text-danger mb-2 d-block"></i>
                <div class="fw-bold">{{ recipe.cook_time }} min</div>
                <small class="text-muted">Cook Time</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.servings %}
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-users fa-2x text-success mb-2 d-block"></i>
                <div class="fw-bold">{{ recipe.servings }}</div>
                <small class="text-muted">Servings</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.calories %}
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-fire fa-2x text-danger mb-2 d-block"></i>
                <div class="fw-bold">{{ recipe.calories }}</div>
                <small class="text-muted">Calories</small>
              </div>
            </div>
            {% endif %}

            {% if recipe.difficulty %}
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-chart-line fa-2x text-warning mb-2 d-block"></i>
                <div class="fw-bold">{{ recipe.difficulty }}</div>
                <small class="text-muted">Difficulty</small>
              </div>
            </div>
            {% endif %}
          </div>
          
          {% if recipe.total_time %}
          <hr>
          <div class="text-center">
            <div class="badge bg-primary fs-6 px-3 py-2">
              <i class="fas fa-stopwatch me-2"></i>Total Time: {{ recipe.total_time }} minutes
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Origin & Tags -->
      {% if recipe.country or recipe.cuisine_type or recipe.tags %}
      <div class="card shadow mb-4">
        <div class="card-header bg-secondary text-white">
          <h6 class="card-title mb-0">
            <i class="fas fa-tags me-2"></i>Details
          </h6>
        </div>
        <div class="card-body">
          {% if recipe.country %}
          <div class="mb-3">
            <strong class="text-muted d-block">Country of Origin</strong>
            <span class="badge bg-info fs-6">
              <i class="fas fa-flag me-1"></i>{{ recipe.country }}
            </span>
          </div>
          {% endif %}
          
          {% if recipe.cuisine_type %}
          <div class="mb-3">
            <strong class="text-muted d-block">Cuisine Type</strong>
            <span class="badge bg-success fs-6">
              <i class="fas fa-utensils me-1"></i>{{ recipe.cuisine_type }}
            </span>
          </div>
          {% endif %}
          
          {% if recipe.tags %}
          <div class="mb-0">
            <strong class="text-muted d-block mb-2">Tags</strong>
            {% for tag in recipe.tags %}
            <a href="{{ url_for('main.tag', tag_name=tag.name) }}" class="badge bg-outline-secondary text-decoration-none me-1 mb-1">
              #{{ tag.name }}
            </a>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Rating Section -->
      {% if avg_rating > 0 or current_user.is_authenticated %}
      <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark">
          <h6 class="card-title mb-0">
            <i class="fas fa-star me-2"></i>Rating
          </h6>
        </div>
        <div class="card-body text-center">
          {% if avg_rating > 0 %}
          <div class="mb-3">
            <div class="star-rating mb-2">
              {% for i in range(5) %}
              <i class="fas fa-star {{ 'text-warning' if i < avg_rating else 'text-muted' }}"></i>
              {% endfor %}
            </div>
            <div class="fw-bold">{{ "%.1f"|format(avg_rating) }}/5</div>
            <small class="text-muted">({{ rating_count }} review{{ 's' if rating_count != 1 else '' }})</small>
          </div>
          {% endif %}
          
          {% if current_user.is_authenticated %}
          <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#ratingModal">
            <i class="fas fa-star me-1"></i>Rate Recipe
          </button>
          {% endif %}
        </div>
      </div>
      {% endif %}
      
      <!-- Community Voting Section -->
      {% include 'community/voting_widget.html' %}
      
      <!-- Nutritional Information -->
      {% if recipe.nutrition_profile %}
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
          <h6 class="card-title mb-0">
            <i class="fas fa-apple-alt me-2"></i>Nutrition Facts
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if recipe.nutrition_profile.calories %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.calories|round|int }}</div>
                <small class="text-muted">Calories</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.nutrition_profile.protein_g %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.protein_g|round(1) }}g</div>
                <small class="text-muted">Protein</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.nutrition_profile.carbs_g %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.carbs_g|round(1) }}g</div>
                <small class="text-muted">Carbs</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.nutrition_profile.fat_g %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.fat_g|round(1) }}g</div>
                <small class="text-muted">Fat</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.nutrition_profile.fiber_g %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.fiber_g|round(1) }}g</div>
                <small class="text-muted">Fiber</small>
              </div>
            </div>
            {% endif %}
            
            {% if recipe.nutrition_profile.sodium_mg %}
            <div class="col-6">
              <div class="text-center">
                <div class="fw-bold fs-5">{{ recipe.nutrition_profile.sodium_mg|round|int }}mg</div>
                <small class="text-muted">Sodium</small>
              </div>
            </div>
            {% endif %}
          </div>
          
          {% if recipe.servings %}
          <hr>
          <div class="text-center">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Nutritional values are per serving ({{ recipe.servings }} servings total)
            </small>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Recipe Content -->
    <div class="col-lg-8">
      <!-- Ingredients Section -->
      <div class="recipe-card ingredients-card" style="height: auto !important; min-height: auto !important; max-height: fit-content !important; flex: none !important; display: block !important;">
        <div class="recipe-card-header bg-success text-white" style="padding: 0.5rem 1rem !important; height: auto !important; min-height: auto !important;">
          <h4 class="recipe-card-title">
            <i class="fas fa-shopping-cart me-2"></i>Ingredients
          </h4>
        </div>
        <div class="recipe-card-body" style="padding: 0.3rem 1rem 0.4rem 1rem !important; height: auto !important; min-height: auto !important;">
          <div class="ingredients-list" style="margin: 0 !important; padding: 0 !important; height: auto !important;">
            {% set ingredients_lines = recipe.ingredients.split('\n') %}
            {% for ingredient in ingredients_lines %}
            {% if ingredient.strip() %}
            <div class="ingredient-item d-flex align-items-center" style="padding: 0.1rem 0 !important; margin: 0 !important; height: auto !important; min-height: auto !important;">
              <input type="checkbox" class="form-check-input me-3" id="ingredient-{{ loop.index }}">
              <label class="form-check-label flex-grow-1" for="ingredient-{{ loop.index }}">
                {{ ingredient.strip() }}
              </label>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Method Section -->
      <div class="recipe-card">
        <div class="recipe-card-header bg-primary text-white">
          <h4 class="recipe-card-title">
            <i class="fas fa-list-ol me-2"></i>Instructions
          </h4>
        </div>
        <div class="recipe-card-body">
          <div class="method-steps">
            {% if recipe.method %}
              {# Split by lines to create numbered steps #}
              {% set method_lines = recipe.method.split('\n') %}
              {% set ns = namespace(step_counter=0) %}
              {% for line in method_lines %}
                {% if line.strip() %}
                  {% set ns.step_counter = ns.step_counter + 1 %}
                  <div class="step-item d-flex">
                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                         style="width: 28px; height: 28px; min-width: 28px; flex-shrink: 0; font-size: 13px;">
                      {{ ns.step_counter }}
                    </div>
                    <div class="step-content" style="flex: 1; display: block; padding: 0; margin: 0;">
                      <p class="mb-0" style="margin: 0; font-size: 14px; word-wrap: break-word;">{{ line.strip() }}</p>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                <p class="text-muted">No instructions available for this recipe.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Recipe Meta -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-2">
                <img src="{{ recipe.user.get_profile_image_url() }}" 
                     alt="{{ recipe.user.get_display_name_or_username() }}" 
                     class="rounded-circle me-2" 
                     style="width: 40px; height: 40px; object-fit: cover;">
                <div>
                  <div class="fw-medium">{{ recipe.user.get_display_name_or_username() }}</div>
                  <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    {% if recipe.created_at %}
                        {{ recipe.created_at.strftime('%B %d, %Y') }}
                    {% else %}
                        Recently added
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Recipes
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Meal Plan Modal -->
{% if current_user.is_authenticated %}
<div class="modal fade" id="mealPlanModal" tabindex="-1" aria-labelledby="mealPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mealPlanModalLabel">Add to Meal Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="mealPlanForm">
          <div class="mb-3">
            <label for="mealPlanSelect" class="form-label">Select Meal Plan</label>
            <select class="form-select" id="mealPlanSelect" name="meal_plan_id" required>
              <option value="">Choose a meal plan...</option>
              <!-- Will be populated by JavaScript -->
            </select>
            <div class="form-text">
              <a href="{{ url_for('meal_planning.meal_planner') }}" target="_blank">
                <i class="fas fa-plus me-1"></i>Create new meal plan
              </a>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="daySelect" class="form-label">Day of Week</label>
            <select class="form-select" id="daySelect" name="day" required>
              <option value="0">Monday</option>
              <option value="1">Tuesday</option>
              <option value="2">Wednesday</option>
              <option value="3">Thursday</option>
              <option value="4">Friday</option>
              <option value="5">Saturday</option>
              <option value="6">Sunday</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="mealTypeSelect" class="form-label">Meal Type</label>
            <select class="form-select" id="mealTypeSelect" name="meal_type" required>
              <option value="breakfast">
                <i class="fas fa-sun"></i> Breakfast
              </option>
              <option value="lunch">
                <i class="fas fa-sun"></i> Lunch
              </option>
              <option value="dinner">
                <i class="fas fa-moon"></i> Dinner
              </option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="servingsInput" class="form-label">Servings</label>
            <input type="number" class="form-control" id="servingsInput" name="servings" 
                   value="{{ recipe.servings or 1 }}" min="1" max="20" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="addToMealPlan">
          <i class="fas fa-calendar-plus me-1"></i>Add to Meal Plan
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Rating Modal -->
{% if current_user.is_authenticated %}
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalLabel">Rate This Recipe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="ratingForm">
          <div class="mb-3 text-center">
            <div class="star-rating-input">
              {% for i in range(5, 0, -1) %}
              <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" class="d-none">
              <label for="star{{ i }}" class="star-label">
                <i class="fas fa-star"></i>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">Comment (optional)</label>
            <textarea class="form-control" id="comment" name="comment" rows="3" 
                      placeholder="Share your thoughts about this recipe..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitRating">Submit Rating</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Expose server-rendered ids safely to JS
    const RECIPE_ID = JSON.parse('{{ recipe.id|tojson|safe }}');
    // Load meal plans when modal is opened
    const mealPlanModal = document.getElementById('mealPlanModal');
    if (mealPlanModal) {
        mealPlanModal.addEventListener('show.bs.modal', function() {
            loadMealPlans();
        });
    }
    
    // Favorite button functionality
    const favoriteBtn = document.getElementById('favoriteBtn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
            const recipeId = this.dataset.recipeId;
            const isFavorite = this.dataset.isFavorite === 'true';
            
            fetch(`/toggle_favorite/${recipeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const icon = this.querySelector('i');
                    const label = this.closest('.action-icon-wrapper').querySelector('.action-label');
                    const countElement = document.getElementById('favoriteCount');
                    
                    if (data.is_favorite) {
                        icon.className = 'fas fa-heart';
                        label.innerHTML = `Favorited<div class="action-count"><span id="favoriteCount">${data.total_favorites}</span> total</div>`;
                        this.dataset.isFavorite = 'true';
                        this.classList.add('favorited');
                    } else {
                        icon.className = 'fas fa-heart-o';
                        label.innerHTML = `Favorite<div class="action-count"><span id="favoriteCount">${data.total_favorites}</span> total</div>`;
                        this.dataset.isFavorite = 'false';
                        this.classList.remove('favorited');
                    }
                    
                    // Show success message
                    showNotification(data.message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to toggle favorite');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update favorite status. Please try again.');
            });
        });
    }
    
    // Rating submission functionality
    const submitRating = document.getElementById('submitRating');
    if (submitRating) {
        submitRating.addEventListener('click', function() {
            const rating = document.querySelector('input[name="rating"]:checked');
            const comment = document.getElementById('comment').value;
            
            if (!rating) {
                alert('Please select a rating');
                return;
            }
            
            // Disable submit button
            submitRating.disabled = true;
            submitRating.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
            
            // Submit rating to backend
            fetch(`/recipe/{{ recipe.id }}/rate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    rating: parseInt(rating.value),
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                    modal.hide();
                    
                    // Update the rating display
                    updateRatingDisplay(data.average_rating, data.rating_count);
                    
                    // Show success message
                    showNotification(data.message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to submit rating');
                }
            })
            .catch(error => {
                console.error('Error submitting rating:', error);
                alert('Failed to submit rating. Please try again.');
            })
            .finally(() => {
                submitRating.disabled = false;
                submitRating.innerHTML = 'Submit Rating';
            });
        });
    }
    
    // Attach shopping list button handler
    const addToShoppingListBtn = document.getElementById('addToShoppingListBtn');
    if (addToShoppingListBtn) {
        addToShoppingListBtn.addEventListener('click', function() {
            addToShoppingList(RECIPE_ID);
        });
    }
    
    // Load user's existing rating if any
    loadUserRating();
    
    // Star rating interaction
    const starLabels = document.querySelectorAll('.star-label');
    starLabels.forEach(label => {
        label.addEventListener('click', updateStarHighlight);
        label.addEventListener('mouseover', function() {
            highlightStars(this.getAttribute('for').replace('star', ''));
        });
    });
    
    // Reset highlighting on mouse leave
    const starContainer = document.querySelector('.star-rating-input');
    if (starContainer) {
        starContainer.addEventListener('mouseleave', updateStarHighlight);
    }
    
    // Meal plan submission
    const addToMealPlanBtn = document.getElementById('addToMealPlan');
    if (addToMealPlanBtn) {
        addToMealPlanBtn.addEventListener('click', function() {
            const form = document.getElementById('mealPlanForm');
            const formData = new FormData(form);
            
            const mealData = {
                recipe_id: RECIPE_ID,
                meal_plan_id: formData.get('meal_plan_id'),
                day: parseInt(formData.get('day')),
                meal_type: formData.get('meal_type'),
                servings: parseInt(formData.get('servings'))
            };
            
            // Validate form
            if (!mealData.meal_plan_id) {
                showNotification('Please select a meal plan', 'error');
                return;
            }
            
            // Show loading state
            addToMealPlanBtn.disabled = true;
            addToMealPlanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
            
            fetch('/meal-plan/drag-drop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(mealData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Recipe added to meal plan successfully!', 'success');
                    const modal = bootstrap.Modal.getInstance(mealPlanModal);
                    modal.hide();
                } else {
                    showNotification(data.error || 'Failed to add recipe to meal plan', 'error');
                }
            })
            .catch(error => {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                addToMealPlanBtn.disabled = false;
                addToMealPlanBtn.innerHTML = '<i class="fas fa-calendar-plus me-1"></i>Add to Meal Plan';
            });
        });
    }
    
    // Load user's existing rating if any
    loadUserRating();
});

function updateRatingDisplay(averageRating, ratingCount) {
    // Update the star display
    const starRating = document.querySelector('.star-rating');
    if (starRating) {
        const stars = starRating.querySelectorAll('i');
        stars.forEach((star, index) => {
            if (index < averageRating) {
                star.className = 'fas fa-star text-warning';
            } else {
                star.className = 'fas fa-star text-muted';
            }
        });
    }
    
    // Update rating text
    const ratingText = document.querySelector('.fw-bold');
    if (ratingText && ratingText.textContent.includes('/5')) {
        ratingText.textContent = `${averageRating}/5`;
    }
    
    // Update count
    const countText = document.querySelector('.text-muted');
    if (countText && countText.textContent.includes('review')) {
        countText.textContent = `(${ratingCount} review${ratingCount !== 1 ? 's' : ''})`;
    }
}

function loadUserRating() {
    // Check if user has already rated this recipe
    fetch(`/recipe/{{ recipe.id }}/user-rating`)
        .then(response => response.json())
        .then(data => {
            if (data.user_rating) {
                // Pre-select the user's rating
                const ratingInput = document.querySelector(`input[name="rating"][value="${data.user_rating.rating}"]`);
                if (ratingInput) {
                    ratingInput.checked = true;
                    updateStarHighlight();
                }
                
                // Pre-fill comment
                const commentField = document.getElementById('comment');
                if (commentField && data.user_rating.comment) {
                    commentField.value = data.user_rating.comment;
                }
                
                // Update button text
                const submitButton = document.getElementById('submitRating');
                if (submitButton) {
                    submitButton.textContent = 'Update Rating';
                }
            }
        })
        .catch(error => console.error('Error loading user rating:', error));
}

// Star rating interaction
document.addEventListener('DOMContentLoaded', function() {
    const starLabels = document.querySelectorAll('.star-label');
    starLabels.forEach(label => {
        label.addEventListener('click', updateStarHighlight);
        label.addEventListener('mouseover', function() {
            highlightStars(this.getAttribute('for').replace('star', ''));
        });
    });
    
    // Reset highlighting on mouse leave
    const starContainer = document.querySelector('.star-rating-input');
    if (starContainer) {
        starContainer.addEventListener('mouseleave', updateStarHighlight);
    }
});

function updateStarHighlight() {
    const checkedRating = document.querySelector('input[name="rating"]:checked');
    const rating = checkedRating ? checkedRating.value : 0;
    highlightStars(rating);
}

function highlightStars(rating) {
    const stars = document.querySelectorAll('.star-label i');
    stars.forEach((star, index) => {
        const starValue = 5 - index; // Stars are in reverse order
        if (starValue <= rating) {
            star.className = 'fas fa-star text-warning';
        } else {
            star.className = 'fas fa-star text-muted';
        }
    });
};

function loadMealPlans() {
    const select = document.getElementById('mealPlanSelect');
    select.innerHTML = '<option value="">Loading...</option>';
    
    fetch('/meal-plan/list')
    .then(response => response.json())
    .then(data => {
        select.innerHTML = '<option value="">Choose a meal plan...</option>';
        
        if (data.meal_plans && data.meal_plans.length > 0) {
            data.meal_plans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.name} (${plan.start_date} - ${plan.end_date})`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No meal plans found</option>';
        }
    })
    .catch(error => {
        console.error('Error loading meal plans:', error);
        select.innerHTML = '<option value="">Error loading meal plans</option>';
    });
}

function addToShoppingList(recipeId) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
    
    fetch('/shopping-list/add-recipe', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            recipe_id: recipeId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const weekInfo = data.week_label ? ` (${data.week_label})` : '';
            showNotification(`${data.message}${weekInfo}`, 'success');
        } else {
            showNotification(data.error || 'Failed to add to shopping list', 'error');
        }
    })
    .catch(error => {
        showNotification('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Force compact ingredients card styling
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsCard = document.querySelector('.ingredients-card');
    if (ingredientsCard) {
        // Force compact styling with JavaScript
        ingredientsCard.style.height = 'auto';
        ingredientsCard.style.minHeight = 'auto';
        ingredientsCard.style.maxHeight = 'none';
        
        const cardBody = ingredientsCard.querySelector('.recipe-card-body');
        if (cardBody) {
            cardBody.style.padding = '0.2rem 1rem 0.3rem 1rem';
            cardBody.style.height = 'auto';
            cardBody.style.minHeight = 'auto';
        }
        
        const cardHeader = ingredientsCard.querySelector('.recipe-card-header');
        if (cardHeader) {
            cardHeader.style.padding = '0.5rem 1rem';
            cardHeader.style.height = 'auto';
            cardHeader.style.minHeight = 'auto';
        }
        
        const ingredientItems = ingredientsCard.querySelectorAll('.ingredient-item');
        ingredientItems.forEach((item, index) => {
            item.style.padding = '0.15rem 0';
            item.style.margin = '0';
            item.style.marginBottom = '0';
            item.style.height = 'auto';
            item.style.minHeight = 'auto';
            
            if (index === ingredientItems.length - 1) {
                item.style.paddingBottom = '0';
            }
        });
        
        console.log('Forced compact ingredients card styling');
    }
});

// Rating system helper functions
function updateRatingDisplay(averageRating, ratingCount) {
    // Update the star display
    const starRating = document.querySelector('.star-rating');
    if (starRating) {
        const stars = starRating.querySelectorAll('i');
        stars.forEach((star, index) => {
            if (index < averageRating) {
                star.className = 'fas fa-star text-warning';
            } else {
                star.className = 'fas fa-star text-muted';
            }
        });
    }
    
    // Update rating text
    const ratingText = document.querySelector('.fw-bold');
    if (ratingText && ratingText.textContent.includes('/5')) {
        ratingText.textContent = `${averageRating}/5`;
    }
    
    // Update count
    const countText = document.querySelector('.text-muted');
    if (countText && countText.textContent.includes('review')) {
        countText.textContent = `(${ratingCount} review${ratingCount !== 1 ? 's' : ''})`;
    }
}

function loadUserRating() {
    // Check if user has already rated this recipe
    fetch(`/recipe/{{ recipe.id }}/user-rating`)
        .then(response => response.json())
        .then(data => {
            if (data.user_rating) {
                // Pre-select the user's rating
                const ratingInput = document.querySelector(`input[name="rating"][value="${data.user_rating.rating}"]`);
                if (ratingInput) {
                    ratingInput.checked = true;
                    updateStarHighlight();
                }
                
                // Pre-fill comment
                const commentField = document.getElementById('comment');
                if (commentField && data.user_rating.comment) {
                    commentField.value = data.user_rating.comment;
                }
                
                // Update button text
                const submitButton = document.getElementById('submitRating');
                if (submitButton) {
                    submitButton.textContent = 'Update Rating';
                }
            }
        })
        .catch(error => console.error('Error loading user rating:', error));
}
</script>
{% endblock %}